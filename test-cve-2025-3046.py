#!/usr/bin/env python3
"""
Test script for CVE-2025-3046 template validation
This script validates the vulnerability detection logic without requiring nuclei
"""

import os
import tempfile
import shutil
from pathlib import Path

def check_llamaindex_version():
    """Check if llama_index version is vulnerable"""
    try:
        import llama_index
        # Try different ways to get version
        version = getattr(llama_index, '__version__', None)
        if version is None:
            # Try importing from llama_index.core
            from llama_index.core import __version__ as core_version
            version = core_version

        version_parts = version.split('.')
        major = int(version_parts[0])
        minor = int(version_parts[1])
        patch = int(version_parts[2])

        # Check if version is between 0.12.23 and 0.12.28 inclusive
        if major == 0 and minor == 12 and 23 <= patch <= 28:
            return True, version
        return False, version
    except ImportError:
        return False, "not_installed"
    except Exception as e:
        return False, f"error: {str(e)}"

def test_path_traversal():
    """Test the path traversal vulnerability"""
    try:
        from llama_index.readers.obsidian import ObsidianReader

        # Create temporary directory structure
        with tempfile.TemporaryDirectory() as temp_dir:
            temp_path = Path(temp_dir)

            # Create obsidian vault directory
            vault_dir = temp_path / "obsidian_vault"
            vault_dir.mkdir()

            # Create a test file in the vault
            test_file = vault_dir / "test.md"
            test_file.write_text("# Test Content")

            # Create a symlink pointing outside the vault (path traversal)
            symlink_file = vault_dir / "evil_link.md"
            # Point to a file outside the vault
            target_file = temp_path / "outside_file.txt"
            target_file.write_text("This file is outside the vault and should not be accessible")

            try:
                os.symlink(str(target_file), symlink_file)
            except OSError:
                return False, "cannot_create_symlink"

            # Try to load the obsidian vault
            try:
                reader = ObsidianReader(str(vault_dir))
                documents = reader.load_data()

                # Check if any document contains content from outside the vault
                for doc in documents:
                    content = doc.text_content or ""
                    if "This file is outside the vault" in content:
                        return True, "vulnerable_path_traversal_detected"
            except Exception as e:
                return False, f"reader_error: {str(e)}"

    except ImportError:
        return False, "obsidian_reader_not_available"
    except Exception as e:
        return False, f"unexpected_error: {str(e)}"

    return False, "no_vulnerability_detected"

def main():
    print("Testing CVE-2025-3046 vulnerability detection...")
    print("=" * 50)

    # First check version
    vulnerable_version, version_info = check_llamaindex_version()
    print(f"Version check: {version_info}")

    if not vulnerable_version:
        if version_info == "not_installed":
            print("❌ llama_index not installed")
        else:
            print(f"❌ Version {version_info} is not vulnerable")
        return

    print(f"✅ Vulnerable version detected: {version_info}")

    # Version is vulnerable, test the path traversal
    print("\nTesting path traversal vulnerability...")
    vulnerable, result = test_path_traversal()

    if vulnerable:
        print(f"✅ VULNERABILITY DETECTED: {result}")
        print("The ObsidianReader improperly resolves symlinks, allowing path traversal!")
    else:
        print(f"❌ No vulnerability detected: {result}")

if __name__ == "__main__":
    main()
