id: CVE-2019-5591

info:
  name: FortiOS - LDAP Server Impersonation Man-in-the-Middle
  author: Rukhnuddin786
  severity: medium
  description: |
    A default configuration vulnerability in FortiOS allows an unauthenticated attacker on the same subnet to intercept sensitive information by impersonating the LDAP server. The vulnerability exists because FortiOS does not verify LDAP server identity by default in versions prior to 6.2.1, or when upgraded from vulnerable versions without explicitly enabling server-identity-check.
  impact: |
    An attacker on the same subnet can perform Man-in-the-Middle attacks to intercept LDAP authentication traffic, potentially capturing credentials and other sensitive information. This vulnerability has been actively exploited by Iranian threat actors in ransomware campaigns.
  remediation: |
    Enable LDAP server identity checking by running:
    config user ldap
    edit <ldap-server>
    set ca-cert <ldap-server-certificate>
    set secure ldaps
    set server-identity-check enable
    end
  reference:
    - https://www.fortiguard.com/psirt/FG-IR-19-037
    - https://www.tenable.com/blog/frequently-asked-questions-about-iranian-cyber-operations
    - https://www.hhs.gov/sites/default/files/iranian-threat-actors-and-healthcare.pdf
    - https://cert-in.org.in/PDF/RANSOMWARE_Report_2022.pdf
    - https://www.ic3.gov/media/news/2021/210527.pdf
    - https://nvd.nist.gov/vuln/detail/CVE-2019-5591
  classification:
    cvss-metrics: CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    cvss-score: 6.5
    cve-id: CVE-2019-5591
    cwe-id: CWE-306
    epss-score: 0.02564
    epss-percentile: 0.84995
    cpe: cpe:2.3:o:fortinet:fortios:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: fortinet
    product: fortios
    publicwww-query: "/remote/login"
    shodan-query:
      - cpe:"cpe:2.3:o:fortinet:fortios"
      - http.favicon.hash:945408572
      - port:10443 http.favicon.hash:945408572
      - http.html:"/remote/login" "xxxxxxxx"
    fofa-query:
      - body="/remote/login" "xxxxxxxx"
      - icon_hash=945408572
    google-query: intitle:"FortiGate"
  tags: cve,cve2019,fortios,fortinet,ldap,mitm,kev,passive,config

http:
  - raw:
      - |
        GET /api/v2/monitor/system/firmware HTTP/1.1
        Host: {{Hostname}}
        Accept: application/json
      - |
        GET /api/v2/cmdb/user/ldap HTTP/1.1
        Host: {{Hostname}}
        Accept: application/json

    host-redirects: true
    max-redirects: 2

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "FortiOS"
          - "version"
        condition: and

      - type: word
        part: body_2
        words:
          - "ldap"
          - "server"
        condition: and

      - type: regex
        part: body_1
        regex:
          - '"version":"(6\.0\.[0-3]|5\.6\.[3-7]|5\.4\.(6|7|8|9|10|11|12))"'
          - '"version":"6\.2\.0"'
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        name: fortios_version
        part: body_1
        group: 1
        regex:
          - '"version":"([0-9]+\.[0-9]+\.[0-9]+)"'

      - type: regex
        name: ldap_server
        part: body_2
        group: 1
        regex:
          - '"name":"([^"]+)"'
