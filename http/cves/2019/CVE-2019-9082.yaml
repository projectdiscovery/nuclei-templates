id: CVE-2019-9082

info:
  name: ThinkPHP < 3.2.4 - Remote Command Injection
  author: solari
  severity: critical
  description: |
    ThinkPHP versions before 3.2.4 contain a remote command execution vulnerability
    caused by inadequately sanitized URL parameters. Attackers can execute arbitrary
    system commands by sending specially crafted requests to vulnerable endpoints
    using the \think\app controller invocation pattern with call_user_func_array.
  impact: |
    Unauthenticated remote attackers can execute arbitrary system commands, deploy
    malware (Mirai, Lucifer, cryptocurrency miners), and fully compromise the server.
    Over 50,000 exploitation attempts detected daily in the wild.
  remediation: |
    Update ThinkPHP to version 3.2.4 or later. Implement input validation and
    sanitization for URL parameters. Disable dangerous PHP functions if possible.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2019-9082
    - https://threatprotect.qualys.com/2020/04/24/thinkphp-remote-code-execution-vulnerabilitycve-2018-20062cve-2019-9082/
    - https://www.exploit-db.com/exploits/46488
    - https://fortiguard.fortinet.com/threat-signal-report/5142
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2019-9082
    cwe-id: CWE-78
  metadata:
    max-request: 4
    vendor: thinkphp
    product: thinkphp
    shodan-query: 'cpe:2.3:a:thinkphp:thinkphp'
    verified: true
  tags: cve,cve2019,thinkphp,rce,injection,kev

http:
  - method: GET
    path:
      - "{{BaseURL}}/public/"
      - "{{BaseURL}}/index.php"
      - "{{BaseURL}}/ThinkPHP/"
      - "{{BaseURL}}/application/config.php"

    host-redirects: true
    max-redirects: 2

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 403
          - 500

      - type: word
        part: body
        words:
          - "ThinkPHP"
          - "think\app"
          - "thinkphp"
          - "topthink"
        condition: or
        case-insensitive: true

      - type: word
        part: header
        words:
          - "thinkphp"
          - "X-Powered-By: ThinkPHP"
        condition: or
        case-insensitive: true

    extractors:
      - type: regex
        part: body
        group: 1
        regex:
          - 'ThinkPHP[/\s]+V([0-9.]+)'
          - 'Version:\s*([0-9.]+)'
          - 'thinkphp/([0-9.]+)'

# Additional Notes:
# - This template detects ThinkPHP presence non-exploitatively
# - Does not execute commands or trigger RCE
# - Vulnerable versions: < 3.2.4 (also affects 5.x < 5.0.24)
# - Related CVE: CVE-2018-20062
# - CISA KEV - added 2021
# - Exploit endpoint: /index.php?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=cmd
# - Active exploitation: 50,000+ attacks/day
# - Used to deploy Mirai, Lucifer malware and crypto miners
# - Exploit-DB: #46488
