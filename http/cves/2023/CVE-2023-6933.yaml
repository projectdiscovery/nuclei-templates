id: CVE-2023-6933-bsr-php-object-injection

info:
  name: Better Search Replace <= 1.4.4 - PHP Object Injection (CVE-2023-6933)
  author: Trex
  severity: critical
  description: |
    Better Search Replace plugin versions 1.4.4 and below for WordPress are vulnerable to PHP Object Injection.
    This vulnerability allows unauthenticated attackers to inject arbitrary PHP objects,
    leading to potential remote code execution, data deletion, and arbitrary file reads.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2023-6933
    - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-6933
    - https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/better-search-replace/better-search-replace-144-php-object-injection
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-6933
    cwe-id: CWE-502
  metadata:
    verified: true
    max-request: 50
  tags: cve,cve2023,wordpress,plugin,object-injection,rce,critical

http:
  - method: GET
    path:
      # Standard wp-content paths - README variations
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/readme.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/Readme.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/ReadMe.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/README.md"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/readme.md"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/Readme.md"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/ReadMe.md"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/"
      
      # Alternative plugin main files
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/better-search-replace.php"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/includes/class-bsr-db.php"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/changelog.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/CHANGELOG.md"
      
      # Custom wp-content directory names
      - "{{BaseURL}}/content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/wp-content-custom/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/assets/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/wp/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/wordpress/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/blog/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/site/wp-content/plugins/better-search-replace/README.txt"
      
      # WordPress API endpoints for plugin detection
      - "{{BaseURL}}/wp-json/wp/v2/plugins"
      - "{{BaseURL}}/wp-admin/plugins.php"
      - "{{BaseURL}}/?rest_route=/wp/v2/plugins"
      
      # Alternative README locations
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/docs/README.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/documentation.txt"
      
      # Version-specific paths
      - "{{BaseURL}}/wp-content/plugins/better-search-replace-1.4.4/"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace-master/"
      
      # Directory traversal attempts (in case of misconfigurations)
      - "{{BaseURL}}/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/wp-plugins/better-search-replace/README.txt"
      
      # Backup/old files that might exist
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/README.txt.bak"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/README.old"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/readme_backup.txt"
      
      # Plugin variations or renamed directories
      - "{{BaseURL}}/wp-content/plugins/bsr/README.txt"
      - "{{BaseURL}}/wp-content/plugins/search-replace/README.txt"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace-pro/README.txt"
      
      # Must-use plugins directory
      - "{{BaseURL}}/wp-content/mu-plugins/better-search-replace/README.txt"
      
      # Symlinked or alternative installations
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/readme.htm"
      - "{{BaseURL}}/wp-content/plugins/better-search-replace/README.html"
      
      # WordPress subdirectory installations
      - "{{BaseURL}}/wp/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/wordpress/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/blog/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/site/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/cms/wp-content/plugins/better-search-replace/README.txt"
      
      # Language-specific installations
      - "{{BaseURL}}/en/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/de/wp-content/plugins/better-search-replace/README.txt"
      - "{{BaseURL}}/fr/wp-content/plugins/better-search-replace/README.txt"

    matchers-condition: or
    matchers:
      # Primary detection: README file with version check
      - type: dsl
        name: vulnerable_readme_detection
        dsl:
          - 'contains(body, "Better Search Replace") && contains(body, "wpengine") && status_code == 200'
          - 'contains(body, "Stable tag: trunk") && status_code == 200'
          - 'regex("(?i)version:?\\s*(1\\.[0-4]\\.[0-9]+|0\\.[0-9]+\\.[0-9]+)", body) && contains(body, "Better Search Replace") && status_code == 200'
        condition: or

      # Plugin main file detection
      - type: dsl
        name: main_plugin_file_detection  
        dsl:
          - 'contains(body, "Plugin Name: Better Search Replace") && contains(body, "Version: 1.") && status_code == 200'
          - 'contains(body, "better-search-replace.php") && contains(body, "wpengine") && status_code == 200'
        condition: or

      # Vulnerable class file detection
      - type: dsl
        name: vulnerable_class_detection
        dsl:
          - 'contains(body, "class-bsr-db.php") && contains(body, "unserialize") && status_code == 200'
          - 'contains(body, "BSR_DB") && contains(body, "unserialize") && status_code == 200'
        condition: or

      # WordPress API plugin enumeration
      - type: dsl
        name: wp_api_detection
        dsl:
          - 'contains(body, "better-search-replace") && contains(body, "\"version\"") && status_code == 200'
          - 'contains(body, "\"name\":\"Better Search Replace\"") && status_code == 200'
        condition: or

      # Directory listing detection
      - type: dsl
        name: directory_listing_detection
        dsl:
          - 'contains(body, "better-search-replace.php") && contains(body, "class-bsr-db.php") && status_code == 200'
          - 'contains(body, "Index of") && contains(body, "better-search-replace") && status_code == 200'
        condition: or

      # Changelog or documentation detection
      - type: dsl
        name: changelog_detection
        dsl:
          - 'contains(body, "CHANGELOG") && contains(body, "1.4.4") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "changelog.txt") && contains(body, "Search Replace") && status_code == 200'
        condition: or

      # Backup file detection
      - type: dsl
        name: backup_file_detection
        dsl:
          - 'contains(body, "Better Search Replace") && (contains(body, ".bak") || contains(body, ".old") || contains(body, "backup")) && status_code == 200'
        condition: or

      # Version-specific vulnerable detection
      - type: dsl
        name: version_specific_detection
        dsl:
          - 'regex("(?i)(version:?\\s*1\\.[0-4]\\.[0-9]+)|(stable\\s*tag:\\s*1\\.[0-4]\\.[0-9]+)", body) && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.4.4") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.4.3") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.4.2") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.4.1") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.4.0") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.3.") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.2.") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.1.") && contains(body, "Better Search Replace") && status_code == 200'
          - 'contains(body, "1.0.") && contains(body, "Better Search Replace") && status_code == 200'
        condition: or

    extractors:
      - type: regex
        name: plugin_version
        part: body
        group: 1
        regex:
          - "(?i)Version:\\s*([0-9.]+)"
          - "(?i)Stable tag:\\s*([0-9.]+)"
          - "(?i)= ([0-9.]+) -"

      - type: regex
        name: plugin_path
        part: body
        group: 1
        regex:
          - "(wp-content/[^/]+/plugins/better-search-replace)"
          - "(content/plugins/better-search-replace)"
          - "(assets/plugins/better-search-replace)"

      - type: regex
        name: vulnerability_indicators
        part: body
        group: 1
        regex:
          - "(unserialize\\([^)]+\\))"
          - "(class-bsr-db\\.php)"
          - "(PHP Object Injection)"