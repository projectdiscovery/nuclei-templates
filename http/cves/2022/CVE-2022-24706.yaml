id: CVE-2022-24706

info:
  name: Apache CouchDB - Remote Privilege Escalation
  author: relentless-robotics
  severity: critical
  description: |
    In Apache CouchDB prior to 3.2.2, an attacker can access an improperly secured default installation without authenticating and gain admin privileges. The vulnerability stems from CouchDB accepting a default Erlang cookie value "monster" that authenticates inter-node communication, combined with network exposure of the distribution port.
  impact: |
    Attackers can gain unauthorized administrative access to CouchDB instances, enabling full control over the database including reading, modifying, or deleting data. This vulnerability has been actively exploited in the wild for cryptocurrency mining malware deployment.
  remediation: |
    Upgrade to Apache CouchDB version 3.2.2 or later. Implement firewall rules to restrict access to CouchDB ports (only port 5984 needs external exposure for single-node installations). All binary packages have been updated to bind epmd and distribution ports to localhost only.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2022-24706
    - https://docs.couchdb.org/en/stable/cve/2022-24706.html
    - https://www.cisa.gov/known-exploited-vulnerabilities-catalog
    - http://packetstormsecurity.com/files/167032/Apache-CouchDB-3.2.1-Remote-Code-Execution.html
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-24706
    cwe-id: CWE-1188
    epss-score: 0.97512
    epss-percentile: 0.99963
    cpe: cpe:2.3:a:apache:couchdb:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: apache
    product: couchdb
    shodan-query: "product:\"CouchDB\" port:5984"
    fofa-query: "app=\"Apache-CouchDB\""
  tags: cve,cve2022,apache,couchdb,auth-bypass,privesc,kev

http:
  - method: GET
    path:
      - "{{BaseURL}}/_session"
      - "{{BaseURL}}/"

    stop-at-first-match: true

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - '"couchdb"'
          - '"version"'
        condition: and

      - type: word
        part: header
        words:
          - "application/json"

      - type: status
        status:
          - 200

      - type: regex
        part: body
        regex:
          - '"version":"([0-2]\.[0-9]+\.[0-9]+)"'
          - '"version":"(3\.[0-1]\.[0-9]+)"'
          - '"version":"(3\.2\.[0-1])"'

    extractors:
      - type: regex
        name: version
        group: 1
        regex:
          - '"version":"([0-9.]+)"'

      - type: dsl
        dsl:
          - 'contains(body, "\"couchdb\":\"Welcome\"") || contains(body, "\"ok\":true")'
