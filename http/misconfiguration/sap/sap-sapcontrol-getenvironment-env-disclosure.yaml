id: sap-sapcontrol-getenvironment-env-disclosure

info:
  name: SAPControl - Unauthenticated GetEnvironment Information Disclosure
  author: LRVT <https://github.com/l4rm4nd>
  severity: medium
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP web service exposes the GetEnvironment web method without
    authentication.

    GetEnvironment returns the full list of environment variables of the SAP
    instance process. If the SOAP endpoint is reachable without credentials,
    a remote attacker can obtain OS level and SAP specific variables, such as
    user and host information (HOME, USER, LOGNAME, HOSTNAME), SAP kernel and
    profile paths (SAPSYSTEMNAME, SAPEXE, DIR_LIBRARY, LD_LIBRARY_PATH),
    secure store and crypto configuration (RSEC_SSFS_DATAPATH,
    RSEC_SSFS_KEYPATH, SNC_LIB, SECUDIR), as well as database related
    settings (DB_SID, dbms_type, ORACLE_SID, TNS_ADMIN, SAPDATA_HOME, etc).

    These values reveal internal hostnames, filesystem layout, SIDs and
    instance structure and may expose credentials, keys or other sensitive
    configuration details. This significantly supports reconnaissance and can
    assist in privilege escalation and lateral movement against the SAP
    application and its underlying database or operating system when chained
    with other vulnerabilities.
  tags: sap,sapcontrol,soap,env,exposure,info-disclosure,recon
  reference:
    - https://help.sap.com/docs/SUPPORT_CONTENT/si/3362959700.html
    - https://itsiti.com/csmon/
    - https://docs.avantra.com/api/latest/js/sap-control.html

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:GetEnvironment xmlns:ns1="urn:SAPControl"/>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "GetEnvironmentResponse"

      - type: word
        part: body
        words:
          - "HOME=/home/"
          - "LOGNAME="
          - "USER="
        condition: or

    extractors:
      # generic useful stuff (user enumeration / host info)
      - type: regex
        part: body
        name: env_lines
        group: 1
        regex:
          - "<item>(LOGNAME=[^<]+)</item>"
          - "<item>(HOME=[^<]+)</item>"
          - "<item>(USER=[^<]+)</item>"
          - "<item>(HOSTNAME=[^<]+)</item>"
          - "<item>(HOST=[^<]+)</item>"

          # SAP / kernel paths
          - "<item>(SAPSYSTEMNAME=[^<]+)</item>"
          - "<item>(DIR_LIBRARY=[^<]+)</item>"
          - "<item>(LD_LIBRARY_PATH=[^<]+)</item>"
          - "<item>(SAPEXE=[^<]+)</item>"

          # SSFS / crypto
          - "<item>(RSEC_SSFS_DATAPATH=[^<]+)</item>"
          - "<item>(RSEC_SSFS_KEYPATH=[^<]+)</item>"
          - "<item>(SNC_LIB=[^<]+)</item>"
          - "<item>(SECUDIR=[^<]+)</item>"

          # DB / Oracle relevant
          - "<item>(DB_SID=[^<]+)</item>"
          - "<item>(dbms_type=[^<]+)</item>"
          - "<item>(dbs_ora_tnsname=[^<]+)</item>"
          - "<item>(ORACLE_SID=[^<]+)</item>"
          - "<item>(ORACLE_BASE=[^<]+)</item>"
          - "<item>(TNS_ADMIN=[^<]+)</item>"
          - "<item>(NLS_LANG=[^<]+)</item>"
          - "<item>(SAPDATA_HOME=[^<]+)</item>"

          # misc SID / alias
          - "<item>(sid=[^<]+)</item>"
          - "<item>(aliasname=[^<]+)</item>"
          - "<item>(CPU=[^<]+)</item>"
          - "<item>(MACHTYPE=[^<]+)</item>"