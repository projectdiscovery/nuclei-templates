id: sap-sapcontrol-listconfigfiles-config-enum

info:
  name: SAPControl - ListConfigFiles without authentication
  author: LRVT, l4rm4nd
  severity: medium
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP interface exposes the ListConfigFiles web method without
    authentication.

    ListConfigFiles returns the list of all profile and configuration files
    known to the instance, typically including paths under /usr/sap/<SID>/SYS/
    profile and other kernel or host agent configuration locations. When the
    SOAP endpoint is reachable anonymously, a remote attacker can enumerate
    the exact filenames and filesystem layout of SAP profiles and related
    configuration data.

    This information is highly valuable for reconnaissance: it reveals SIDs,
    instance names, hostnames, directory structures and the location of
    critical files that may later be targeted with ReadConfigFile, direct
    file access vulnerabilities or OS-level compromise. Combined with other
    unprotected sapstartsrv web methods, this can significantly reduce the
    effort required to move from information disclosure to full compromise of
    the SAP application stack.
  tags: sap,sapcontrol,soap,config,info-disclosure
  reference:
    - https://itsiti.com/csmon/        # sapcontrol webmethods incl. ListConfigFiles
    - https://cloud.ibm.com/docs/sap?topic=sap-monitoring-prereqs  # example use of ListConfigFiles in monitoring
    - https://help.sap.com/docs/SUPPORT_CONTENT/si/3362959700.html # protected vs unprotected sapstartsrv methods

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:ListConfigFiles xmlns:ns1="urn:SAPControl"/>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "ListConfigFilesResponse"

      - type: word
        part: body
        words:
          - "<configfiles>"
          - "<item>/usr/sap/"
        condition: or

    extractors:
      - type: regex
        part: body
        name: config_files
        group: 1
        regex:
          - "<configfiles>.*?</configfiles>"
      - type: regex
        part: body
        name: config_files
        group: 1
        regex:
          - "<item>([^<]+)</item>"
