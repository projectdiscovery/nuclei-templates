id: sap-sapcontrol-getversioninfo


info:
  name: SAPControl - GetVersionInfo Kernel Version Detection (unauthenticated)
  author: LRVT, l4rm4nd
  severity: info
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP interface exposes the GetVersionInfo web method without
    authentication.

    GetVersionInfo returns version metadata for core SAP instance binaries
    (for example sapstartsrv, disp+work, msg_server, gwrd, icman, sapwebdisp,
    jstart) including kernel release, patch level, changelist, build
    timestamp and platform.

    This template mirrors the Metasploit "SAP Management Console Version
    Detection" module and extracts:
      - The VersionInfo value for sapstartsrv
      - The VersionInfo value for msg_server
      - The three-letter SAP SID from typical /usr/sap/<SID>/ paths

    The result provides quick, unauthenticated fingerprinting of the SAP
    kernel stack for reconnaissance and vulnerability mapping.
  tags: sap,sapcontrol,soap,version,info-disclosure,recon
  reference:
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/sap/sap_mgmt_con_version.rb
    - https://gist.github.com/c6da760f57e062397e52400936ca5797
    - https://www.neteye-blog.com/2017/03/sap-monitoring-experiences-with-sapcontrol-and-check_sap_health/

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:GetVersionInfo xmlns:ns1="urn:SAPControl"></ns1:GetVersionInfo>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "GetVersionInfoResponse"

      - type: word
        part: body
        words:
          - "<VersionInfo>"
          - "<Filename>"
        condition: and

    extractors:
      # sapstartsrv VersionInfo
      - type: regex
        part: body
        name: sapstartsrv_version
        group: 1
        regex:
          - "<Filename>[^<]*sapstartsrv</Filename>\\s*<VersionInfo>([^<]+)</VersionInfo>"

      # msg_server VersionInfo
      - type: regex
        part: body
        name: msg_server_version
        group: 1
        regex:
          - "<Filename>[^<]*msg_server</Filename>\\s*<VersionInfo>([^<]+)</VersionInfo>"

      # SID as three letters from a /sap/<SID>/ style path
      - type: regex
        part: body
        name: sap_sid
        group: 1
        regex:
          - "[\\\\/]sap[\\\\/](\\w{3})"