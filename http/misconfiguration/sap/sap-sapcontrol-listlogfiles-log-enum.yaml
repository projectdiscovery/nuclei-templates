id: sap-sapcontrol-listlogfiles-log-enum

info:
  name: SAPControl - ListLogFiles without authentication
  author: LRVT <https://github.com/l4rm4nd>
  severity: medium
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP interface exposes the ListLogFiles web method without authentication.

    ListLogFiles returns a structured list of all instance log and trace files
    in the work directory (for example dev_disp, dev_ms, defaultTrace,
    applications_* and security_* logs) including their filenames, size and
    modification time. If the SOAP endpoint is reachable anonymously, a
    remote attacker can fully enumerate available log and trace files and map
    the file system layout of the SAP instance.

    This significantly supports reconnaissance and follow-up attacks, as the
    discovered filenames can later be accessed via other unprotected log
    reading methods such as ReadLogFile or ReadDeveloperTrace, or targeted
    through separate vulnerabilities on OS or application level. The output
    also reveals SIDs, instance numbers, hostnames and other internal
    details encoded in standard SAP log naming conventions.
  tags: sap,sapcontrol,soap,log,info-disclosure
  reference:
    - https://learning.sap.com/courses/technical-implementation-and-operation-i-of-sap-s-4hana-and-sap-business-suite/log-and-trace-information-for-system-start-and-stop
    - https://sapbasisinfo.com/blog/2017/01/20/sapcontrol-command-funtions-for-sap-hana/
    - https://itsiti.com/csmon/
    - https://www.networkintelligence.ai/blogs/sap-security-assessment-methodology-part-2-credential-less-attack-vectors/

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:ListLogFiles xmlns:ns1="urn:SAPControl"/>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "ListLogFilesResponse"

      - type: word
        part: body
        words:
          - "<file>"
          - "<filename>"
        condition: and

    extractors:
      # Collect all filenames internally (no direct CLI spam)
      - type: regex
        part: body
        name: log_files
        internal: true
        group: 1
        regex:
          - "<filename>([^<]+)</filename>"

      # Optional: pull out a few "interesting" classes of logs, still internal
      - type: regex
        part: body
        name: slog_files
        internal: true
        group: 1
        regex:
          - "<filename>(log/SLOG[^<]+)</filename>"

      - type: regex
        part: body
        name: defaulttrace_files
        internal: true
        group: 1
        regex:
          - "<filename>([^<]*defaultTrace[^<]+)</filename>"

      - type: regex
        part: body
        name: security_logs
        internal: true
        group: 1
        regex:
          - "<filename>([^<]*security_00[^<]+)</filename>"

      - type: regex
        part: body
        name: applications_logs
        internal: true
        group: 1
        regex:
          - "<filename>([^<]*applications_00[^<]+)</filename>"

      # One concise summary line in the output
      - type: dsl
        name: count
        dsl:
          - "concat('total_logs=', len(log_files))"
