id: sap-sapcontrol-abapreadsyslog-log-disclosure

info:
  name: SAPControl - ABAPReadSyslog without authentication
  author: LRVT, l4rm4nd
  severity: medium
  description: |
    Detects SAP systems where the SAPControl SOAP web service exposes the
    ABAPReadSyslog operation without authentication. ABAPReadSyslog returns
    the ABAP system log (equivalent to transaction SM21) via SAPControl /
    sapstartsrv and includes fields such as client, username, transaction
    code, message number, free-text message and severity.
    
    If the SOAP endpoint is reachable without credentials, a remote attacker
    can read recent syslog entries and gain detailed information about the
    SAP landscape like technical and dialog users, client numbers, transaction
    codes, internal hostnames, paths, system events and potentially sensitive
    business or troubleshooting data that administrators or developers logged
    in clear text. This significantly supports reconnaissance and can help
    in chaining further attacks against the SAP NetWeaver / ABAP platform.
  tags: sap,sapcontrol,soap,abap,log,info-disclosure
  reference:
    - https://my-handshake.blogspot.com/2011/03/sapcontrol-webmethods-list.html
    - https://gist.github.com/c6da760f57e062397e52400936ca5797
    - https://exchange.icinga.com/kai_ks/check_sap_hostctrl

http:
  - method: POST
    path:
      - "{{BaseURL}}"

    headers:
      Content-Type: text/xml; charset=UTF-8
      SOAPAction: '""'
      User-Agent: Mozilla/5.0

    body: |
      <?xml version="1.0" encoding="utf-8"?>
      <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
        <SOAP-ENV:Header>
          <sapsess:Session xmlns:sapsess="http://www.sap.com/webas/630/soap/features/session/">
            <enableSession>true</enableSession>
          </sapsess:Session>
        </SOAP-ENV:Header>
        <SOAP-ENV:Body>
          <ns1:ABAPReadSyslog xmlns:ns1="urn:SAPControl"></ns1:ABAPReadSyslog>
        </SOAP-ENV:Body>
      </SOAP-ENV:Envelope>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
      - type: word
        part: body
        words:
          - "ABAPReadSyslogResponse"
      - type: word
        part: body
        words:
          - "<item>"
          - "<Time>"
          - "<Text>"
        condition: and

    extractors:
      # All syslog messages (used for total count)
      - type: regex
        part: body
        name: messages
        internal: true
        group: 1
        regex:
          - "<Text>([^<]+)</Text>"

      # First non-empty user (e.g. <User>iftadm</User>)
      - type: regex
        part: body
        name: syslog_user
        internal: true
        group: 1
        regex:
          - "<User>([A-Za-z0-9_.\\-/$]{2,})</User>"

      # First 3-digit SAP client (e.g. <Client>000</Client>)
      - type: regex
        part: body
        name: syslog_client
        internal: true
        group: 1
        regex:
          - "<Client>([0-9]{3})</Client>"

      # Severity buckets
      - type: regex
        part: body
        name: sev_green
        internal: true
        group: 0
        regex:
          - "<Severity>SAPControl-GREEN</Severity>"

      - type: regex
        part: body
        name: sev_red
        internal: true
        group: 0
        regex:
          - "<Severity>SAPControl-RED</Severity>"

      # Compact, human-friendly output
      - type: dsl
        name: syslog_info
        dsl:
          - "concat('SYSLOG_TOTAL=', len(messages))"
          - "concat('SYSLOG_USER=', syslog_user)"
          - "concat('SYSLOG_CLIENT=', syslog_client)"
          - "concat('SYSLOG_SEV_GREEN=', len(sev_green))"
          - "concat('SYSLOG_SEV_RED=', len(sev_red))"