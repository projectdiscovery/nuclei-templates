const net = require('net');

const PORT = process.env.PORT || 3333;

function tryParseJSON(buf) {
  try {
    const s = buf.toString('utf8').trim();
    if (!s) return null;
    // Some clients send multiple JSON-RPC messages separated by newlines
    const parts = s.split(/\r?\n/).filter(Boolean);
    return parts.map(p => JSON.parse(p));
  } catch (e) {
    return null;
  }
}

const server = net.createServer((socket) => {
  socket.on('data', (buf) => {
    const msgs = tryParseJSON(buf);
    if (!msgs) return;
    msgs.forEach((msg) => {
      // Basic JSON-RPC handler to emulate vulnerable behavior
      const id = msg.id || null;
      const method = msg.method || '';
      if (method === 'mining.subscribe') {
        const resp = { id, result: [["extranonce1", "8"] , "legacy"], error: null };
        socket.write(JSON.stringify(resp) + '\n');
        console.log('[mock] subscribe ->', resp);
      } else if (method === 'mining.authorize') {
        const resp = { id, result: true, error: null };
        socket.write(JSON.stringify(resp) + '\n');
        console.log('[mock] authorize ->', resp);
      } else if (method === 'mining.submit') {
        // params: [user, job_id, extranonce2, ntime, nonce, solution]
        const params = Array.isArray(msg.params) ? msg.params : [];
        const solution = params[5] || '';

        // Vulnerable behavior: accept solution where solution is hex '01' repeated 512 times
        const expected = '01'.repeat(512);
        if (solution === expected) {
          const resp = { id, result: true, error: null };
          socket.write(JSON.stringify(resp) + '\n');
          console.log('[mock] accepted vulnerable forged solution ->', { id, params: 'FORGED' });
        } else {
          const resp = { id, result: false, error: [20, 'Low difficulty or invalid solution'] };
          socket.write(JSON.stringify(resp) + '\n');
          console.log('[mock] rejected solution ->', { id, params: 'NORMAL' });
        }
      } else {
        const resp = { id, result: null, error: [1, 'unknown method'] };
        socket.write(JSON.stringify(resp) + '\n');
      }
    });
  });

  socket.on('error', (err) => console.error('[mock] socket error', err));
});

server.listen(PORT, () => console.log('[mock] Z-NOMP mock vulnerable server listening on', PORT));
