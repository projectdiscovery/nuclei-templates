id: CVE-2020-0610

info:
  name: Microsoft Windows RD Gateway UDP - Remote Code Execution (BlueGate)
  author: imbios
  severity: critical
  description: |
    Detects CVE-2020-0610 in Microsoft Windows Remote Desktop Gateway (RD Gateway) by sending
    a crafted RDG UDP fragment packet derived from the BlueGate PoC. A vulnerable gateway will not return the specific error trailer
    0x8000ffff (little-endian ffff0080) observed on patched systems.
  reference:
    - https://www.kryptoslogic.com/blog/2020/01/rdp-to-rce-when-fragmentation-goes-wrong/
    - https://nvd.nist.gov/vuln/detail/CVE-2020-0610
    - https://gitlab.com/ind3p3nd3nt/BlueGate
    - https://vulncheck.com/xdb/3a3f10478ff3
  classification:
    cve-id: CVE-2020-0610
    cwe-id: CWE-787
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cpe: cpe:2.3:o:microsoft:windows_server_2012:*:*:*:*:*:*:*:*
  metadata:
    verified: false
    shodan-query: 'port:3391 product:"Remote Desktop Gateway"'
    vendor: Microsoft
    product: Windows RD Gateway
    max-request: 1
    kev: true
  tags: cve,cve2020,windows,rdg,rdp,udp,network,kev

variables:
  Port: "3391"

udp:
  - inputs:
      - data: "0500070000004100010000"
        type: hex
        read-size: 32
    host:
      - "{{Host}}"
    port: "{{Port}}"
    read-size: 32
    timeout: 5

matchers:
  - type: dsl
    dsl:
      - "len(data) > 0 && !ends_with(hex_encode(data), 'ffff0080')"
    condition: and

extractors:
  - type: dsl
    dsl:
      - "hex_encode(data)"