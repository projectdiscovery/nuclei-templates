id: dns-zone-transfer-check

info:
  name: DNS Zone Transfer Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that DNS zone transfers are restricted by ensuring that the SecureSecondaries registry value is set to 2 for all active zones.
    Unauthorized zone transfers can leak critical domain information, aiding attackers in mapping network structures.
  impact: |
    If DNS zone transfers are not properly restricted, attackers may obtain domain and zone information, which can be used to plan further attacks on network infrastructure.
  remediation: |
    Configure DNS zone transfer restrictions by:
    - Disabling zone transfers, or
    - Allowing transfers only to specific servers by setting the SecureSecondaries registry value to 2.
  tags: windows,code,windows-audit,kisa,dns,zone-transfer

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      $regPath = "HKLM:\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\DNS Server\Zones"
      $zones = Get-ChildItem -Path $regPath -ErrorAction SilentlyContinue
      if (!$zones) {
          "DNS_ZONE_TRANSFER_COMPLIANT"
          exit
      }
      $vulnerable = $false
      foreach ($zone in $zones) {
          $secureVal = (Get-ItemProperty -Path $zone.PSPath -ErrorAction SilentlyContinue).SecureSecondaries
          if ($secureVal -ne 2) {
              $vulnerable = $true
              break
          }
      }
      if ($vulnerable) {
          "DNS_ZONE_TRANSFER_VULNERABLE"
      } else {
          "DNS_ZONE_TRANSFER_COMPLIANT"
      }

    matchers:
      - type: word
        words:
          - "DNS_ZONE_TRANSFER_VULNERABLE"