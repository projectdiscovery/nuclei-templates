id: shutdown-without-logon

info:
  name: Shutdown Without Logon Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the "Shutdown Without Logon" policy is disabled by checking that the ShutdownWithoutLogon registry value is set to 0.
    When enabled, the system allows shutdown from the logon screen, which may lead to unauthorized shutdowns.
  impact: |
    If this setting is enabled, unauthorized users may shut down the system without logging in, potentially disrupting services.
  remediation: |
    Disable the policy by setting the ShutdownWithoutLogon value to 0 in the registry:
    HKLM:\Software\Microsoft\Windows\CurrentVersion\policies\system
    or configure the local security policy accordingly.
  tags: windows,code,windows-audit,kisa,registry

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      $regPath = "HKLM:\Software\Microsoft\Windows\CurrentVersion\policies\system"
      $shutdownValue = (Get-ItemProperty -Path $regPath -Name ShutdownWithoutLogon -ErrorAction SilentlyContinue).ShutdownWithoutLogon
      if ($shutdownValue -eq 0) {
          "SHUTDOWN_WITHOUT_LOGON_DISABLED"
      } else {
          "SHUTDOWN_WITHOUT_LOGON_ENABLED"
      }

    matchers:
      - type: word
        words:
          - "SHUTDOWN_WITHOUT_LOGON_ENABLED"