id: ftp-access-control-check

info:
  name: FTP Access Control Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that FTP access is restricted by applying IP address restrictions. If no IP restriction settings are configured,
    unauthorized networks may gain access to FTP services.
  impact: |
    Without proper IP-based access control, FTP services can be accessed from unauthorized networks,
    increasing the risk of data breaches and other security incidents.
  remediation: |
    Configure IP address restrictions via IIS Manager:
    - Open IIS Manager.
    - Navigate to the FTP site â†’ FTP IP Address and Domain Restrictions.
    - Add allowed IP addresses and set appropriate deny rules.
  tags: ftp,iis,security,windows,code,windows-audit,kisa

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      Import-Module WebAdministration -ErrorAction SilentlyContinue
      $ftpSites = Get-ChildItem IIS:\Sites | Where-Object { $_.Bindings.Collection.Protocol -eq "ftp" }
      $vulnerable = $false
      foreach ($site in $ftpSites) {
          $ipSecurity = Get-WebConfigurationProperty -pspath "MACHINE/WEBROOT/APPHOST/$($site.Name)" -filter "system.ftpServer/security/ipSecurity" -name "allowUnlisted" -ErrorAction SilentlyContinue
          # If allowUnlisted is true, FTP access is open to unlisted IPs (i.e., no proper IP restriction is applied)
          if ($ipSecurity -eq $true) {
              $vulnerable = $true
              break
          }
      }
      if ($vulnerable) {
          "FTP_IP_ACCESS_CONTROL_NOT_CONFIGURED"
      } else {
          "FTP_IP_ACCESS_CONTROL_CONFIGURED"
      }

    matchers:
      - type: word
        words:
          - "FTP_IP_ACCESS_CONTROL_NOT_CONFIGURED"