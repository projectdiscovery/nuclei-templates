id: ftp-anonymous-check

info:
  name: Anonymous FTP Disabled Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that anonymous FTP authentication is disabled on FTP sites. Enabling anonymous access allows unauthenticated users to connect,
    posing significant security risks.
  impact: |
    If anonymous FTP is enabled, attackers may exploit the service by bypassing authentication, potentially gaining unauthorized access
    to FTP resources.
  remediation: |
    Disable anonymous FTP authentication via IIS Manager:
    - Open IIS Manager.
    - Navigate to the FTP site â†’ FTP Authentication.
    - Ensure "Anonymous Authentication" is set to Disabled.
  tags: windows,ftp,iis,security,windows,code,windows-audit,kisa

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      Import-Module WebAdministration -ErrorAction SilentlyContinue
      $ftpSites = Get-ChildItem IIS:\Sites | Where-Object { $_.Bindings.Collection.Protocol -eq "ftp" }
      $vulnerable = $false
      foreach ($site in $ftpSites) {
          $anonAuth = Get-WebConfigurationProperty -pspath "MACHINE/WEBROOT/APPHOST/$($site.Name)" -filter "system.ftpServer/security/authentication/anonymousAuthentication" -name "enabled" -ErrorAction SilentlyContinue
          if ($anonAuth -eq $true) {
              $vulnerable = $true
              break
          }
      }
      if ($vulnerable) {
          "ANONYMOUS_FTP_ENABLED"
      } else {
          "ANONYMOUS_FTP_DISABLED"
      }

    matchers:
      - type: word
        words:
          - "ANONYMOUS_FTP_ENABLED"