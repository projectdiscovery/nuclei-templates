FROM php:7.4-apache

# Install required packages
RUN apt-get update && apt-get install -y \
    unzip \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Download vulnerable jQuery-File-Upload v9.22.0
RUN wget -q https://github.com/blueimp/jQuery-File-Upload/archive/refs/tags/v9.22.0.zip -O /tmp/jquery-file-upload.zip \
    && unzip -q /tmp/jquery-file-upload.zip -d /tmp \
    && cp -r /tmp/jQuery-File-Upload-9.22.0/* /var/www/html/ \
    && rm -rf /tmp/jquery-file-upload.zip /tmp/jQuery-File-Upload-9.22.0

# Create files directory and set permissions
RUN mkdir -p /var/www/html/server/php/files \
    && chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html \
    && chmod 777 /var/www/html/server/php/files

# Apache configuration - ensure AllowOverride None (default in Apache 2.4+)
# This simulates the vulnerable condition where .htaccess is ignored
RUN echo '<Directory /var/www/html>\n\
    Options Indexes FollowSymLinks\n\
    AllowOverride None\n\
    Require all granted\n\
</Directory>' > /etc/apache2/conf-available/override.conf \
    && a2enconf override

EXPOSE 80

CMD ["apache2-foreground"]
