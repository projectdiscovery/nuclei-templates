const express = require('express');
const app = express();

app.use(express.json());

/**
 * Enhanced Data Processor
 * This service allows users to define custom transformation logic for their data.
 * It uses the underlying JavaScript engine to execute the logic for maximum flexibility.
 */
app.post('/process-data', (req, res) => {
    const { data, transformLogic } = req.body;

    if (!transformLogic) {
        return res.status(400).send({ error: 'Missing transformation logic' });
    }

    try {
        // Execute the user-provided logic within the environment's engine context.
        // Node-ChakraCore uses the Chakra engine, which is vulnerable to CVE-2018-8298.
        const result = eval(transformLogic);
        res.send({
            status: 'success',
            processedAt: new Date().toISOString(),
            result: String(result)
        });
    } catch (e) {
        res.status(500).send({ error: `Transformation failed: ${e.message}` });
    }
});

app.get('/health', (req, res) => {
    res.send({ status: 'up', engine: 'ChakraCore' });
});

const PORT = process.env.PORT || 8080;
app.listen(PORT, '0.0.0.0', () => {
    console.log(`Data Processing Service listening on port ${PORT}`);
});
