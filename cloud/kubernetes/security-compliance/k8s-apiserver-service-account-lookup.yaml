id: k8s-apiserver-service-account-lookup

info:
  name: Detect kube-apiserver --service-account-lookup=true
  author: songyaeji
  severity: medium
  description: Detects whether kube-apiserver has --service-account-lookup=true enabled in its startup arguments.
  impact: |
    When --service-account-lookup=true is set, the API server will perform service account lookup behavior which
    can have security implications depending on cluster configuration. Review whether this behavior is required.
  remediation: |
    If not required, remove or set --service-account-lookup=false in the kube-apiserver startup flags.
    Otherwise, ensure RBAC and other controls are properly configured to mitigate exposure.
  reference:
    - https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/
    - Cloud Vulnerability Assessment Guide(2024) by KISA
  tags: cloud,devops,kubernetes,devsecops,api-server,k8s,k8s-cluster-security

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      kubectl get pods -n kube-system -l component=kube-apiserver -o jsonpath="{.items[*].spec.containers[*].command}" 2>/dev/null || \
      kubectl get pods -n kube-system -l k8s-app=kube-apiserver -o jsonpath="{.items[*].spec.containers[*].command}" 2>/dev/null || \
      kubectl get pods -n kube-system -o jsonpath="{.items[?(@.metadata.name.indexOf('kube-apiserver')>=0)].spec.containers[*].command}" 2>/dev/null || \
      echo ""
    matchers:
      - type: word
        words:
          - 'kube-apiserver'
          - '--service-account-lookup=true'
        condition: and
    extractors:
      - type: dsl
        dsl:
          - '"kube-apiserver is configured with --service-account-lookup=true. Verify whether this is required and secure."'
# digest: 4b0a00483046022100b94ab656526e3c7d75656920143bef3d23daeefa8803badab74dbbbafab27570022100eca10fd2c3edd114341322e4dcf83678a5673b61cb1e3d89efb65a01262a1225:bd4199f08311fe94da3c6b619521b96e
