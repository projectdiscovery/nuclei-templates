id: azure-apim-cross-tenant-signup-bypass

info:
  name: Azure APIM Cross-Tenant Signup Bypass
  author: Mihalis Haatainen (Bountyy Oy) - www.bountyy.fi
  severity: high
  description: |
    Detects Azure API Management Developer Portal instances where the Basic Authentication
    signup API remains active despite administrators disabling signup in the portal UI.
    
    When signup is "disabled", the UI hides the form but the underlying API endpoint
    continues to accept registration requests. This template detects active signup APIs
    by triggering captcha validation errors, proving the endpoint processes requests.
    
    Full exploitation requires solving the captcha challenge (e.g., via captcha-solving services).
  remediation: |
    1. Remove Basic Authentication identity provider completely from Azure Portal
    2. Navigate to: APIM instance -> Developer Portal -> Identities -> Delete "Username and password"
    3. Simply disabling signup in UI is NOT sufficient
    4. Use Azure AD or other secure identity providers instead
  reference:
    - https://bountyy.fi/blog/azure-apim-cross-tenant-signup-bypass
    - https://github.com/bountyyfi/Azure-APIM-Cross-Tenant-Signup-Bypass
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:H/A:N
    cvss-score: 8.2
    cwe-id: CWE-284
  metadata:
    max-request: 1
    verified: true
    vendor: microsoft
    product: azure-api-management
    shodan-query: ssl.cert.subject.cn:"developer.azure-api.net" http.status:200
    fofa-query: cert.subject="developer.azure-api.net"
    google-dork: site:*.developer.azure-api.net inurl:signup
  tags: azure,apim,bypass,authentication,misconfiguration

http:
  - method: POST
    path:
      - "{{BaseURL}}/signup"

    headers:
      Content-Type: application/json
      Accept: "*/*"
      Origin: "{{BaseURL}}"
      Referer: "{{BaseURL}}/signup"

    body: '{"challenge":{"testCaptchaRequest":{"challengeId":"00000000-0000-0000-0000-000000000000","inputSolution":"AAAAAA"},"azureRegion":"NorthCentralUS","challengeType":"visual"},"signupData":{"email":"nuclei-probe@nonexistent.test","firstName":"Nuclei","lastName":"Probe","password":"NucleiProbe123!","confirmation":"signup","appType":"developerPortal"}}'

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 400

      - type: word
        part: body
        words:
          - "Captcha"
          - "captcha"
          - "challenge"
          - "ValidationError"
        condition: or

      - type: word
        part: header
        words:
          - "application/json"
