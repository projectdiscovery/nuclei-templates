id: azure-blob-service-logging-disabled
info:
  name: Azure Storage Blob Service Logging Not Enabled
  author: princechaddha
  severity: medium
  description: |
    Ensure that Azure Storage Blob service logging is enabled for read, write, and delete requests. The Storage Blob service provides scalable, cost-efficient objective storage in the Azure cloud. Storage logging is performed server-side and allows details for both successful and failed requests to be recorded in the associated storage account. These logs contain the following information about the individual requests: timing information such as start time, end-to-end latency, server latency, authentication details, concurrency information, and the size of the request/response.
  impact: |
    Not enabling logging for read, write, and delete operations on Azure Storage Blob can prevent tracking of data access and manipulation, thus reducing the ability to diagnose issues or detect breaches.
  remediation: |
    Enable logging for the Azure Storage Blob service by setting the 'read', 'write', and 'delete' attributes to true in the storage account settings.
  reference:
    - https://docs.microsoft.com/en-us/azure/storage/common/storage-analytics-logging
  tags: cloud,devops,azure,microsoft,azure-storage,azure-cloud-config

flow: |
  code(1);
  for (let AccountData of iterate(template.accountList)) {
    AccountData = JSON.parse(AccountData);
    set("name", AccountData.name);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az storage account list --query '[*].{"name":name}'

    extractors:
      - type: json
        name: accountList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az storage logging show --services b --account-name "$name" --output json

    matchers-condition: and
    matchers:
      - type: word
        words:
          - '"delete": false'
          - '"read": false'
          - '"write": false'
        condition: and

    extractors:
      - type: dsl
        dsl:
          - 'name + " has logging disabled for read, write, and delete operations."'

# digest: 490a0046304402202a10c7074deb35860e12d1eae5705a7a38a90d2bac8b107dfa0fc0847d10ad4e02202291f8836a25a7016d06d6e64aabda0fbad5aa4a6db2e0ed86e623bc49ff2b77:922c64590222798bb761d5b6d8e72950