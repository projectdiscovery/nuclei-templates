id: CVE-2019-6443

info:
  name: NTPsec 1.1.2 - 'ctl_getitem' Out-of-Bounds Read
  author: 0x_Akoko
  severity: critical
  description: |
    NTPsec before 1.1.3 contains a stack-based buffer over-read caused by a bug in ctl_getitem in read_sysvars in ntp_control.c in ntpd, letting local or remote attackers read sensitive memory, exploit requires sending crafted control requests.
  impact: |
    Attackers can read sensitive memory contents, potentially leading to information disclosure or further exploitation.
  remediation: |
    Update to version 1.1.3 or later.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2019-6443
    - https://www.exploit-db.com/exploits/46175
    - https://gitlab.com/NTPsec/ntpsec/-/issues/627
    - https://github.com/ntpsec/ntpsec/blob/NTPsec_1_1_3/NEWS
    - https://github.com/ARPSyndicate/cvemon
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H
    cvss-score: 9.1
    cve-id: CVE-2019-6443
    cwe-id: CWE-125
    epss-score: 0.1058
    epss-percentile: 0.92914
    cpe: cpe:2.3:a:ntpsec:ntpsec:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    vendor: ntpsec
    product: ntpsec
    shodan-query: "ntpsec"
  tags: cve,cve2019,ntp,ntpsec,udp,passive

variables:
  HOST: "{{Host}}"
  PORT: "123"

code:
  - engine:
      - py
      - python3
    source: |
      import socket, struct, re, os

      host = os.getenv("HOST") or "{{Host}}"
      port = int(os.getenv("PORT") or 123)
      timeout = 3.0

      vulnerable_versions = ["1.1.0", "1.1.1", "1.1.2"]

      def build_mode6_packet():
          # NTP mode 6 control message (readvar)
          li_vn_mode = 0x16  # LI=0, VN=2, Mode=6
          op = 0x02          # Read variables
          seq, status, assoc, offset, count = 1000, 0, 0, 0, 0
          return struct.pack("!BBHHHHH", li_vn_mode, op, seq, status, assoc, offset, count)

      def send_ntp_request(target, port, timeout=3.0):
          sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
          sock.settimeout(timeout)
          pkt = build_mode6_packet()
          try:
              sock.sendto(pkt, (target, port))
              data, _ = sock.recvfrom(1024)
              sock.close()
              return data
          except Exception:
              return None

      def parse_response(resp):
          if not resp:
              return None
          s = resp.decode(errors="ignore")
          m = re.search(r"ntpsec[-_ ]?(\d+\.\d+\.\d+)", s, re.I)
          return m.group(1) if m else None

      def check_vuln(version):
          if not version:
              return "No version detected"
          if version in vulnerable_versions:
              return f"Vulnerable (ntpsec {version})"
          return f"Not vulnerable (ntpsec {version})"

      resp = send_ntp_request(host, port, timeout)
      version = parse_response(resp)
      status = check_vuln(version)
      print(status)

    matchers:
      - type: word
        words:
          - "Vulnerable"

    extractors:
      - type: regex
        name: ntpsec-version
        regex:
          - "(?i)ntpsec[\\s\\-_]*(\\d+\\.\\d+\\.\\d+)"
# digest: 4a0a004730450221008cab3682a075639c41540f1f2cedec63c3e5997605f64faa0cd3b55f087f551b0220344cf6f522067cc97f6ca6e855cb4b5264236bbeb6d29e799cb4fb0fc896fd93:bd4199f08311fe94da3c6b619521b96e
