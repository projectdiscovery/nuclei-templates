# CVE-2021-23394 - Vulnerable elFinder 2.1.57 Environment
# 
# This Dockerfile creates a vulnerable PHP environment with elFinder 2.1.57
# configured to parse .phar files as PHP (default Apache behavior).
#
# Build: docker build -t elfinder-vuln .
# Run:   docker run -p 8080:80 elfinder-vuln
#
# Author: princechaddha
# CVE: CVE-2021-23394

FROM php:7.4-apache

LABEL maintainer="princechaddha"
LABEL description="Vulnerable elFinder 2.1.57 for CVE-2021-23394 testing"
LABEL cve="CVE-2021-23394"

# Install dependencies
RUN apt-get update && apt-get install -y \
    unzip \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Enable PHP extensions
RUN docker-php-ext-install fileinfo

# Configure PHP to execute .phar files
RUN echo "AddHandler application/x-httpd-php .phar" >> /etc/apache2/conf-available/phar.conf \
    && a2enconf phar

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Download vulnerable elFinder 2.1.57
WORKDIR /var/www/html

RUN wget -q https://github.com/Studio-42/elFinder/archive/refs/tags/2.1.57.zip -O elfinder.zip \
    && unzip -q elfinder.zip \
    && mv elFinder-2.1.57 elFinder \
    && rm elfinder.zip

# Also create lowercase version for path variations
RUN ln -s /var/www/html/elFinder /var/www/html/elfinder

# Create files directory with write permissions
RUN mkdir -p /var/www/html/elFinder/files \
    && chmod 777 /var/www/html/elFinder/files

# Copy connector configuration (allow uploads)
RUN cp /var/www/html/elFinder/php/connector.minimal.php-dist \
       /var/www/html/elFinder/php/connector.minimal.php

# Configure elFinder to use local files directory
RUN sed -i "s|'path'.*=>.*dirname.*|'path' => '/var/www/html/elFinder/files/',|g" \
    /var/www/html/elFinder/php/connector.minimal.php \
    && sed -i "s|'URL'.*=>.*dirname.*|'URL' => '/elFinder/files/',|g" \
    /var/www/html/elFinder/php/connector.minimal.php

# Set proper permissions
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html \
    && chmod 777 /var/www/html/elFinder/files

# Create simple index page
RUN echo '<html><head><title>elFinder 2.1.57 - Vulnerable</title></head>' > /var/www/html/index.html \
    && echo '<body><h1>elFinder 2.1.57 (CVE-2021-23394 Vulnerable)</h1>' >> /var/www/html/index.html \
    && echo '<p><a href="/elFinder/elfinder.html">Open elFinder</a></p>' >> /var/www/html/index.html \
    && echo '<p>Version: 2.1.57 (vulnerable to .phar upload RCE)</p>' >> /var/www/html/index.html \
    && echo '</body></html>' >> /var/www/html/index.html

# Expose port 80
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=3s \
    CMD curl -f http://localhost/elFinder/php/connector.minimal.php?cmd=info || exit 1

# Start Apache
CMD ["apache2-foreground"]
